/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Delayable as C,Events as T,Localizable as H,Base as S,DomHelper as f,BrowserHelper as v,TemplateHelper as $,IdHelper as L,DomSync as I}from"./Editor.js";const E={all:"all",visible:"visible"},A={A6:{width:4.11,height:5.81},A5:{width:5.81,height:8.25},A4:{width:8.25,height:11.69},A3:{width:11.69,height:16.49},Legal:{width:8.5,height:14},Letter:{width:8.5,height:11}},B={portrait:"portrait",landscape:"landscape"},P={pdf:"pdf",png:"png"},V={pdf:"application/pdf",png:"image/png"};class x extends C(T(H(S))){static get defaultConfig(){return{translateURLsToAbsolute:!0,keepPathName:!0,filterStyles:e=>e}}pageTpl(e){const{title:t,header:r,footer:s,styles:o,htmlClasses:i,bodyStyle:d,bodyClasses:l=[],paperHeight:n,paperWidth:c,html:h}=e;return l.push(`b-${this.constructor.type}`),f.scrollBarWidth?l.push("b-visible-scrollbar"):l.push("b-overlay-scrollbar"),v.isChrome?l.push("b-chrome"):v.isSafari?l.push("b-safari"):v.isFirefox&&l.push("b-firefox"),$.tpl`
            <!DOCTYPE html>
            <html class="${i}" style="width: ${c}in; height: ${n}in;">
                <head>
                    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
                    <title>${t}</title>
                    ${o.join("")}
                </head>
                <body class="b-export ${l.join(" ")}" style="width: ${c}in; height: ${n}in; ${d}">
                    <div class="b-export-content">
                        ${r&&`<div class="b-export-header" style="width: 100%">${r}</div>`}
                        <div class="b-export-body"><div class="b-export-viewport">${h}</div></div>
                        ${s&&`<div class="b-export-footer" style="width: 100%">${s}</div>`}
                    </div>
                </body>
            </html>`}get stylesheets(){const e=this;if(e._stylesheets)return e._stylesheets;const t=e.translateURLsToAbsolute,r=globalThis.origin,s=Array.from(document.querySelectorAll('link[rel="stylesheet"], style')),o=[];return s.forEach(i=>{if(i=i.cloneNode(!0),t&&i.href){let l;t===!0?l=i.href:this.keepPathName?l=i.href.replace(r,t):l=new URL(i.getAttribute("href"),t),i.setAttribute("href",l)}let d=i.outerHTML;if(t&&/style/i.test(i.tagName)){const l=e.getStyleTagURLConverter(t);d=d.replace(/url\(['"]?(.+?)['"]?\)/g,l)}o.push(d)}),o.push(`<style>
                body, html {
                    overflow: auto;
                }
                body {
                    position: relative;
                    margin: 0;
                }
            </style>`),e._stylesheets=e.filterStyles(o)}set stylesheets(e){this._stylesheets=e&&this.filterStyles(e)}getStyleTagURLConverter(e){return function(t,r){let s;try{let o;/^#/.test(r)?s=t:(e===!0?o=globalThis.location.href:this.keepPathName?o=globalThis.location.href.replace(globalThis.location.origin,e):o=e,s=`url('${new URL(r,o).href}')`)}catch(o){s=t}return s}.bind(this)}saveState({client:e}){this.state=e.state}async restoreState({client:e}){const t=[],r=new Set;r.add(e.scrollable.ion({scroll(){t.push(e.scrollable.await("scrollEnd"))}})),e.eachSubGrid(({header:s,scrollable:o})=>{r.add(o.ion({scroll(){t.push(o.await("scrollEnd"))}})),r.add(s.scrollable.ion({scroll(){t.push(s.scrollable.await("scrollEnd"))}}))}),e.state=this.state,await Promise.all(t),r.forEach(s=>s())}beforeExport(){this.element=document.createElement("div")}cloneElement(e,t=this.element,r=!0){r&&(t.innerHTML=""),t.appendChild(e.cloneNode(!0)),f.removeEachSelector(t,".b-grid-row,.b-grid-merged-cells-container");const s=t.querySelector(".b-gridbase > .b-mask");s&&s.remove()}createPlaceholder(e,t=!0,r={}){return t&&(e.innerHTML=""),f.createElement(Object.assign({parent:e,id:L.generateId("export")},r))}prepareElement({client:e}){const{tbar:t,bbar:r}=e;t&&this.element.querySelector(`#${t.id}`).remove(),r&&this.element.querySelector(`#${r.id}`).remove()}measureElement(e=""){e instanceof HTMLElement&&(e=e.outerHTML);const t=f.createElement({parent:document.body,style:{visibility:"hidden",position:"absolute"},html:`<div style="height: 1px"></div>${e}<div style="height: 1px"></div>`}),r=t.offsetHeight-2;return t.remove(),r}prepareHTML(e){e instanceof HTMLElement&&(e=e.outerHTML);const t=f.createElement({parent:document.body,style:{visibility:"hidden",position:"absolute"},html:e}),r=t.querySelectorAll("img");for(let o=0,i=r.length;o<i;o++)r[o].setAttribute("src",r[o].src);const s=t.innerHTML;return t.remove(),s}getVirtualScrollerHeight(e){let t=0;return e.eachSubGrid(r=>{r.overflowingHorizontally&&(t=f.scrollBarWidth)}),t===0?t:t+1}inchToPx(e){return e*96}getScaleValue(e,t){return Math.floor(e*1e4/t)/1e4}getVisibleRowsCount(e){const t=e.rowManager,r=t.rows.indexOf(t.firstVisibleRow),s=t.rows.indexOf(t.lastVisibleRow);let o;return r!==-1?s===-1?o=e.store.count-r:o=s-r+1:o=e.store.count,o}async export(e){const t=this;let r;t.beforeExport(),t.saveState(e),await t.prepareComponent(e);try{r=await t.getPages(e)}finally{await t.restoreComponent(e),t.stylesheets=null,await new Promise(s=>t.requestAnimationFrame(s)),await t.restoreState(e)}return r}async getPages(e){const t=this.pagesExtractor(e),r=[];let s;for(;(s=await t.next())&&!s.done;)r.push(s.value);return r}adjustRowBuffer(e){const{contentHeight:t}=this.exportMeta,{rowManager:r}=e;this.oldRowManagerConfig={prependRowBuffer:r.prependRowBuffer,appendRowBuffer:r.appendRowBuffer};const s=Math.ceil(t/r.rowOffsetHeight);r.prependRowBuffer=s,r.appendRowBuffer=s,e.renderRows(),e.rowManager.jumpToPosition(e.scrollable.y)}restoreRowBuffer(e){e.rowManager.prependRowBuffer=this.oldRowManagerConfig.prependRowBuffer,e.rowManager.appendRowBuffer=this.oldRowManagerConfig.appendRowBuffer}async prepareComponent(e){const t=this,{client:r,columns:s,rowsRange:o,keepRegionSizes:i,enableDirectRendering:d}=e,{rowManager:l}=r,n=t.exportMeta={enableDirectRendering:d,totalWidth:0,totalHeight:0-(d?0:t.getVirtualScrollerHeight(r)),subGrids:{}};r.columns.forEach(a=>{s.includes(a.id)?a.show():a.hide()}),await new Promise(a=>r.requestAnimationFrame(a)),r.rowManager.rowCount>0&&(o===E.all?n.firstVisibleDataIndex=l.rows[0].dataIndex:(n.firstVisibleDataIndex=l.firstVisibleRow.dataIndex,e.alignRows=!0),d||await r.scrollRowIntoView(r.store.getAt(n.firstVisibleDataIndex),{block:"start"}));const{element:c}=t;t.cloneElement(r.element),t.prepareElement(e);let h;d&&(n.fakeRow=h=r.rowManager.rowClass.new({cls:r.rowCls,rowManager:r.rowManager,grid:r,index:-10,dataIndex:-10})),r.eachSubGrid(a=>{var u,p,w;h&&(a.onAddRow({rows:[h],isExport:!0}),h.element.dataset.ownerCmp=r.id);const g=t.createPlaceholder(c.querySelector(`[id="${a.id}"]`),!1);let m;i!=null&&i[a.region]?m=a.element.offsetWidth:m=a.columns.visibleColumns.reduce((y,b)=>(typeof b.width=="number"?y+=b.width:y+=(r.hideHeaders?r.rowManager.rows[0].getCell(b.id):b.element).offsetWidth,y),0),n.totalWidth+=m;const M=((u=a.splitterElement)===null||u===void 0?void 0:u.offsetWidth)||0;n.totalWidth+=M,n.subGrids[a.region]={id:a.id,headerId:((p=a.header)===null||p===void 0?void 0:p.id)||null,footerId:((w=a.footer)===null||w===void 0?void 0:w.id)||null,rows:[],splitterWidth:M,placeHolder:g,width:m}})}prepareExportElement(){const e=this,{element:t,exportMeta:r}=e;return Object.values(r.subGrids).forEach(({width:s,id:o,headerId:i,footerId:d})=>{[o,i,d].forEach(l=>{if(l){const n=t.querySelector(`[id="${l}"]`);n&&(n.style.width=`${s}px`,n.style.flex="")}})}),t.innerHTML}async restoreComponent(e){this.exportMeta.fakeRow&&(this.exportMeta.fakeRow.destroy(),delete this.exportMeta.fakeRow)}async scrollRowIntoView(e,t){await e.scrollRowIntoView(e.store.getAt(t),{block:"start"}),await new Promise(r=>this.requestAnimationFrame(r))}collectRow(e){const t=this.exportMeta.subGrids,r=/data-owner-cmp=".+?"/;Object.entries(e.elements).forEach(([s,o])=>{t[s].rows.push([o.outerHTML.replace(r,""),e.top,e.offsetHeight,new Map])})}renderMergedCells(e,t,r,s){const o=this,{client:i}=e,{subGrids:d}=o.exportMeta,l=i.features.mergeCells.buildMergedCellsConfig(t,r,s);for(const n in d){const c=d[n],h=document.createElement("div");I.sync({targetElement:h,domConfig:{children:l[n].children}}),h.childNodes.length&&(h.childNodes.forEach(a=>{const{syncId:u}=a.dataset,p=i.features.mergeCells.mergedRanges.find(w=>{var g;return((g=w.cellElement)===null||g===void 0?void 0:g.parentNode.dataset.syncId)===u});p&&(a.innerHTML=p.cellElement.outerHTML)}),c.mergedCellsHtml=[h.innerHTML])}}}x.prototype.pagesExtractor=async function*(){throw new Error("Implement this method in a subclass")},x._$name="Exporter";export{x as Exporter,P as FileFormat,V as FileMIMEType,B as Orientation,A as PaperFormat,E as RowsRange};
//# sourceMappingURL=Exporter.js.map
