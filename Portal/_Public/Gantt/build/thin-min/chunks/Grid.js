/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var R=Object.defineProperty;var v=(h,l,e)=>l in h?R(h,l,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[l]=e;var g=(h,l,e)=>(v(h,typeof l!="symbol"?l+"":l,e),e);import{GridFeatureManager as m,CopyPasteBase as S,Location as T,GridBase as $}from"./GridBase.js";import{Delayable as O,InstancePlugin as P}from"./Editor.js";const C="store";class f extends O(P){static get pluginConfig(){return{after:{bindStore:"bindStore",unbindStore:"unbindStore",renderRows:"syncAutoWidthColumns",onInternalResize:"onInternalResize"},assign:["columnAutoWidthPending","syncAutoWidthColumns"]}}construct(l){super.construct(l);const{store:e}=this.client;e&&this.bindStore(e)}doDestroy(){this.unbindStore(),super.doDestroy()}bindStore(l){this.lastSync=null,l.ion({name:C,[`change${this.client.asyncEventSuffix}`]:"onStoreChange",thisObj:this})}unbindStore(){this.detachListeners(C)}get columnAutoWidthPending(){return this.lastSync===null||this.hasTimeout("syncAutoWidthColumns")}onStoreChange({action:l}){if(l!=="move"){const e=this,{cellEdit:t}=e.client.features;++e.storeGeneration,t!=null&&t.isEditing&&!t.editingStoppedByTapOutside?e.syncAutoWidthColumns():e.hasTimeout("syncAutoWidthColumns")||e.setTimeout("syncAutoWidthColumns",e.delay)}}onInternalResize(l,e,t,i){i===0&&(this.lastSync=null,this.syncAutoWidthColumns())}syncAutoWidthColumns(){const l=this,{client:e,storeGeneration:t}=l;if(!e.splitFrom){if(l.lastSync!==t){l.lastSync=t;let i,r;for(const s of e.columns.visibleColumns)i=s.autoWidth,i&&(i===!0&&(i=l.default),e.resizingColumns=r=!0,s.resizeToFitContent(i));r&&(e.resizingColumns=!1,e.afterColumnsResized())}l.hasTimeout("syncAutoWidthColumns")&&l.clearTimeout("syncAutoWidthColumns")}}}g(f,"$name","ColumnAutoWidth"),g(f,"configurable",{default:null,delay:0}),f.prototype.storeGeneration=0,f._$name="ColumnAutoWidth",m.registerFeature(f,!0);class d extends S{constructor(){super(...arguments);g(this,"entityName","row")}construct(e,t){super.construct(e,t),e.rowManager.ion({beforeRenderRow:"onBeforeRenderRow",thisObj:this}),this.grid=e}onBeforeRenderRow({row:e,record:t}){var i;e.cls["b-cut-row"]=this.isCut&&((i=this.cutData)===null||i===void 0?void 0:i.includes(t))}isActionAvailable({key:e,action:t,event:i}){var r;const{grid:s}=this,{cellEdit:n}=s.features,{target:o}=i;return!this.disabled&&globalThis.getSelection().toString().length===0&&(!n||!n.isEditing)&&(t==="copy"||!this.copyOnly)&&((r=s.selectedRecords)===null||r===void 0?void 0:r.length)>0&&(!o||!!o.closest(".b-gridbase:not(.b-schedulerbase) .b-grid-subgrid,.b-grid-subgrid:not(.b-timeaxissubgrid)"))}async copy(){await this.copyRows()}async cut(){await this.copyRows(!0)}paste(e){return this.pasteRows(e!=null&&e.isModel?e:null)}async copyRows(e=!1){const{client:t,entityName:i}=this,r=this.selectedRecords.filter(s=>!s.readOnly||!e);!r.length||t.readOnly||(await this.writeToClipboard(r,e),t.trigger("copy",{records:r,isCut:e,entityName:i}))}setIsCut(e,t){var i;(i=this.grid.rowManager.getRowById(e))===null||i===void 0||i.toggleCls("b-cut-row",t),e.meta.isCut=t}handleCutData({source:e}){var t;e!==this&&(t=this.cutData)!==null&&t!==void 0&&t.length&&this.grid.store.remove(this.cutData)}stringConverter(e){return this.cellsToString(e.flatMap(t=>{var i;return(i=this.grid.rowManager.getRowById(t))===null||i===void 0?void 0:i.cells.map(r=>new T(r))}))}async beforeCopy({data:e,isCut:t}){return await this.client.trigger("beforeCopy",{records:e,isCut:t,entityName:this.entityName})}async pasteRows(e){var t,i,r;const s=this,{client:n,isCut:o,entityName:c}=s,a=e||n.selectedRecord;if(n.readOnly||n.isTreeGrouped)return[];const u=await s.readFromClipboard({referenceRecord:a},!0),w=s.clipboardData===u;if(!Array.isArray(u)||!(u!=null&&u.length)||n.store.tree&&o&&u.some(x=>x.contains(a,!0)))return[];s.sortByIndex(u);const b={},p=s.extractParents(u,b,w);if(await s.insertCopiedRecords(p,a),!n.isDestroying)return o?await s.clearClipboard():n.selectedRecords=p,n.trigger("paste",{records:p,originalRecords:u,referenceRecord:a,isCut:o,entityName:c}),s.clipboard.triggerPaste(s),(t=n.getRowFor(p[p.length-1]))===null||t===void 0||(i=t.cells)===null||i===void 0||(r=i[0])===null||r===void 0||r.focus(),p}async beforePaste({referenceRecord:e,data:t,text:i,isCut:r}){const s=t!==i?t:[];return await this.client.trigger("beforePaste",{records:s,referenceRecord:e,isCut:r,entityName:this.entityName,data:t})}stringParser(e){return this.setFromStringData(e,!0).modifiedRecords}generateNewName(e){const t=e.getValue(this.nameField);let i=2;for(;this.client.store.findRecord(this.nameField,`${t} - ${i}`);)i++;return`${t} - ${i}`}insertCopiedRecords(e,t){const{store:i}=this.client,r=i.indexOf(t)+1;return i.tree?t.parent.insertChild(e,t.nextSibling,!1,{orderedBeforeNode:t.nextOrderedSibling}):i.insert(r,e)}get selectedRecords(){const e=[...this.client.selectedRecords];return this.client.selectedCells.forEach(t=>{e.includes(t.record)||e.push(t.record)}),e}getMenuItemText(e,t=!1){const i=this;let r=i[e+"RecordText"];return t&&(r+=` (${i.selectedRecords.length>1?i.rowSpecifierTextPlural:i.rowSpecifierText})`),r}populateCellMenu({record:e,items:t,cellSelector:i}){var r;const s=this,{client:n,rowOptionsOnCellContextMenu:o}=s,c=((r=n.features.cellCopyPaste)===null||r===void 0?void 0:r.enabled)===!0,a=c&&n.isCellSelected(i);!n.readOnly&&!n.isTreeGrouped&&(e==null?void 0:e.isSpecialRow)===!1&&(c?n.selectedRows.length:n.selectedRecords.length)&&(!a||s.rowOptionsOnCellContextMenu)&&(s.copyOnly||(t.cut={text:s.getMenuItemText("cut",a&&o),localeClass:s,icon:"b-icon b-icon-cut",weight:135,disabled:e.readOnly,onItem:()=>s.cut()},t.paste={text:s.getMenuItemText("paste",a&&o),localeClass:s,icon:"b-icon b-icon-paste",weight:140,onItem:()=>s.paste(e),disabled:s.hasClipboardData()===!1}),t.copy={text:s.getMenuItemText("copy",a&&o),localeClass:s,cls:"b-separator",icon:"b-icon b-icon-copy",weight:120,onItem:()=>s.copy()})}sortByIndex(e){const{store:t}=this.client;return e.sort((i,r)=>{const s=i.indexPath,n=r.indexPath;if(!e.includes(i.parent)&&!e.includes(r.parent))return t.indexOf(i)-t.indexOf(r);if(s.length===n.length){for(let o=0;o<s.length;o++){if(s[o]<n[o])return-1;if(s[o]>n[o])return 1}return 0}else return s.length-n.length})}extractParents(e,t,i=!0){const r=this,{store:s}=r.client;s.tree&&e.forEach(o=>{o.traverse(c=>{const a=c.getTopParent(!0);!e.includes(c)&&(!r.isCut||!e.some(u=>a.includes(u)))&&e.push(c)})});const n=e.reduce((o,c)=>{let a;const u=c.parentId||c.meta.modified;return r.isCut?(a=c,a.meta.isCut=!1):(a=c.copy(),i&&(a[r.nameField]=r.generateNewName(a)),a.data.expanded=c.isExpanded(r.client.store)),t[c.id]=a,c.parent===s.rootNode?o.push(a):u in t?t[u].appendChild(a,!0):o.push(a),o},[]);return n.forEach(o=>{o.sortOrderedChildren(!0,!0)}),n}}g(d,"$name","RowCopyPaste"),g(d,"type","rowCopyPaste"),g(d,"pluginConfig",{assign:["copyRows","pasteRows"],chain:["populateCellMenu"]}),g(d,"configurable",{nameField:"name",keyMap:{"Ctrl+C":{weight:10,handler:"copy"},"Ctrl+X":{weight:10,handler:"cut"},"Ctrl+V":{weight:10,handler:"paste"}},copyRecordText:"L{copyRecord}",cutRecordText:"L{cutRecord}",pasteRecordText:"L{pasteRecord}",rowSpecifierText:"L{row}",rowSpecifierTextPlural:"L{rows}",localizableProperties:["copyRecordText","cutRecordText","pasteRecordText","rowSpecifierText","rowSpecifierTextPlural"],rowOptionsOnCellContextMenu:!1}),d.featureClass="b-row-copypaste",d._$name="RowCopyPaste",m.registerFeature(d,!0,"Grid"),m.registerFeature(d,!1,"Gantt"),m.registerFeature(d,!1,"SchedulerPro"),m.registerFeature(d,!1,"ResourceHistogram");class y extends ${static get $name(){return"Grid"}static get type(){return"grid"}}y.initClass(),y._$name="Grid";export{f as ColumnAutoWidth,y as Grid,d as RowCopyPaste};
//# sourceMappingURL=Grid.js.map
