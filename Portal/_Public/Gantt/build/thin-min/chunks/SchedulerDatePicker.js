/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Localizable as A,DateHelper as v,InstancePlugin as z,ObjectHelper as D,Objects as H,Config as N,Popup as B,Store as W,Button as q,Base as K,Widget as C,Combo as U,DomHelper as b,Delayable as Y,AsyncHelper as G,List as Q,StringHelper as J,ArrayHelper as X,VersionHelper as x}from"./Editor.js";import{DateField as Z,DatePicker as ee}from"./MessageDialog.js";import{GridFeatureManager as j}from"./GridBase.js";import"./AvatarRendering.js";import{RecurrenceFrequencyCombo as te,TaskEditStm as re}from"./ScheduleMenu.js";import{RecurrenceDayRuleEncoder as S,TimeSpan as ie}from"./CrudManagerView.js";class F extends A(){static get $name(){return"RecurrenceLegend"}static get allDaysValueAsArray(){return["SU","MO","TU","WE","TH","FR","SA"]}static get allDaysValue(){return this.allDaysValueAsArray.join(",")}static get workingDaysValue(){return this.allDaysValueAsArray.filter((e,t)=>!v.nonWorkingDays[t]).join(",")}static get nonWorkingDaysValue(){return this.allDaysValueAsArray.filter((e,t)=>v.nonWorkingDays[t]).join(",")}static getLegend(e,t){const r=this,{timeSpan:i,interval:s,days:n,monthDays:a,months:o,positions:d}=e,h=t||i.startDate,l={interval:s};let f;switch(e.frequency){case"DAILY":return s===1?r.L("L{Daily}"):r.L("L{Every {0} days}",l);case"WEEKLY":return n&&n.length?l.days=r.getDaysLegend(n):h&&(l.days=v.getDayName(h.getDay())),r.L(s===1?"L{Weekly on {1}}":"L{Every {0} weeks on {1}}",l);case"MONTHLY":return n&&n.length&&d&&d.length?l.days=r.getDaysLegend(n,d):a&&a.length?(a.sort((c,g)=>c-g),l.days=r.arrayToText(a)):h&&(l.days=h.getDate()),r.L(s===1?"L{Monthly on {1}}":"L{Every {0} months on {1}}",l);case"YEARLY":return n&&n.length&&d&&d.length?l.days=r.getDaysLegend(n,d):l.days=h.getDate(),o&&o.length?(o.sort((c,g)=>c-g),o.length>2?f=c=>v.getMonthShortName(c-1):f=c=>v.getMonthName(c-1),l.months=r.arrayToText(o,f)):l.months=v.getMonthName(h.getMonth()),r.L(s===1?"L{Yearly on {1} of {2}}":"L{Every {0} years on {1} of {2}}",l)}}static getDaysLegend(e,t){const r=this,i={position:""};let s;if(t&&t.length&&(i.position=r.arrayToText(t,n=>r.L(`L{position${n}}`))),e.length)switch(e.sort((n,a)=>S.decodeDay(n)[0]-S.decodeDay(a)[0]),e.join(",")){case r.allDaysValue:i.days=r.L("L{day}");break;case r.workingDaysValue:i.days=r.L("L{weekday}");break;case r.nonWorkingDaysValue:i.days=r.L("L{weekend day}");break;default:e.length>2?s=n=>v.getDayShortName(S.decodeDay(n)[0]):s=n=>v.getDayName(S.decodeDay(n)[0]),i.days=r.arrayToText(e,s)}return r.L("L{daysFormat}",i)}static arrayToText(e,t){return t&&(e=e.map(t)),e.join(", ").replace(/,(?=[^,]*$)/,this.L("L{ and }"))}}F._$name="RecurrenceLegend";const m=v,ne=["startDate","endDate","resource","recurrenceRule"],V=u=>{if(u.length===1)return u[0].value;if(u.length===2){const[e,t]=u[0]instanceof Z?u:u.reverse(),r=m.parse(e.value);return r&&t.value&&r.setHours(t.value.getHours(),t.value.getMinutes(),t.value.getSeconds(),t.value.getMilliseconds()),r?v.clone(r):null}return null},se=(u,e)=>{const t=new Date(u.getTime());return t.setHours(e.getHours(),e.getMinutes()),t},L=(u,e,t)=>{if(u&&e&&t.endDateField&&t.endTimeField){const r=m.add(se(t.startDateField.value,t.startTimeField.value),t.eventRecord.durationMS,"milliseconds");t.endDateField.value=r,t.endTimeField.value=m.clone(r)}};class R extends z{static get configurable(){return{saveAndCloseOnEnter:!0,triggerEvent:null,dateFormat:"L",timeFormat:"LT",editorConfig:null,items:null,weekStartDay:null}}construct(e,t){const r=this;e.eventEdit=r,super.construct(e,D.assign({weekStartDay:e.weekStartDay},t)),r.clientListenersDetacher=e.ion({[r.triggerEvent]:"onActivateEditor",dragCreateEnd:"onDragCreateEnd",eventAutoCreated:"onEventAutoCreated",thisObj:r})}doDestroy(){var e;this.clientListenersDetacher(),(e=this._editor)===null||e===void 0||e.destroy(),super.doDestroy()}onEventAutoCreated(){}changeEditorConfig(e){const{items:t}=this;return t&&(e=H.clone(e),e.items=N.merge(t,e.items)),e}changeItems(e){return this.cleanItemsConfig(e),e}cleanItemsConfig(e){for(const t in e){const r=e[t];r===!0?delete e[t]:r!=null&&r.items&&this.cleanItemsConfig(r.items)}}onDatesChange(e){var t,r;const i=this,s=e.source,n=e.value;if(i.startDateField&&i.endDateField&&(i.endDateField.min=i.startDateField.value),i.endTimeField){var a,o;m.isEqual(m.clearTime((a=i.startDateField)===null||a===void 0?void 0:a.value),m.clearTime((o=i.endDateField)===null||o===void 0?void 0:o.value))?i.endTimeField.min=i.startTimeField.value:i.endTimeField.min=null}switch(s.ref){case"startDateField":!((t=i.startTimeField)===null||t===void 0)&&t.value&&L(n,i.startTimeField.value,i);break;case"startTimeField":!((r=i.startDateField)===null||r===void 0)&&r.value&&L(i.startDateField.value,n,i);break}}async save(){throw new Error("Implement in subclass")}get values(){const e=this,{editor:t}=e,r=[],i=[],{values:s}=t;return ne.forEach(n=>delete s[n]),t.eachWidget(n=>{var a;const{name:o}=n;if(!o||n.hidden||n.up(d=>d===e.recurrenceEditor)){delete s[o];return}switch(o){case"startDate":r.push(n);break;case"endDate":i.push(n);break;case"resource":s[o]=n.record;break;case"recurrenceRule":s[o]=((a=t.widgetMap.recurrenceCombo)===null||a===void 0?void 0:a.value)==="none"?"":n.value;break}},!0),s.allDay&&!e.eventRecord.allDay&&(r.push(e.startTimeField),i.push(e.endTimeField)),r.length&&(s.startDate=V(r)),i.length&&(s.endDate=V(i)),"startDate"in s&&"endDate"in s&&(s.duration=m.diff(s.startDate,s.endDate,e.editor.record.durationUnit,!0)),s}onBeforeSave(e){}onAfterSave(e){}updateRecord(e){const{values:t}=this;return this.assignmentStore&&delete t.resource,e.set(t)}onBeforeEditorShow(){const{eventRecord:e,editor:t}=this.editingContext,{nameField:r}=t.widgetMap;r&&e.isCreating&&(t.assigningValues=!0,r.value="",t.assigningValues=!1,r._configuredPlaceholder=r.placeholder,r.placeholder=e.name)}resetEditingContext(){const e=this;if(!e.editingContext)return;const{client:t}=e,{editor:r,eventRecord:i}=e.editingContext,{eventStore:s}=t,{nameField:n}=r.widgetMap;if(i.isCreating){if(t.isTimelineBase){var a;(a=e.editingContext.eventElement)===null||a===void 0||a.closest("[data-event-id]").classList.add("b-released")}s.remove(i),i.isCreating=!1}n&&(n.placeholder=n._configuredPlaceholder),t.element.classList.remove("b-eventeditor-editing"),e.targetEventElement=e.editingContext=r._record=null}onPopupKeyDown({event:e}){const t=this;!t.readOnly&&e.key==="Enter"&&t.saveAndCloseOnEnter&&e.target.tagName.toLowerCase()==="input"&&(e.preventDefault(),e.target.name==="startDate"&&t.startTimeField&&L(t.startDateField.value,t.startTimeField.value,t),t.onSaveClick())}async finalizeStmCapture(e){}async onSaveClick(){this.editor.focus(),this.isFinalizingEventSave=!0;const e=await this.save();return this.isFinalizingEventSave=!1,e&&(await this.finalizeStmCapture(!1),this.editor.close(),this.client.trigger("afterEventEdit")),e}async onDeleteClick(){this.isDeletingEvent=!0;const e=await this.deleteEvent();if(this.isDeletingEvent=!1,e){await this.finalizeStmCapture(!1);const{editor:t}=this;(!t.autoClose||t.containsFocus)&&t.close(),this.client.trigger("afterEventEdit")}}async onCancelClick(){this.isCancelingEdit=!0,this.editor.close(),this.isCancelingEdit=!1,this.hasStmCapture&&await this.finalizeStmCapture(!0),this.client.trigger("afterEventEdit")}}R._$name="EditBase";class w extends B{static get type(){return"eventeditor"}static get $name(){return"EventEditor"}static get configurable(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible",scrollable:{overflowY:!0},readOnly:null,titleRenderer:null,maximizeOnMobile:!0}}updateLocalization(){super.updateLocalization(...arguments),this.initialTitle=this.title||""}chainResourceStore(){return this.eventEditFeature.resourceStore.chain(e=>!e.isSpecialRow,null,{storeClass:W,excludeCollapsedRecords:!1})}processWidgetConfig(e){var t;if((t=e.type)!==null&&t!==void 0&&t.includes("date")&&e.weekStartDay==null&&(e.weekStartDay=this.weekStartDay),e.type==="extraItems")return!1;const{eventEditFeature:r}=this,i={};if(e.ref==="resourceField"){const{store:s}=e;e.store=this.chainResourceStore(),s&&e.store.setConfig(s),"multiSelect"in e||(e.multiSelect=!r.eventStore.usesSingleAssignment)}return(e.name==="startDate"||e.name==="endDate")&&e.type==="date"&&(i.format=r.dateFormat),(e.name==="startDate"||e.name==="endDate")&&e.type==="time"&&(i.format=r.timeFormat),Object.assign(e,i),super.processWidgetConfig(e)}setupEditorButtons(){const{record:e}=this,{deleteButton:t}=this.widgetMap;t&&(t.hidden=this.readOnly||e.isCreating)}onBeforeShow(...e){var t;const r=this,{record:i,titleRenderer:s}=r;r.setupEditorButtons(),s?r.title=r.callback(s,r,[i]):r.title=r.initialTitle,(t=super.onBeforeShow)===null||t===void 0||t.call(this,...e)}onInternalKeyDown(e){this.trigger("keyDown",{event:e}),super.onInternalKeyDown(e)}updateReadOnly(e){const{deleteButton:t,saveButton:r,cancelButton:i}=this.widgetMap;super.updateReadOnly(e),t&&(t.hidden=e),r&&(r.hidden=e),i&&(i.hidden=e)}}w.initClass(),w._$name="EventEditor";class T extends te{static get $name(){return"RecurrenceCombo"}static get type(){return"recurrencecombo"}static get defaultConfig(){return{customValue:"custom",placeholder:"None",splitCls:"b-recurrencecombo-split",items:!0,highlightExternalChange:!1}}buildItems(){const e=this;return[{value:"none",text:"L{None}"},...super.buildItems(),{value:e.customValue,text:"L{Custom}",cls:e.splitCls}]}set value(e){e=e||"none",super.value=e}get value(){return super.value}set recurrence(e){const t=this;e?t.value=t.isCustomRecurrence(e)?t.customValue:e.frequency:t.value=null}isCustomRecurrence(e){const{interval:t,days:r,monthDays:i,months:s}=e;return!!(t>1||r&&r.length||i&&i.length||s&&s.length)}}T.initClass(),T._$name="RecurrenceCombo";class k extends q{static get $name(){return"RecurrenceLegendButton"}static get type(){return"recurrencelegendbutton"}static get defaultConfig(){return{localizableProperties:[],recurrence:null}}set recurrence(e){this._recurrence=e,this.updateLegend()}get recurrence(){return this._recurrence}set eventStartDate(e){this._eventStartDate=e,this.updateLegend()}get eventStartDate(){return this._eventStartDate}updateLegend(){const{recurrence:e}=this;this.text=e?F.getLegend(e,this.eventStartDate):""}onLocaleChange(){this.updateLegend()}updateLocalization(){this.onLocaleChange(),super.updateLocalization()}}k.initClass(),k._$name="RecurrenceLegendButton";class $ extends B{static get $name(){return"RecurrenceEditor"}static get type(){return"recurrenceeditor"}static get configurable(){return{draggable:!0,closable:!0,floating:!0,cls:"b-recurrenceeditor",title:"L{Repeat event}",autoClose:!0,width:470,items:{recurrenceEditorPanel:{type:"recurrenceeditorpanel",title:null}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler",weight:100},saveButton:{color:"b-green",text:"L{Save}",onClick:"up.onSaveClick",weight:200},cancelButton:{color:"b-gray",text:"L{Object.Cancel}",onClick:"up.onCancelClick",weight:300}}},scrollable:{overflowY:!0}}}updateReadOnly(e){super.updateReadOnly(e),this.bbar.hidden=e}get recurrenceEditorPanel(){return this.widgetMap.recurrenceEditorPanel}updateRecord(e){this.recurrenceEditorPanel.record=e}onSaveClick(){const e=this;e.saveHandler?e.saveHandler.call(e.thisObj||e,e,e.record):(e.recurrenceEditorPanel.syncEventRecord(),e.close())}onCancelClick(){const e=this;e.cancelHandler?e.cancelHandler.call(e.thisObj||e,e,e.record):e.close()}}$.initClass(),$._$name="RecurrenceEditor";var I=u=>class extends(u||K){static get $name(){return"RecurringEventEdit"}static get configurable(){return{recurringEventsItems:{recurrenceCombo:{type:"recurrencecombo",label:"L{EventEdit.Repeat}",ref:"recurrenceCombo",weight:700},editRecurrenceButton:{type:"recurrencelegendbutton",ref:"editRecurrenceButton",name:"recurrenceRule",color:"b-gray",menuIcon:null,flex:1,weight:800,ignoreParentReadOnly:!0}},showRecurringUI:null}}changeEditorConfig(t){return t.items={...t.items,...this.recurringEventsItems},t=super.changeEditorConfig(t),t}doDestroy(){var t,r;(t=this._recurrenceConfirmation)===null||t===void 0||t.destroy(),(r=this._recurrenceEditor)===null||r===void 0||r.destroy(),super.doDestroy()}onEditorConstructed(t){var r;const i=this;t.ion({hide:i.onRecurringEventEditorHide,thisObj:i}),i.editRecurrenceButton&&(i.editRecurrenceButton.menu=i.recurrenceEditor),(r=i.recurrenceCombo)===null||r===void 0||r.ion({change:i.onRecurrenceComboChange,thisObj:i})}updateReadOnly(t){this._recurrenceEditor&&(this._recurrenceEditor.readOnly=t)}internalShowEditor(){this.toggleRecurringFieldsVisibility(this.client.enableRecurringEvents&&this.showRecurringUI!==!1)}toggleRecurringFieldsVisibility(t=!0){var r,i,s,n;const a=t?"show":"hide";(r=this.editRecurrenceButton)===null||r===void 0||(i=r[a])===null||i===void 0||i.call(r),(s=this.recurrenceCombo)===null||s===void 0||(n=s[a])===null||n===void 0||n.call(s)}onRecurringEventEditorHide(){var t,r;(t=this.recurrenceEditor)!==null&&t!==void 0&&t.isVisible&&this.recurrenceEditor.hide(),(r=this.recurrenceConfirmation)!==null&&r!==void 0&&r.isVisible&&this.recurrenceConfirmation.hide()}makeRecurrence(t){const r=this.eventRecord,i=r.copy();let s=r.recurrence;return!t&&s?s=s.copy():s=new r.recurrenceModel(t?{rule:t}:{}),s.timeSpan=i,i.setStartDate(this.values.startDate),s.suspendTimeSpanNotifying(),s}onRecurrableEventBeforeSave({eventRecord:t,context:r}){const i=this;i.isEditing&&!t.isCreating&&t.supportsRecurring&&(t.isRecurring||t.isOccurrence)&&(i.recurrenceConfirmation.confirm({actionType:"update",eventRecord:t,changerFn(){r.finalize(!0)},cancelFn(){r.finalize(!1)}}),r.async=!0)}set recurrenceConfirmation(t){this._recurrenceConfirmation=t}get recurrenceConfirmation(){const t=this;let r=t._recurrenceConfirmation;return(!r||!r.$$name)&&(r=C.create({type:"recurrenceconfirmation",owner:t.editor,...r}),t._recurrenceConfirmation=r),r}set recurrenceEditor(t){this._recurrenceEditor=t}get recurrenceEditor(){const t=this;let r=t._recurrenceEditor;return(!r||!r.$$name)&&(t._recurrenceEditor=r=C.create({type:"recurrenceeditor",autoShow:!1,centered:!0,modal:!0,minWidth:"auto",constrainTo:globalThis,anchor:!1,rootElement:t.rootElement,saveHandler:t.recurrenceEditorSaveHandler,onBeforeShow:t.onBeforeShowRecurrenceEditor.bind(t),thisObj:t,...r}),r.readOnly=t._readOnly),r}onBeforeShowRecurrenceEditor(){const t=this,{recurrenceEditor:r,eventRecord:i}=t;r&&i!==null&&i!==void 0&&i.supportsRecurring&&(t.recurrence||(t.recurrence=t.makeRecurrence()),t.recurrence.timeSpan.setStartDate(t.values.startDate),r.record=t.recurrence,r.centered=!0)}loadRecurrenceData(t){this.recurrence=t,this.updateRecurrenceFields(t)}updateRecurrenceFields(t){const r=this,{editRecurrenceButton:i}=r;r.recurrenceCombo&&(r.recurrenceCombo.recurrence=t),i&&(i.recurrence=t,i.value=t?t.rule:null,t&&r.client.enableRecurringEvents&&r.showRecurringUI!==!1?i.show():i.hide())}onRecurrenceComboChange({source:t,value:r,userAction:i}){if(i){const s=this,{recurrenceEditor:n}=s;r===t.customValue?(s.recurrenceCombo.recurrence=s.makeRecurrence(),n.centered?n.show():n.show((s.editRecurrenceButton||t).element)):s.loadRecurrenceData(r&&r!=="none"?s.makeRecurrence(`FREQ=${r}`):null)}}recurrenceEditorSaveHandler(t,r){t.recurrenceEditorPanel.syncEventRecord(r),this.updateRecurrenceFields(r),t.close()}onDatesChange(...t){if(super.onDatesChange(...t),!this.loadingRecord&&this.editRecurrenceButton){const{startDate:r}=this.values;r&&(this.editRecurrenceButton.eventStartDate=r)}}internalLoadRecord(t){t!=null&&t.supportsRecurring&&this.loadRecurrenceData(t.recurrence?this.makeRecurrence():null)}updateRecord(t){return t.recurrenceRule&&!this.recurrence&&(t.recurrenceRule=null),super.updateRecord(t)}};class _ extends U{static get $name(){return"ResourceCombo"}static get type(){return"resourcecombo"}static get configurable(){return{showEventColor:!1,displayField:"name",valueField:"id",picker:{cls:"b-resourcecombo-picker",itemIconTpl(e){const{eventColor:t}=e,r=!b.isNamedColor(t),i=t?r?` style="color:${t}"`:"":' style="display:none"';return`<div class="b-icon b-icon-square${!t||r?"":` b-sch-foreground-${t}`}"${i}></div>`}}}}changeShowEventColor(e){return!!e}updateShowEventColor(e){const{_picker:t}=this,r=e?"add":"remove";this.element.classList[r]("b-show-event-color"),t==null||t.element.classList[r]("b-show-event-color")}changePicker(e,t){var r;return e=super.changePicker(e,t),(r=e)===null||r===void 0||r.element.classList[this.showEventColor?"add":"remove"]("b-show-event-color"),e}get innerElements(){return[{class:"b-icon b-resource-icon b-icon-square b-hide-display",reference:"resourceIcon"},this.inputElement]}syncInputFieldValue(){var a;var e;const t=this,{resourceIcon:r,lastResourceIconCls:i}=t,{classList:s}=r,n=(a=(e=t.selected)===null||e===void 0?void 0:e.eventColor)!=null?a:"";super.syncInputFieldValue(),r.style.color="",i&&s.remove(i),t.lastResourceIconCls=null,n?(b.isNamedColor(n)?(t.lastResourceIconCls=`b-sch-foreground-${n}`,s.add(t.lastResourceIconCls)):r.style.color=n,s.remove("b-hide-display")):s.add("b-hide-display")}}_.initClass(),_._$name="ResourceCombo";const P=/[^\w\d]/g;class p extends R.mixin(re,I,Y){static get $name(){return"EventEdit"}static get configurable(){return{triggerEvent:"eventdblclick",typeField:"eventType",eventRecord:null,readOnly:null,editorConfig:{type:"eventeditor",title:"L{EventEdit.Edit event}",closable:!0,localeClass:this,defaults:{localeClass:this},items:{nameField:{type:"text",label:"L{Name}",clearable:!0,name:"name",weight:100,required:!0},resourceField:{type:"resourcecombo",label:"L{Resource}",name:"resource",editable:!0,valueField:"id",displayField:"name",highlightExternalChange:!1,destroyStore:!0,weight:200},startDateField:{type:"date",clearable:!1,required:!0,label:"L{Start}",name:"startDate",validateDateOnly:!0,weight:300},startTimeField:{type:"time",clearable:!1,required:!0,name:"startDate",cls:"b-match-label",weight:400},endDateField:{type:"date",clearable:!1,required:!0,label:"L{End}",name:"endDate",validateDateOnly:!0,weight:500},endTimeField:{type:"time",clearable:!1,required:!0,name:"endDate",cls:"b-match-label",weight:600},colorField:{label:"L{SchedulerBase.color}",type:"eventColorField",name:"eventColor",weight:700}},bbar:{hideWhenEmpty:!0,defaults:{localeClass:this},items:{saveButton:{color:"b-blue",cls:"b-raised",text:"L{Save}",weight:100},deleteButton:{text:"L{Delete}",weight:200},cancelButton:{text:"L{Object.Cancel}",weight:300}}}},targetEventElement:null}}static get pluginConfig(){return{chain:["populateEventMenu","onEventEnterKey","editEvent"]}}construct(e,t){this.readOnly=e.readOnly,super.construct(e,t),e.ion({projectChange:"onChangeProject",readOnly:"onClientReadOnlyToggle",thisObj:this})}get scheduler(){return this.client}get project(){return this.client.project}get readOnly(){return this._editor?this.editor.readOnly:this._readOnly}updateReadOnly(e){super.updateReadOnly(e),this._editor&&(this.editor.readOnly=e)}onClientReadOnlyToggle({readOnly:e}){this.readOnly=e}get editor(){var e,t,r,i,s;const n=this,a={beforehide:"resetEditingContext",beforeshow:"onBeforeEditorShow",keydown:"onPopupKeyDown",thisObj:n};let{_editor:o}=n;if(o)return o;o=n._editor=C.create(n.getEditorConfig());const{startDateField:d,startTimeField:h,endDateField:l,endTimeField:f}=o.widgetMap;return!d&&h&&(h.keepDate=!0,h.label=n.L("Start"),h.flex="1 0 100%"),!l&&f&&(f.keepDate=!0,f.label=n.L("End"),f.flex="1 0 100%"),!o.floating&&!o.positioned&&(o.element.parentNode||n.client.add(o),delete a.beforehide,delete a.beforeshow,a.beforeToggleReveal="onBeforeEditorToggleReveal"),o.readOnly=n._readOnly,o.items.length===0&&console.warn("Event Editor configured without any `items`"),o.ion(a),n.scheduler.relayEvents(o,["beforeSetRecord"],"eventEdit"),Object.values(o.widgetMap).forEach(c=>{const g=c.ref||c.id;if(g&&!n[g])switch(n[g]=c,c.name){case"startDate":case"endDate":c.ion({change:"onDatesChange",thisObj:n});break}}),(e=n.onEditorConstructed)===null||e===void 0||e.call(n,o),(t=n.eventTypeField)===null||t===void 0||t.ion({change:"onEventTypeChange",thisObj:n}),(r=n.saveButton)===null||r===void 0||r.ion({click:"onSaveClick",thisObj:n}),(i=n.deleteButton)===null||i===void 0||i.ion({click:"onDeleteClick",thisObj:n}),(s=n.cancelButton)===null||s===void 0||s.ion({click:"onCancelClick",thisObj:n}),o}getEditorConfig(){const e=this,{cls:t,scheduler:r}=e,i=D.assign({owner:r,eventEditFeature:e,weekStartDay:e.weekStartDay,align:"b-t",id:`${r.id}-event-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,cls:t},e.editorConfig);return C.prototype.getRenderContext(i)[0]&&(i.floating=!1),i.floating===!1&&!i.positioned&&(i.collapsible={type:"overlay",direction:"right",autoClose:!1,tool:null,recollapseTool:null},i.collapsed=!0,i.hidden=i.anchor=!1,i.hide=function(){this.collapsible.toggleReveal(!1)}),!r.showEventColorPickers&&i.items.colorField&&(i.items.colorField.hidden=!0),i.onElementCreated=e.updateCSSVars.bind(this),i}updateCSSVars({element:e}){const t=new Date(2e3,12,31,23,55,55),r=v.format(t,this.dateFormat).replace(P,"").length,i=v.format(t,this.timeFormat).replace(P,"").length,s=r+i;e.style.setProperty("--date-time-length",`${s}em`),e.style.setProperty("--date-width-difference",`${(r-i)/2}em`)}async internalShowEditor(e,t,r=null){var i,s;const n=this,{scheduler:a}=n,o=((i=r)===null||i===void 0||(s=i.target)===null||s===void 0?void 0:s.nodeType)===Element.ELEMENT_NODE?r.target:a.getElementFromEventRecord(e,t),d=e.isPartOfStore(a.eventStore);if(r=r!=null?r:{target:o,anchor:!0},r.target||!d||e.resources.length===0||e.isCreating){var h;a.element.classList.add("b-eventeditor-editing"),n.resourceRecord=t;const{editor:l}=n;n.editingContext={eventRecord:e,resourceRecord:t,eventElement:o,editor:l,isPartOfStore:d},(h=super.internalShowEditor)===null||h===void 0||h.call(this,e,t,r),n.typeField&&n.toggleEventType(e.getValue(n.typeField)),n.loadRecord(e,t),l.collapsed?(await G.sleep(100),await l.collapsible.toggleReveal(!0),l.focus()):l.centered||!l.anchor||!l.floating?l.show():o?(n.targetEventElement=o,l.showBy(r)):(l.show(),l.updateCentered(!0));const f=a.timeAxisViewModel.timeResolution;if(f.unit==="hour"||f.unit==="minute"){const c=`${f.increment}${f.unit}`;n.startTimeField&&(n.startTimeField.step=c),n.endTimeField&&(n.endTimeField.step=c)}n.detachListeners("changesWhileEditing"),a.eventStore.ion({change:n.onChangeWhileEditing,refresh:n.onChangeWhileEditing,thisObj:n,name:"changesWhileEditing"})}}onChangeWhileEditing(){const e=this;!e.isFinalizingEventSave&&e.isEditing&&e.editingContext.isPartOfStore&&!e.eventRecord.isPartOfStore(e.scheduler.eventStore)&&e.onCancelClick()}onBeforeEditorShow(){super.onBeforeEditorShow(...arguments),this.scheduler.trigger("beforeEventEditShow",{eventEdit:this,...this.editingContext})}updateTargetEventElement(e,t){e==null||e.classList.add("b-editing"),t==null||t.classList.remove("b-editing")}editEvent(e,t,r=null,i=null){var s;const n=this,{client:a}=n,{simpleEventEdit:o}=a.features;if(n.isEditing&&n.resetEditingContext(),!(n.disabled||e.readOnly||e.isCreating&&o!==null&&o!==void 0&&o.enabled))return a.trigger("beforeEventEdit",{eventEdit:n,eventRecord:e,resourceRecord:t,eventElement:((s=a.getElementFromEventRecord)===null||s===void 0?void 0:s.call(a,e,t))||r})===!1?(a.element.classList.remove("b-eventeditor-editing"),!1):(i?(n.applyStmCapture(i),n.hasStmCapture=!0,i.transferred=!0):i!==!1&&!a.isCalendar&&!n.hasStmCapture&&n.captureStm(!0),n.doEditEvent(...arguments).then(d=>{if(!n.isDestroying&&!n.isEditing&&!a.isCalendar&&!n.rejectingStmTransaction)return d!==!1&&n.hasStmCapture?n.freeStm(!1):n.freeStm()}))}get isEditing(){const{_editor:e}=this;return!!(e!=null&&e.isVisible&&!(e.collapsed&&!e.revealed))}async doEditEvent(e,t,r=null){const i=this,{scheduler:s}=i,n=e.isCreating;return t||(t=e.resource||i.resourceStore.getById(e.resourceId)),n&&ie.prototype.normalize.call(e),r||n||e.resources.length===0?i.internalShowEditor(e,t,r?{target:r}:null):s.scrollResourceEventIntoView(t,e,{animate:!0,edgeOffset:0,extendTimeAxis:!1}).then(()=>i.internalShowEditor(e,t),()=>s.element.classList.remove("b-eventeditor-editing"))}loadRecord(e,t){this.loadingRecord=!0,this.internalLoadRecord(e,t),this.loadingRecord=!1}get eventRecord(){var e;return(e=this._editor)===null||e===void 0?void 0:e.record}internalLoadRecord(e,t){var r;const i=this,{eventStore:s}=i.client,{editor:n,resourceField:a}=i;if(i.resourceRecord=t,a&&((r=a.store)===null||r===void 0?void 0:r.masterStore)!==i.resourceStore&&(a.store=n.chainResourceStore()),n.record=e,a){const o=s.assignmentStore.getResourcesForEvent(e);n.assigningValues=!0,!e.isOccurrence&&!s.storage.includes(e,!0)&&t?i.resourceField.value=t.getValue(i.resourceField.valueField):i.assignmentStore&&(i.resourceField.value=o.map(d=>d.getValue(i.resourceField.valueField))),n.assigningValues=!1}super.internalLoadRecord(e,t)}toggleEventType(e){this.editor.element.dataset.eventType=e||"",this.editor.eachWidget(t=>{var r;!((r=t.dataset)===null||r===void 0)&&r.eventType&&(t.hidden=t.dataset.eventType!==e)})}async finalizeEventSave(e,t,r,i){const s=this,{scheduler:n,assignmentStore:a}=s;a.suspendAutoCommit(),n.suspendRefresh(),s.onBeforeSave(e),e.beginBatch(),s.updateRecord(e),e.endBatch(),e.isOccurrence?t&&e.set("resourceRecords",t):s.resourceField&&a.assignEventToResource(e,t,null,!0),e.isCreating=!1,await n.project.commitAsync(),a.resumeAutoCommit(),n.resumeRefresh(!0),n.trigger("afterEventSave",{eventRecord:e}),s.onAfterSave(e),r(e)}save(){return new Promise((e,t)=>{var r;const i=this,{scheduler:s,eventRecord:n}=i;if(!n||!i.editor.isValid){e(!1);return}const{eventStore:a,values:o}=i,d=((r=i.resourceField)===null||r===void 0?void 0:r.records)||(i.resourceRecord?[i.resourceRecord]:[]);if(!i.scheduler.allowOverlap&&a){let{startDate:c,endDate:g}=o;if(g||("duration"in o?g=v.add(c,o.duration,o.durationUnit||n.durationUnit):"fullDuration"in o?g=v.add(c,o.fullDuration):g=n.endDate),d.some(M=>!a.isDateRangeAvailable(c,g,n,M))){e(!1);return}}const h={finalize(c){try{c!==!1?i.finalizeEventSave(n,d,e,t):e(!1)}catch(g){t(g)}}},l=s.trigger("beforeEventSave",{eventRecord:n,resourceRecords:d,values:o,context:h});function f(c,g,y){c===!1?e(!1):(i.onRecurrableEventBeforeSave({eventRecord:g,context:y}),y.async||y.finalize())}D.isPromise(l)?l.then(c=>f(c,n,h)):f(l,n,h)})}deleteEvent(){return this.detachListeners("changesWhileEditing"),new Promise((e,t)=>{const r=this,{eventRecord:i,editor:s}=r;r.scheduler.removeEvents([i],n=>{n&&s.containsFocus&&s.revertFocus(),e(n)},s)})}onChangeProject(){this.resourceField&&(this.resourceField.store={})}get eventStore(){return this.scheduler.project.eventStore}get resourceStore(){return this.scheduler.project.resourceStore}get assignmentStore(){return this.scheduler.project.assignmentStore}onActivateEditor({eventRecord:e,resourceRecord:t,eventElement:r}){this.editEvent(e,t,r)}onDragCreateEnd({eventRecord:e,resourceRecord:t,proxyElement:r,stmCapture:i}){this.editEvent(e,t,r,i)}onEventEnterKey({assignmentRecord:e,eventRecord:t,target:r}){const{client:i}=this,s=r[r.matches(i.eventSelector)?"querySelector":"closest"](i.eventInnerSelector);e?this.editEvent(t,e.resource,s):t&&this.editEvent(t,t.resource,s)}onEventTypeChange({value:e}){this.toggleEventType(e)}populateEventMenu({eventRecord:e,resourceRecord:t,items:r}){!this.scheduler.readOnly&&!this.disabled&&(r.editEvent={text:"L{EventEdit.Edit event}",localeClass:this,icon:"b-icon b-icon-edit",weight:100,disabled:e.readOnly,onItem:()=>{this.editEvent(e,t)}})}onBeforeEditorToggleReveal({reveal:e}){e&&this.editor.setupEditorButtons(),this[e?"onBeforeEditorShow":"resetEditingContext"]()}async resetEditingContext(){const e=this;e.detachListeners("changesWhileEditing"),super.resetEditingContext(),e.hasStmCapture&&!e.isDeletingEvent&&!e.isCancelingEdit&&await e.freeStm(!1),e.resourceRecord=null}finalizeStmCapture(e){return this.freeStm(!e)}updateLocalization(){this._editor&&this.updateCSSVars({element:this._editor.element}),super.updateLocalization(...arguments)}}p._$name="EventEdit",j.registerFeature(p,!0,"Scheduler"),j.registerFeature(p,!1,["SchedulerPro","ResourceHistogram"]),p.initClass();class O extends Q{static get $name(){return"ResourceFilter"}static get type(){return"resourcefilter"}static get delayable(){return{applyFilters:"raf"}}static get configurable(){return{eventStore:null,multiSelect:!0,toggleAllIfCtrlPressed:!0,itemTpl:e=>J.encodeHtml(e.name||""),masterFilter:()=>!0,filterResources:null}}itemIconTpl(e,t){const{eventColor:r}=e,i=b.isNamedColor(r)?` b-sch-foreground-${r}`:"",s=!i&&r?` style="color:${r}"`:"";return this.multiSelect?`<div class="b-selected-icon b-icon${i}"${s}></div>`:""}updateEventStore(e){var t,r;const i=this,s=(t=i.initialConfig.store)!==null&&t!==void 0&&t.isStore?i.initialConfig.store.initialConfig:(r=i.store)===null||r===void 0?void 0:r.config,{resourceStore:n}=e,a=i.store=n.chain(i.masterFilter,null,{...s,syncOrder:!0}),o={change:"onStoreChange",thisObj:i};a.un(o),n.ion(o),n.count?i.initFilter():n.project.ion({name:"project",refresh:"initFilter",thisObj:i})}changeMasterFilter(e){const t=this;if(!t.filterResources)return function(r){return t.callback(e,t,[r])}}initFilter(){const{eventStore:e,selected:t}=this;e.resourceStore.count&&(this.initialSelection||t.add(this.store.getRange()),this.detachListeners("project"))}onStoreRefresh({source:e,action:t}){if(t==="filter"&&this.eventStoreFilter){const{eventStoreFilter:r}=this,{disabled:i}=r,s=!e.isFiltered&&this.allSelected;s!==i&&(r.disabled=s,this.applyFilters())}super.onStoreRefresh(...arguments)}onSelectionChange({source:e,added:t,removed:r}){const i=this,s=!i.store.isFiltered&&i.allSelected;super.onSelectionChange(...arguments);let n=!1;if(i.eventStoreFilter||(i.eventStoreFilter=i.eventStore.addFilter({id:`${i.id}-filter-instance`,filterBy:a=>!a.resource||i.selected.includes(a.resources),disabled:s},(t==null?void 0:t.length)===i.store.count),n=!0),i.filterResources&&!i.resourceStoreFilter&&(i.resourceStoreFilter=i.eventStore.resourceStore.addFilter({id:`${i.id}-filter-instance`,filterBy:a=>i.selected.includes(a),disabled:s},(t==null?void 0:t.length)===i.store.count),n=!0),!n&&(i.eventStoreFilter.disabled=s,i.resourceStoreFilter&&(i.resourceStoreFilter.disabled=s),i.applyFilters(),i.eventListeners.change)){const a=e.values,o=a.concat(r);X.remove(o,...t),i.triggerFieldChange({value:a,oldValue:o})}}get value(){return this.selected.values}applyFilters(){this.eventStore.filter(),this.filterResources&&this.eventStore.resourceStore.filter()}doDestroy(){var e;(e=this.store)===null||e===void 0||e.destroy(),super.doDestroy()}}O.initClass(),O._$name="ResourceFilter";class E extends ee{static get $name(){return"SchedulerDatePicker"}static get type(){return"datepicker"}static get configurable(){return{showEvents:null,eventStore:null,eventFilter:{$config:"lazy",value:null}}}construct(e){"events"in e&&(e={...e,showEvents:e.events},delete e.events,x.deprecate(x.calendar?"Calendar":"Scheduler","6.0.0","DatePicker#events should be configured as showEvents")),super.construct(e)}changeEventFilter(e){if(typeof e=="string"){const{handler:t,thisObj:r}=this.resolveCallback(e);e=t.bind(r)}return e}doRefresh(){if(this.isVisible||!this.showEvents)return this.refreshEventsMap(),super.doRefresh(...arguments);this.whenVisible("doRefresh")}updateShowEvents(e,t){const r=this,{classList:i}=r.contentElement;let{eventStore:s}=r;if(r.requestAnimationFrame(()=>{var n;r.element.classList.toggle("b-datepicker-with-events",!!e),(n=r.owner)===null||n===void 0||n.element.classList.toggle("b-datepicker-with-events",!!e),e&&i.add(`b-show-events-${e}`),i.remove(`b-show-events-${t}`)}),e){if(!s){const n=r.up(a=>a.eventStore);if(n)s=n.eventStore;else throw new Error("DatePicker configured with events but no eventStore")}}else r.eventsMap=null;r.isConfiguring||(r.updateEventStore(s),r.doRefresh())}refreshEventsMap(){const e=this;e.showEvents&&(e.eventsMap=e.eventStore.getEventCounts({startDate:e.startDate,endDate:e.endDate,dateMap:e.eventsMap,filter:e.eventFilter}))}updateEventStore(e){if(e.findListener("change","refresh",this)===-1){var t;e==null||(t=e[this.showEvents?"on":"un"])===null||t===void 0||t.call(e,{change:"refresh",thisObj:this})}}cellRenderer({cell:e,date:t}){var r,i;const{showEvents:s}=this,n=(r=this.eventCounts)===null||r===void 0||(i=r.get)===null||i===void 0?void 0:i.call(r,v.makeKey(t)),a=s==="count";delete e.dataset.btip,n&&(!a&&this.eventCountTip&&(e.dataset.btip=this.L("L{ResourceInfoColumn.eventCountText}",n)),b.createElement({dataset:{count:n},class:{[a?"b-cell-events-badge":"b-icon b-icon-circle"]:1,[E.getEventCountClass(n)]:1},parent:e,[a?"text":""]:n}))}static getEventCountClass(e){return e?e<4?"b-datepicker-1-to-3-events":e<7?"b-datepicker-4-to-6-events":"b-calendar-7-or-more-events":""}static setupClass(e){e.replaceType=!0,super.setupClass(e)}}E.initClass(),E._$name="SchedulerDatePicker";export{R as EditBase,p as EventEdit,w as EventEditor,T as RecurrenceCombo,$ as RecurrenceEditor,F as RecurrenceLegend,k as RecurrenceLegendButton,I as RecurringEventEdit,_ as ResourceCombo,O as ResourceFilter,E as SchedulerDatePicker};
//# sourceMappingURL=SchedulerDatePicker.js.map
