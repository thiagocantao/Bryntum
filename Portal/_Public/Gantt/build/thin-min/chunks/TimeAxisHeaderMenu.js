/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var Ae=Object.defineProperty;var $e=(p,t,e)=>t in p?Ae(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e;var E=(p,t,e)=>($e(p,typeof t!="symbol"?t+"":t,e),e);import{stripDuplicates as ue,CalendarCache as Le,IntervalCache as Oe,TimeSpan as ve,DependencyBaseModel as G,DependencyModel as j}from"./CrudManagerView.js";import{ColumnStore as He,GridFeatureManager as P,HeaderMenu as Fe}from"./GridBase.js";import{NumberColumn as Pe}from"./Tree.js";import{ObjectHelper as K,Duration as Ie,DateHelper as M,InstancePlugin as B,Objects as N,Tooltip as _,Rectangle as H,DomHelper as O,Widget as _e,StringHelper as U,EventHelper as V,BrowserHelper as Ve,VersionHelper as ne,Base as ae,IdHelper as je,Delayable as ge,DomSync as J,ArrayHelper as Be,WalkHelper as Ne}from"./Editor.js";import{DragHelper as De,ResizeHelper as We}from"./MessageDialog.js";import{ClockTemplate as Q,AttachToProjectMixin as se,TaskEditStm as Ge}from"./ScheduleMenu.js";import{Draggable as be,Droppable as Ue}from"./AvatarRendering.js";import"./Slider.js";class Xe{initialize(t){t&&Object.assign(this,t)}static new(t){const e=new this;return e.initialize(t),e}}class de{constructor(t){this.intervalGroups=[],t&&Object.assign(this,t)}combineWith(t){const e=this.intervalGroups.slice();return e.push([t.calendar,t]),new de({intervalGroups:e})}getIsWorkingForEvery(){if(this.isWorkingForEvery!=null)return this.isWorkingForEvery;for(let[t,e]of this.getGroups())if(!e[0].isWorking)return this.isWorkingForEvery=!1;return this.isWorkingForEvery=!0}getIsWorkingForSome(){if(this.isWorkingForSome!=null)return this.isWorkingForSome;for(let[t,e]of this.getGroups())if(e[0].isWorking)return this.isWorkingForSome=!0;return this.isWorkingForSome=!1}getCalendars(){return this.getGroups(),this.calendars}isCalendarWorking(t){return this.getCalendarsWorkStatus().get(t)}getCalendarsWorkStatus(){if(this.calendarsWorkStatus)return this.calendarsWorkStatus;const t=new Map;for(let[e,i]of this.getGroups())t.set(e,i[0].isWorking);return this.calendarsWorkStatus=t}getCalendarsWorking(){if(this.calendarsWorking)return this.calendarsWorking;const t=[];for(let[e,i]of this.getGroups())i[0].isWorking&&t.push(e);return this.calendarsWorking=t}getCalendarsNonWorking(){if(this.calendarsNonWorking)return this.calendarsNonWorking;const t=[];for(let[e,i]of this.getGroups())i[0].isWorking||t.push(e);return this.calendarsNonWorking=t}getGroups(){if(this.intervalsByCalendar)return this.intervalsByCalendar;const t=this.calendars=[],e=new Map;return this.intervalGroups.forEach(([i,r])=>{let n=e.get(i);n||(t.push(i),n=[],e.set(i,n)),n.push.apply(n,r.intervals)}),e.forEach((i,r)=>{const n=ue(i);n.sort((a,s)=>s.getPriorityField()-a.getPriorityField()),e.set(r,n)}),this.intervalsByCalendar=e}}class Ce extends Le{constructor(t){super(t),this.calendarCaches=ue(this.calendarCaches),this.intervalCache=new Oe({emptyInterval:new de,combineIntervalsFn:(e,i)=>e.combineWith(i)})}fillCache(t,e){this.calendarCaches.forEach(i=>{i.fillCache(t,e),this.includeWrappingRangeFrom(i,t,e)})}}const Ye=new Map,qe=p=>{const t=ue(p);if(t.length===0)throw new Error("No calendars to combine");t.sort((a,s)=>a.internalId<s.internalId?-1:1);const e=t.map(a=>a.internalId+"/").join(""),i=t.map(a=>a.version+"/").join("");let r=Ye.get(e),n;return r&&r.versionsHash===i?n=r.cache:n=new Ce({calendarCaches:t.map(a=>a.calendarCache)}),n};class he extends Pe{constructor(){super(...arguments);E(this,"compositeField",!0)}static get $name(){return"DurationColumn"}static get type(){return"duration"}static get isGanttColumn(){return!0}static get fields(){return[{name:"decimalPrecision",defaultValue:1}]}static get defaults(){return{min:null,max:null,step:1,largeStep:0,field:"fullDuration",text:"L{Duration}",instantUpdate:!0,filterType:"duration",sortable(e,i){const r=e.getValue(this.field),n=i.getValue(this.field);return r-n}}}construct(){super.construct(...arguments);const e=this.sortable;this.sortable=(...i)=>e.call(this,...i)}get defaultEditor(){const{max:e,min:i,step:r,largeStep:n}=this;return K.cleanupProperties({type:"duration",name:this.field,max:e,min:i,step:r,largeStep:n})}get durationUnitField(){return`${this.field}Unit`}roundValue(e){const i=typeof this.grid.durationDisplayPrecision=="number"?this.grid.durationDisplayPrecision:this.decimalPrecision,r=Math.pow(10,i);return Math.round(e*r)/r}formatValue(e,i){return e instanceof Ie&&(i=e.unit,e=e.magnitude),e=this.roundValue(e),e+" "+M.getLocalizedNameOfUnit(i,e!==1)}defaultRenderer({value:e,record:i,isExport:r}){const n=typeof e,a=n==="number"?e:e==null?void 0:e.magnitude,s=n==="number"?i.getValue(this.durationUnitField):e==null?void 0:e.unit;return typeof a!="number"?r?"":null:this.formatValue(a,s)}toClipboardString({record:e}){return e.getValue(this.field).toString()}fromClipboardString({string:e,record:i}){const r=M.parseDuration(e,!0,this.durationUnit);return r&&"magnitude"in r?r:i.fullDuration}calculateFillValue({value:e,record:i}){return this.fromClipboardString({string:e,record:i})}}He.registerColumnType(he),he._$name="DurationColumn";class Se extends B{static get defaultConfig(){return{tooltipTemplate:t=>`
                <div class="b-sch-tip-${t.valid?"valid":"invalid"}">
                    ${t.startClockHtml}
                    ${t.endClockHtml}
                    <div class="b-sch-tip-message">${t.message}</div>
                </div>
            `,showTooltip:!0,showExactDropPosition:!1,store:null,dragHelperConfig:null,tooltipCls:"b-eventdrag-tooltip"}}static get configurable(){return{constrainDragToTimeline:!0,constrainDragToResource:!0,constrainDragToTimeSlot:!1,tip:{$config:["lazy","nullify"],value:{align:{align:"b-t",allowTargetOut:!0},autoShow:!0,updateContentOnMouseMove:!0}},throttleDragEvent:!0}}static get pluginConfig(){return{chain:["onPaint"]}}internalSnapToPosition(t){var e;const{dragData:i}=this;(e=this.snapToPosition)===null||e===void 0||e.call(this,{assignmentRecord:i.assignmentRecord,eventRecord:i.eventRecord,resourceRecord:i.newResource||i.resourceRecord,startDate:i.startDate,endDate:i.endDate,snapTo:t})}buildDragHelperConfig(){const t=this,{client:e,constrainDragToTimeline:i,constrainDragToResource:r,constrainDragToTimeSlot:n,dragHelperConfig:a={}}=t,{timeAxisViewModel:s,isHorizontal:o}=e,l=o?r:n,d=o?n:r;return t.externalDropTargetSelector&&(a.dropTargetSelector=`.b-timeaxissubgrid,${t.externalDropTargetSelector}`),N.merge({name:t.constructor.name,positioning:"absolute",lockX:d,lockY:l,minX:!0,maxX:!0,constrain:!1,cloneTarget:!i,removeProxyAfterDrop:!1,dragWithin:i?null:document.body,hideOriginalElement:!0,dropTargetSelector:".b-timelinebase",dropTargetCls:t.externalDropTargetSelector?"b-drop-target":"",outerElement:e.timeAxisSubGridElement,targetSelector:e.eventSelector,scrollManager:i?e.scrollManager:null,createProxy:c=>t.createProxy(c),snapCoordinates:({element:c,newX:g,newY:m})=>{const{dragData:f}=t;if(t.constrainDragToTimeline&&!t.constrainDragToTimeSlot&&(t.showExactDropPosition||s.snap)){const u=f.draggedEntities[0],v=t.getCoordinate(u,c,[g,m]),b=s.getDateFromPosition(v,"round"),{calendar:D}=u;if(!D||b&&D.isWorkingTime(b,M.add(b,u.fullDuration))){const C=b&&s.getPositionFromDate(b);b&&b>=e.startDate&&C!=null&&(o?g=C:m=C)}}const h={x:g,y:m};return t.internalSnapToPosition(h),h},internalListeners:{beforedragstart:"onBeforeDragStart",dragstart:"onDragStart",afterdragstart:"onAfterDragStart",drag:"onDrag",drop:"onDrop",abort:"onDragAbort",abortFinalized:"onDragAbortFinalized",reset:"onDragReset",thisObj:t}},a,{isElementDraggable:(c,g)=>(!a||!a.isElementDraggable||a.isElementDraggable(c,g))&&t.isElementDraggable(c,g)})}onPaint({firstPaint:t}){var e;const i=this,{client:r}=i;(e=i.drag)===null||e===void 0||e.destroy(),i.drag=De.new(i.buildDragHelperConfig()),t&&r.rowManager.ion({changeTotalHeight:()=>{var n;return i.updateYConstraint((n=i.dragData)===null||n===void 0?void 0:n[`${r.scheduledEventName}Record`])},thisObj:i}),i.showTooltip&&(i.clockTemplate=new Q({scheduler:r}))}doDestroy(){var t,e,i;(t=this.drag)===null||t===void 0||t.destroy(),(e=this.clockTemplate)===null||e===void 0||e.destroy(),(i=this.tip)===null||i===void 0||i.destroy(),super.doDestroy()}get tipId(){return`${this.client.id}-event-drag-tip`}changeTip(t,e){const i=this;if(t){const r=_.reconfigure(e,_.mergeConfigs({forElement:i.element,id:i.tipId,getHtml:i.getTipHtml.bind(i),cls:i.tooltipCls,owner:i.client},t),{owner:i.client,defaults:{type:"tooltip"}});return r.ion({innerHtmlUpdate:"updateDateIndicator",thisObj:i}),r}else e==null||e.destroy()}createProxy(t){const e=t.cloneNode(!0);return delete e.id,e.classList.add(`b-sch-${this.client.mode}`),e}onBeforeDragStart({context:t,event:e}){const i=this,{client:r}=i,n=i.getMinimalDragData(t,e),a=n==null?void 0:n[`${r.scheduledEventName}Record`],s=n.resourceRecord;if(r.readOnly||i.disabled||!a||a.isDraggable===!1||a.readOnly||s!=null&&s.readOnly)return!1;t.pointerStartDate=r.getDateFromXY([t.startClientX,t.startPageY],null,!1);const o=i.triggerBeforeEventDrag(`before${r.capitalizedEventName}Drag`,{...n,event:e,context:{...t,...n}})!==!1;if(o){var l;i.updateYConstraint(a,s),(l=r[`before${r.capitalizedEventName}DragStart`])===null||l===void 0||l.call(r,t,n)}return o}onAfterDragStart({context:t,event:e}){}get isDragging(){var t;return(t=this.drag)===null||t===void 0?void 0:t.isDragging}get isActivelyDragging(){return this.isDragging&&!this.finalizing}onDragStart({context:t,event:e}){var c;var i,r;const n=this,a=(c=n.findClientFromTarget(e,t))!=null?c:n.client;n.currentOverClient=a,n.drag.unifiedProxy=n.unifiedDrag,n.onMouseOverNewTimeline(a,!0);const s=n.dragData=n.getDragData(t);if(n.suspendElementRedrawing(t.element),n.showTooltip&&n.tip){const g=s.context.dragProxy?s.context.dragProxy.firstChild:t.element;n.tip.showBy(g)}n.triggerDragStart(s),(i=a[`after${a.capitalizedEventName}DragStart`])===null||i===void 0||i.call(a,t,s);const{eventMenu:o,taskMenu:l}=a.features,d=o||l;d==null||(r=d.hideContextMenu)===null||r===void 0||r.call(d,!1)}updateDateIndicator(){const{startDate:t,endDate:e}=this.dragData,{tip:i,clockTemplate:r}=this,n=i.element.querySelector(".b-sch-tooltip-enddate");r.updateDateIndicator(i.element,t),n&&r.updateDateIndicator(n,e)}findClientFromTarget(t,e){let{target:i}=t;if(/^touch/.test(t.type)){const n=H.from(e.element,null,!0).center;i=O.elementFromPoint(n.x,n.y)}const r=_e.fromElement(i,"timelinebase");return r!=null&&r.isResourceHistogram?null:r}onDrag({context:t,event:e}){const i=this,r=i.dragData,n=r.startDate;let a;if(i.constrainDragToTimeline?a=i.client:a=i.findClientFromTarget(e,r.context),i.updateDragContext(t,e),!!a){if(a!==i.currentOverClient&&i.onMouseOverNewTimeline(a),r.dirty||!i.throttleDragEvent){const s=r.valid;i.triggerEventDrag(r,n),s!==r.valid&&(r.context.valid=r.externalDragValidity=r.valid)}i.showTooltip&&i.tip&&(i.tip.lastAlignSpec.allowTargetOut=!r.valid,i.tip.realign())}}onMouseOverNewTimeline(t,e){const i=this,{drag:{lockX:r,lockY:n}}=i,a=[];i.currentOverClient.element.classList.remove("b-dragging-"+i.currentOverClient.scheduledEventName),t.element.classList.add("b-dragging-"+t.scheduledEventName),e||i.currentOverClient.scrollManager.stopMonitoring(),r||a.push({element:t.timeAxisSubGrid.scrollable.element,direction:"horizontal"}),n||a.push({element:t.scrollable.element,direction:"vertical"}),t.scrollManager.startMonitoring({scrollables:a,callback:i.drag.onScrollManagerScrollCallback}),i.currentOverClient=t}triggerBeforeEventDropFinalize(t,e,i){i.trigger(t,e)}onDrop({context:t,event:e}){var i;const r=this,{currentOverClient:n,dragData:a}=r;let s=!1;if(n==null||n.scrollManager.stopMonitoring(),(i=r.tip)===null||i===void 0||i.hide(),t.valid=t.valid&&r.isValidDrop(a),r.drag.removeProxyAfterDrop=!!a.externalDropTarget,t.valid&&a.startDate&&a.endDate){let o=!1;a.finalize=async l=>{o||a.async?await r.finalize(l):t.valid=t.valid&&l},r.triggerBeforeEventDropFinalize(`before${n.capitalizedEventName}DropFinalize`,{context:a,domEvent:e},n),o=!0,t.async=a.async,!t.async&&!a.externalDropTarget&&(s=a.startDate-a.origStart!==0||a.newResource!==a.resourceRecord)}t.async||r.finalize(a.valid&&t.valid&&s)}onDragAbort({context:t}){var e,i;const r=this;(e=r.currentOverClient)===null||e===void 0||e.scrollManager.stopMonitoring(),r.client.currentOrientation.onDragAbort({context:t,dragData:r.dragData}),r.resetDraggedElements(),(i=r.tip)===null||i===void 0||i.hide(),r.triggerDragAbort(r.dragData)}onDragAbortFinalized({context:t}){var e,i;const r=this;r.triggerDragAbortFinalized(r.dragData),(e=(i=r.client)[`after${r.client.capitalizedEventName}DragAbortFinalized`])===null||e===void 0||e.call(i,t,r.dragData)}onDragReset({source:t}){var e;const i=this,r=i.currentOverClient;(e=t.context)!==null&&e!==void 0&&e.started&&(i.resetDraggedElements(),r.trigger(`${r.scheduledEventName}DragReset`)),r==null||r.element.classList.remove(`b-dragging-${r.scheduledEventName}`),i.dragData=null}resetDraggedElements(){const{dragData:t}=this,{eventBarEls:e,draggedEntities:i}=t;this.resumeRecordElementRedrawing(t.record),i.forEach((r,n)=>{this.resumeRecordElementRedrawing(r),e[n].classList.remove(this.drag.draggingCls),e[n].retainElement=!1}),t.context.element.retainElement=!1}onInternalInvalidDrop(t){var e;const i=this,{context:r}=i.drag;(e=i.tip)===null||e===void 0||e.hide(),i.triggerAfterDrop(i.dragData,!1),r.valid=!1,t&&i.drag.abort()}async finalize(t){const e=this,{dragData:i,currentOverClient:r}=e,n=r.features.taskTooltip||r.features.eventTooltip;if(!i||e.finalizing)return;const{context:a,draggedEntities:s,externalDropTarget:o}=i;let l;return e.finalizing=!0,s.forEach((d,c)=>{e.resumeRecordElementRedrawing(d),i.eventBarEls[c].classList.remove(e.drag.draggingCls),i.eventBarEls[c].retainElement=!1}),a.element.retainElement=!1,o&&i.valid||t?(l=e.updateRecords(i),!o&&N.isPromise(l)&&(a.async=!0,await l),i.valid?(a.async&&a.finalize(),o&&e.client.refreshRows(!1),e.triggerAfterDrop(i,!0)):e.onInternalInvalidDrop(!0)):e.onInternalInvalidDrop(a.async||i.async),e.finalizing=!1,n!=null&&n.enabled&&(n.disabled=!0,r.setTimeout(()=>{n.disabled=!1},200)),l}updateDragContext(t,e){var f,h;const i=this,{drag:r}=i,n=i.dragData,a=i.currentOverClient,{isHorizontal:s}=a,[o]=n.draggedEntities,l=o.isAssignment?o.event:o,d=n.startDate,c=i.constrainDragToTimeSlot||(s?r.lockX:r.lockY);if(n.browserEvent=e,Object.assign(n,i.getProductDragContext(n)),c)n.timeDiff=0;else{let u;if(a.timeAxis.isContinuous){const v=a.isHorizontal?(f=t.pageX)!=null?f:t.startPageX:(h=t.pageY)!=null?h:t.startPageY,b=a.getDateFromCoordinate(v,null,!1,!0);u=n.timeDiff=b-t.pointerStartDate}else{const v=i.resolveStartEndDates(t.element);n.valid=!!(v.startDate&&v.endDate),n.valid&&(u=v.startDate-n.origStart)}u!==null&&(n.startDate=i.adjustStartDate(n.origStart,u),n.endDate=M.add(n.startDate,l.fullDuration),n.valid&&(n.timeDiff=n.startDate-n.origStart))}const g=n.dirty=n.dirty||d-n.startDate!==0;if(n.valid)if(i.constrainDragToTimeline&&(n.endDate<=a.timeAxis.startDate||n.startDate>=a.timeAxis.endDate))n.valid=!1,n.context.message=i.L("L{EventDrag.noDropOutsideTimeline}");else if(g||n.externalDropTarget){const u=n.externalDragValidity=!e||t.pageX&&i.checkDragValidity(n,e);!u||typeof u=="boolean"?(n.valid=u!==!1,n.context.message=""):(n.valid=u.valid!==!1,n.context.message=u.message)}else{var m;n.valid=n.externalDragValidity!==!1&&((m=n.externalDragValidity)===null||m===void 0?void 0:m.valid)!==!1}else n.valid=!1;n.context.valid=n.valid}suspendRecordElementRedrawing(t,e=!0){this.suspendElementRedrawing(this.getRecordElement(t),e),t.instanceMeta(this.client).retainElement=e}resumeRecordElementRedrawing(t){this.suspendRecordElementRedrawing(t,!1)}suspendElementRedrawing(t,e=!0){t&&(t.retainElement=e)}resumeElementRedrawing(t){this.suspendElementRedrawing(t,!1)}getDragData(t){const e=this,{client:i,drag:r}=e,n=e.setupProductDragData(t),{record:a,eventBarEls:s,draggedEntities:o}=n,{startEvent:l}=r,d=a.isAssignment?a.event:a,c=d.startDate,g=d.endDate,m=i.timeAxis,f=c<m.startDate,h=g>m.endDate,u=i.isSchedulerBase?i.multiEventSelect:i.selectionMode.multiSelect,v=e.getCoordinate(d,t.element,[t.elementStartX,t.elementStartY]),b=e.getCoordinate(d,t.element,[t.startClientX,t.startClientY]);e.suspendRecordElementRedrawing(a),o.forEach(C=>e.suspendRecordElementRedrawing(C)),a.isAssignment?i.selectAssignment(a,l.ctrlKey&&u):i.selectEvent(a,l.ctrlKey&&u);const D={context:t,...n,sourceDate:f?c:i.getDateFromCoordinate(v),screenSourceDate:i.getDateFromCoordinate(b,null,!1),startDate:c,endDate:g,timeDiff:0,origStart:c,origEnd:g,startsOutsideView:f,endsOutsideView:h,duration:g-c,browserEvent:l};return s.forEach(C=>C.classList.remove("b-sch-event-hover","b-active")),s.length>1&&(t.relatedElements=s.slice(1)),D}setupConstraints(t,e,i,r){const n=this,a=!n.showExactDropPosition&&i>1?i:0,s=0;r?n.setXConstraint(t.left,t.right-e.width,a):n.setXConstraint(!0,!0,a),n.setYConstraint(t.top,t.bottom-e.height,s)}updateYConstraint(t,e){const i=this,{client:r}=i,{context:n}=i.drag,a=r.timeAxisViewModel.snapPixelAmount;if(n&&!i.drag.lockY){let s;if(i.constrainDragToTimeline)s=r.getScheduleRegion(e,t);else{i.setYConstraint(null,null,a);return}i.setYConstraint(s.top,s.bottom-n.element.offsetHeight,a)}else i.setYConstraint(null,null,a)}setXConstraint(t,e,i){const{drag:r}=this;r.minX=t,r.maxX=e}setYConstraint(t,e,i){const{drag:r}=this;r.minY=t,r.maxY=e}adjustStartDate(t,e){const i=this.client.timeAxis.roundDate(new Date(t-0+e),this.client.snapRelativeToEventStartDate?t:!1);return this.constrainStartDate(i)}resolveStartEndDates(t){const e=this.currentOverClient,{timeAxis:i}=e,r=H.from(t.querySelector(e.eventInnerSelector),e.timeAxisSubGridElement),n=this.dragData,[a]=n.draggedEntities,s=a.isAssignment?a.event:a,{fullDuration:o}=s,l=e.fillTicks&&e.snapRelativeToEventStartDate;let{start:d,end:c}=e.getStartEndDatesFromRectangle(r,l?null:"round",o,!0);if(d&&c){if(l){const g=s.startDate-M.startOf(s.startDate,i.unit),m=c-d,f=g/m*r.width;r.deflate(f,0,0,f);const h=r.getStart(e.rtl,!e.isVertical);d=e.getDateFromCoordinate(h,null,!0),d=i.roundDate(d,s.startDate)}if(d=this.adjustStartDate(d,0),n.startsOutsideView)n.endsOutsideView||(d=c&&M.add(c,-o));else{if(!i.dateInAxis(d,!1)){const g=i.getTickFromDate(d);g>=0&&(d=i.getDateFromTick(g))}c=d&&M.add(d,o)}}return{startDate:d,endDate:c}}getTipHtml(){const t=this,{dragData:e,client:i,tooltipTemplate:r}=t,{startDate:n,endDate:a,draggedEntities:s}=e,o=i.getFormattedDate(n),l=i.getFormattedEndDate(a,n),{valid:d,message:c,element:g,dragProxy:m}=e.context,f=m?m.firstChild:g,h=s[0],u=h.isTask?h:h.event;return t.tip.lastAlignSpec.target=f,r({valid:d,startDate:n,endDate:a,startText:o,endText:l,dragData:e,message:c||"",[i.scheduledEventName+"Record"]:u,startClockHtml:t.clockTemplate.template({date:n,text:o,cls:"b-sch-tooltip-startdate"}),endClockHtml:u.isMilestone?"":t.clockTemplate.template({date:a,text:l,cls:"b-sch-tooltip-enddate"})})}updateConstrainDragToTimeSlot(t){const e=this.client.isHorizontal?"lockX":"lockY";this.drag&&(this.drag[e]=t)}updateConstrainDragToResource(t){const e=this;if(e.drag){const{constrainDragToTimeSlot:i}=e,{isHorizontal:r}=e.client;t&&(e.constrainDragToTimeline=!0),e.drag.lockY=r?t:i,e.drag.lockX=r?i:t}}updateConstrainDragToTimeline(t){this.isConfiguring||Object.assign(this.drag,{cloneTarget:!t,dragWithin:t?null:document.body,scrollManager:t?this.client.scrollManager:null})}constrainStartDate(t){const{dragData:e}=this,{dateConstraints:i}=e,r=e.eventRecord||e.taskRecord||e.draggedEntities[0];return i!=null&&i.start&&(t=M.max(i.start,t)),i!=null&&i.end&&(t=M.min(new Date(i.end-r.durationMS),t)),t}getElementFromContext(t){return t.grabbed||t.dragProxy||t.element}getRelatedRecords(t){return[]}getMinimalDragData(t,e){return{}}isValidDrop(t){throw new Error("Implement in subclass")}checkDragValidity(t){throw new Error("Implement in subclass")}updateRecords(t){throw new Error("Implement in subclass")}isElementDraggable(t,e){throw new Error("Implement in subclass")}getCoordinate(t,e,i){throw new Error("Implement in subclass")}setupProductDragData(t){throw new Error("Implement in subclass")}getProductDragContext(t){throw new Error("Implement in subclass")}getRecordElement(t){throw new Error("Implement in subclass")}}Se._$name="DragBase";const ye={top:"b-t",right:"b100-t100",bottom:"t-b",left:"b0-t0"};class ee extends B.mixin(be,Ue){static get $name(){return"EventResize"}static get configurable(){return{draggingItemCls:"b-sch-event-wrap-resizing",resizingItemInnerCls:"b-sch-event-resizing",leftHandle:!0,rightHandle:!0,topHandle:!0,bottomHandle:!0,handleSize:null,dynamicHandleSize:!0,allowResizeToZero:null,reservedSpace:5,touchHandleSize:null,dragThreshold:0,dragTouchStartDelay:0,draggingClsSelector:".b-timeline-base",showTooltip:!0,showExactResizePosition:!1,validatorFn:()=>!0,validatorFnThisObj:null,tip:{$config:["lazy","nullify"],value:{autoShow:!1,axisLock:!0,trackMouse:!1,updateContentOnMouseMove:!0,hideDelay:0}},tooltipTemplate:t=>`
                <div class="b-sch-tip-${t.valid?"valid":"invalid"}">
                    ${t.startClockHtml}
                    ${t.endClockHtml}
                    <div class="b-sch-tip-message">${t.message}</div>
                </div>
            `,ignoreSelector:".b-sch-terminal",dragActiveCls:"b-resizing-event"}}static get pluginConfig(){return{chain:["render","onEventDataGenerated","isEventElementDraggable"]}}doDestroy(){var t;super.doDestroy(),(t=this.dragging)===null||t===void 0||t.destroy()}render(){const t=this,{client:e}=t;t.dragSelector=t.dragItemSelector=e.eventSelector,t.dragRootElement=t.dropRootElement=e.timeAxisSubGridElement,t.dragLock=e.isVertical?"y":"x"}isEventElementDraggable(t,e,i,r){const n=this,a=e==null?void 0:e.resizable;return n.disabled||!a||e.isMilestone?!0:(a!==!0&&a!=="start"||!n.isOverStartHandle(r,t))&&(a!==!0&&a!=="end"||!n.isOverEndHandle(r,t))}onEventDataGenerated({eventRecord:t,wrapperCls:e,cls:i}){var r,n;t===((r=this.dragging)===null||r===void 0||(n=r.context)===null||n===void 0?void 0:n.eventRecord)&&(e["b-active"]=e[this.draggingItemCls]=e["b-over-resize-handle"]=i["b-resize-handle"]=i[this.resizingItemInnerCls]=1)}onDragPointerMove(t){var e;const{client:i,dragging:r}=this,{visibleDateRange:n,isHorizontal:a}=i,s=a&&i.rtl,o=a?"X":"Y",l=globalThis[`page${o}Offset`],d=t[`page${o}`]+(((e=r.context)===null||e===void 0?void 0:e.offset)||0),c=H.from(i.timeAxisSubGridElement,null,!0),g=c.getStart(s,a),m=c.getEnd(s,a);let f=i.getDateFromCoord({coord:d,local:!1});s?d-l>g?f=n.startDate:d<m&&(f=n.endDate):d-l<g?f=n.startDate:d-l>m&&(f=n.endDate),r.clientStartCoord=g,r.clientEndCoord=m,r.date=f,super.onDragPointerMove(t)}get isResizing(){return!!this.dragging}beforeDrag(t){const{client:e}=this,i=e.resolveTimeSpanRecord(t.itemElement),r=!e.isGanttBase&&e.resolveResourceRecord(e.isVertical?t.startEvent:t.itemElement);return this.disabled||e.readOnly||r!=null&&r.readOnly||i&&(i.readOnly||!(i.project||i.isOccurrence))||super.beforeDrag(t)===!1?!1:(t.mousedownDate=t.date=e.getDateFromCoordinate(t.event[`page${e.isHorizontal?"X":"Y"}`],null,!1),this.triggerBeforeResize(t))}dragStart(t){var e,i;const r=this,{client:n,tip:a}=r,{startEvent:s,itemElement:o}=t,l=n.scheduledEventName,d=n.resolveEventRecord(o),{isBatchUpdating:c,wrapStartDate:g,wrapEndDate:m}=d,f=(e=n.features.eventBuffer)===null||e===void 0?void 0:e.enabled,h=c?d.get("startDate"):d.startDate,u=c?d.get("endDate"):d.endDate,v=r.dragLock==="x",b=v&&n.rtl,D=r.isOverEndHandle(s,o),C=D?"endDate":"startDate",w=f?D?"wrapEndDate":"wrapStartDate":null,y=D?"startDate":"endDate",T=D?"setEndDate":"setStartDate",x=D?"setStartDate":"setEndDate",A=H.from(o),R=v?s.clientX:s.clientY,z=D?A.getEnd(b,v):A.getStart(b,v),S=t.context={eventRecord:d,element:o,timespanRecord:d,taskRecord:d,owner:r,valid:!0,oldValue:D?u:h,startDate:h,endDate:u,offset:f?0:z-R,edge:v?D?"right":"left":D?"bottom":"top",finalize:r.finalize,event:t.event,originalStartDate:h,originalEndDate:u,wrapStartDate:g,wrapEndDate:m,draggingEnd:D,toSet:C,wrapToSet:w,otherEnd:y,setMethod:T,setOtherMethod:x};d.meta.isResizing=!0,n.element.classList.add(...r.dragActiveCls.split(" ")),n.listenToBatchedUpdates||n.beginListeningForBatchedUpdates(),c||r.beginEventRecordBatch(d),r.setupProductResizeContext(S,s),r.triggerEventResizeStart(`${l}ResizeStart`,{[`${l}Record`]:d,event:s,...r.getResizeStartParams(S)},S),S.resizedRecord=((i=n.resolveAssignmentRecord)===null||i===void 0?void 0:i.call(n,S.element))||d,a&&(a.show(),a.align=ye[S.edge],a.showBy(r.getTooltipTarget(t)))}triggerBeforeResize(t){const{client:e}=this,i=e.resolveTimeSpanRecord(t.itemElement);return e.trigger(`before${e.capitalizedEventName}Resize`,{[`${e.scheduledEventName}Record`]:i,event:t.event,...this.getBeforeResizeParams({event:t.startEvent,element:t.itemElement})})}triggerEventResizeStart(t,e,i){var r,n;this.client.trigger(t,e),(r=(n=this.client)[`after${U.capitalize(t)}`])===null||r===void 0||r.call(n,i,e)}triggerEventResizeEnd(t,e){this.client.trigger(t,e)}triggerEventPartialResize(t,e){this.client.trigger(t,e)}triggerBeforeEventResizeFinalize(t,e){this.client.trigger(t,e)}dragEnter(t){var e;return((e=t.context)===null||e===void 0?void 0:e.owner)===this}resizeEventPartiallyInternal(t,e){var i;const{client:r}=this,{toSet:n}=e;if((i=r.features.eventBuffer)!==null&&i!==void 0&&i.enabled){if(n==="startDate"){const a=e.startDate.getTime()-e.originalStartDate.getTime();t.wrapStartDate=new Date(e.wrapStartDate.getTime()+a)}else if(n==="endDate"){const a=e.endDate.getTime()-e.originalEndDate.getTime();t.wrapEndDate=new Date(e.wrapEndDate.getTime()+a)}}t.set(n,e[n])}applyDateConstraints(t,e,i){var r,n;const a=(r=i.dateConstraints)===null||r===void 0?void 0:r.start,s=(n=i.dateConstraints)===null||n===void 0?void 0:n.end;return(a||s)&&(t=M.constrain(t,a,s),i.snappedDate=M.constrain(i.snappedDate,a,s)),t}moveDrag(t){const e=this,{client:i,tip:r}=e,n=e.dragLock==="x",a=n?"X":"Y",s=i.scheduledEventName,{visibleDateRange:o,enableEventAnimations:l,timeAxis:d,weekStartDay:c}=i,g=n&&i.rtl,{resolutionUnit:m,resolutionIncrement:f}=d,{event:h,context:u}=t,{eventRecord:v}=u,b=u.offset*(g?-1:1),{isOccurrence:D}=v,C=v.get("startDate"),w=v.get("endDate"),y=h[`client${a}`]+b,T=H.from(i.timeAxisSubGridElement,null,!0),x=T.getStart(g,n),A=T.getEnd(g,n);u.event=h,h.isScroll&&(t.date=i.getDateFromCoordinate(h[`page${a}`]+b,null,!1));let R,z,{date:S}=t,{toSet:k,otherEnd:L,draggingEnd:I}=u;g?y>x?S=t.date=o.startDate:y<A&&(S=t.date=o.endDate):y<x?S=t.date=o.startDate:y>A&&(S=t.date=o.endDate),k==="endDate"?S<C&&(R=-1):S>w&&(R=1),R&&e.onDragEndSwitch&&(e.onDragEndSwitch(u,S,R),L=u.otherEnd,k=u.toSet),i.snapRelativeToEventStartDate&&(S=d.roundDate(S,u.oldValue)),u.snappedDate=M.round(S,d.resolution,null,c);const $=M.diff(S,u[L],m)*(I?-1:1);if(e.isEventDragCreate)u.tooNarrow=$<f/2;else if($<f)if(e.allowResizeToZero)u.snappedDate=S=u[L];else{const F=L==="startDate"?1:-1;u.snappedDate=S=d.roundDate(M.add(v.get(L),f*F,m)),z=!0}if(S=e.applyDateConstraints(S,v,u),(!u.date||S-u.date||z)&&(u.date=S,u[k]=e.showExactResizePosition||i.timeAxisViewModel.snap?u.snappedDate:S,u.valid=e.allowResizeToZero||u[k]-u[k==="startDate"?"endDate":"startDate"]!==0,v.get(k)-u[k])){if(u.valid=e.checkValidity(u,h),u.message="",u.valid&&typeof u.valid!="boolean"&&(u.message=u.valid.message,u.valid=u.valid.valid),u.valid=u.valid!==!1,u.valid){const F={[`${s}Record`]:v,startDate:C,endDate:w,element:t.itemElement,context:u};F[k]=u[k],e.triggerEventPartialResize(`${s}PartialResize`,F),D&&v.stores.push(i.eventStore),i.enableEventAnimations=!1,this.resizeEventPartiallyInternal(v,u),i.enableEventAnimations=l,D&&(v.stores.length=0)}u.tooNarrow&&(u.valid=!1)}r&&(r.align=ye[u.edge],r.alignTo(e.getTooltipTarget(t))),super.moveDrag(t)}dragEnd(t){const{context:e}=t;e&&(e.event=t.event),t.aborted?e==null||e.finalize(!1):!this.isEventDragCreate&&!t.started&&!V.getPagePoint(t.event).equals(V.getPagePoint(t.startEvent))&&(this.dragStart(t),this.cleanup(t.context,!1))}async dragDrop({context:t,event:e}){var i;t[t.toSet]=t.snappedDate;const{client:r}=this,{startDate:n,endDate:a}=t;let s;(i=this.tip)===null||i===void 0||i.hide(),t.valid=n&&a&&(this.allowResizeToZero||a-n>0)&&t[t.toSet]-t.oldValue&&t.valid!==!1,t.valid&&(this.triggerBeforeEventResizeFinalize(`before${r.capitalizedEventName}ResizeFinalize`,{context:t,event:e,[`${r.scheduledEventName}Record`]:t.eventRecord}),s=!0),t.async||await t.finalize(s)}async finalize(t){const e=this.owner,i=this,{eventRecord:r,oldValue:n,toSet:a}=i,{snapRelativeToEventStartDate:s,timeAxis:o}=e.client;let l=!1;t?(s&&(i[a]=i.snappedDate=o.roundDate(i.date,n)),l=await e.internalUpdateRecord(i,r)):(e.cancelEventRecordBatch(r),r.isOccurrence&&r.resources.forEach(d=>e.client.repaintEventsForResource(d))),e.isDestroyed||e.cleanup(i,l)}cleanup(t,e){var i;const r=this,{client:n}=r,{element:a,eventRecord:s}=t,o=n.scheduledEventName;s.meta.isResizing=!1,n.endListeningForBatchedUpdates(),(i=r.tip)===null||i===void 0||i.hide(),r.unHighlightHandle(a),n.element.classList.remove(...r.dragActiveCls.split(" ")),r.triggerEventResizeEnd(`${o}ResizeEnd`,{changed:e,[`${o}Record`]:s,...r.getResizeEndParams(t)})}async internalUpdateRecord(t,e){const{client:i}=this,{generation:r}=e;if(e.isOccurrence)i.endListeningForBatchedUpdates(),e[e.batching>1?"endBatch":"cancelBatch"](),e.set(ve.prototype.inSetNormalize.call(e,{startDate:t.startDate,endDate:t.endDate}));else{const a={[t.toSet]:t[t.toSet]};if(e.isEntity){var n;const{startDate:s,endDate:o,draggingEnd:l}=t;t.duration=a.duration=e.run("calculateProjectedDuration",s,o),a[t.toSet]=e.run("calculateProjectedXDateWithDuration",l?s:o,l,t.duration);const d=!e[t.otherEnd];d&&(a[t.otherEnd]=t[t.otherEnd]),e.set(a),i.endListeningForBatchedUpdates(),this.cancelEventRecordBatch(e),(n=i.features.eventBuffer)!==null&&n!==void 0&&n.enabled&&(e[t.wrapToSet]=null);const c=[];d&&c.push(e[t.setOtherMethod](a[t.otherEnd],!1)),c.push(e[t.setMethod](a[t.toSet],!1)),await Promise.all(c),e.endBatch()}else{const s=Object.assign({},e.meta.batchChanges);delete s[t.toSet],i.endListeningForBatchedUpdates(),this.cancelEventRecordBatch(e),e.set(s),e[t.setMethod](a[t.toSet],!1)}}return await i.project.commitAsync(),e.generation!==r}onDragItemMouseMove(t){t.pointerType!=="touch"&&!this.handleSelector&&this.checkResizeHandles(t)}checkResizeHandles(t){const e=this,{overItem:i}=e;if(i&&!e.client.readOnly&&(!e.allowResize||e.allowResize(i,t))){const r=e.client.resolveTimeSpanRecord(i);if(r!=null&&r.readOnly)return;e.isOverAnyHandle(t,i)?e.highlightHandle():e.unHighlightHandle()}}onDragItemMouseLeave(t,e){this.unHighlightHandle(e)}highlightHandle(){var n;var t;const{overItem:e,client:i}=this;((n=(t=e.syncIdMap)===null||t===void 0?void 0:t[i.scheduledEventName])!=null?n:e.querySelector(i.eventInnerSelector)).classList.add("b-resize-handle"),e.classList.add("b-over-resize-handle")}unHighlightHandle(t=this.overItem){var i;if(t){var e;const r=this,n=(i=(e=t.syncIdMap)===null||e===void 0?void 0:e[r.client.scheduledEventName])!=null?i:t.querySelector(r.client.eventInnerSelector);n&&n.classList.remove("b-resize-handle",r.resizingItemInnerCls),t.classList.remove("b-over-resize-handle",r.draggingItemCls)}}isOverAnyHandle(t,e){return this.isOverStartHandle(t,e)||this.isOverEndHandle(t,e)}isOverStartHandle(t,e){var i;return(i=this.getHandleRect("start",t,e))===null||i===void 0?void 0:i.contains(V.getPagePoint(t))}isOverEndHandle(t,e){var i;return(i=this.getHandleRect("end",t,e))===null||i===void 0?void 0:i.contains(V.getPagePoint(t))}getHandleRect(t,e,i){if(this.overItem){if(i=e.target.closest(`.${this.client.eventCls}`)||i.querySelector(`.${this.client.eventCls}`),!i)return;const r=this,n=t==="start",{client:a}=r,s=!!a.rtl,o=r.dragLock,l=o==="x",d=l?"width":"height",c=`${l?n&&!s?"left":"right":n?"top":"bottom"}Handle`,{offsetWidth:g}=i,m=a.resolveTimeSpanRecord(i),f=m==null?void 0:m.isResizable,h=H.from(i),u=h.clone(),v=globalThis.getComputedStyle(i,":before"),b=!r.handleSelector&&!Ve.isHoverableDevice?r.touchHandleSize:void 0,D=b||r.handleSize||parseFloat(v[d]),C=r.handleVisibilityThreshold||2*r.handleSize,w=r.dynamicHandleSize?r.reservedSpace/2:0,y=[0,0,0,0];if(!r.disabled&&r[c]&&(g>=C||r.dynamicHandleSize)&&(f===!0||f===t)&&(!l&&!n||l&&s===n?(u[o]+=h[d]-D,y[l?3:0]=h[d]/2+w):y[l?1:2]=h[d]/2+w,h.deflate(...y),u[d]=D,u.constrainTo(h),u[d]))return u}}setupDragContext(t){const e=this;if(e.overItem&&e.isOverAnyHandle(t,e.overItem)&&e.isElementResizable(e.overItem,t)){const i=super.setupDragContext(t);return i.scrollManager=e.client.scrollManager,i}}changeHandleSize(){ne.deprecate("Scheduler","6.0.0","Handle size is from CSS")}changeTouchHandleSize(){ne.deprecate("Scheduler","6.0.0","Handle size is from CSS")}changeTip(t,e){const i=this;if(!i.showTooltip)return null;if(t)t.isTooltip?t.owner=i:t=_.reconfigure(e,_.mergeConfigs({id:i.tipId},t,{getHtml:i.getTipHtml.bind(i),owner:i.client},i.tip),{owner:i,defaults:{type:"tooltip"}}),t.ion({innerhtmlupdate:"updateDateIndicator",thisObj:i}),i.clockTemplate=new Q({scheduler:i.client});else if(e){var r;e.destroy(),(r=i.clockTemplate)===null||r===void 0||r.destroy()}return t}isElementResizable(t,e){var g;var i;const r=this,{client:n}=r,a=n.resolveTimeSpanRecord(t);if(n.readOnly)return!1;let s=a==null?void 0:a.isResizable;const o=(g=(i=t)===null||i===void 0?void 0:i.syncIdMap[n.scheduledEventName])!=null?g:t,l=e.target.closest('[class$="-handle"]');if(!s||l&&l!==o||(t=e.target.closest(r.dragSelector),!t))return!1;const d=t.classList.contains("b-sch-event-startsoutside"),c=t.classList.contains("b-sch-event-endsoutside");if(s===!0){if(d&&c)return!1;if(d)s="end";else if(c)s="start";else return r.isOverStartHandle(e,t)||r.isOverEndHandle(e,t)}return d&&s==="start"||c&&s==="end"?!1:!!(r.isOverStartHandle(e,t)&&s==="start"||r.isOverEndHandle(e,t)&&s==="end")}updateDateIndicator(){const{clockTemplate:t}=this,{eventRecord:e,draggingEnd:i,snappedDate:r}=this.dragging.context,n=i?e.get("startDate"):r,a=i?r:e.get("endDate"),{element:s}=this.tip;t.updateDateIndicator(s.querySelector(".b-sch-tooltip-startdate"),n),t.updateDateIndicator(s.querySelector(".b-sch-tooltip-enddate"),a)}getTooltipTarget({itemElement:t,context:e}){const i=this,{rtl:r}=i.client,n=H.from(t,null,!0);return i.dragLock==="x"?(!r&&e.edge==="right"||r&&e.edge==="left"?n.x=n.right-1:n.x-=i.tip.anchorSize[0]/2,n.width=i.tip.anchorSize[0]/2):(e.edge==="bottom"&&(n.y=n.bottom-1),n.height=i.tip.anchorSize[1]/2),{target:n}}basicValidityCheck(t,e){return t.startDate&&(t.endDate>t.startDate||this.allowResizeToZero)&&this.validatorFn.call(this.validatorFnThisObj||this,t,e)}getTipHtml({tip:t}){const e=this,{startDate:i,endDate:r,toSet:n,snappedDate:a,valid:s,message:o="",timespanRecord:l}=e.dragging.context;if(!i||!r)return t.html;const d={record:l,valid:s,message:o,startDate:i,endDate:r,[n]:a};return d.startText=e.client.getFormattedDate(d.startDate),d.endText=e.client.getFormattedDate(d.endDate),d.startClockHtml=e.clockTemplate.template({date:d.startDate,text:d.startText,cls:"b-sch-tooltip-startdate"}),d.endClockHtml=e.clockTemplate.template({date:d.endDate,text:d.endText,cls:"b-sch-tooltip-enddate"}),e.tooltipTemplate(d)}beginEventRecordBatch(t){t.beginBatch()}cancelEventRecordBatch(t){t.cancelBatch()}getBeforeResizeParams(t){const{client:e}=this;return{resourceRecord:e.resolveResourceRecord(e.isVertical?t.event:t.element)}}getResizeStartParams(t){return{resourceRecord:t.resourceRecord}}getResizeEndParams(t){return{resourceRecord:t.resourceRecord,event:t.event}}setupProductResizeContext(t,e){var i,r,n;const{client:a}=this,{element:s}=t,o=a.resolveEventRecord(s),l=(i=a.resolveResourceRecord)===null||i===void 0?void 0:i.call(a,s),d=(r=a.resolveAssignmentRecord)===null||r===void 0?void 0:r.call(a,s);Object.assign(t,{eventRecord:o,taskRecord:o,resourceRecord:l,assignmentRecord:d,dateConstraints:(n=a.getDateConstraints)===null||n===void 0?void 0:n.call(a,l,o)})}checkValidity({startDate:t,endDate:e,eventRecord:i,resourceRecord:r}){const{client:n}=this;return!n.allowOverlap&&i.resources.some(a=>!n.isDateRangeAvailable(t,e,i,a))?{valid:!1,message:this.L("L{EventDrag.eventOverlapsExisting}")}:this.basicValidityCheck(...arguments)}get tipId(){return`${this.client.id}-event-resize-tip`}}ee._$name="EventResize",P.registerFeature(ee,!0,"Scheduler"),P.registerFeature(ee,!1,"ResourceHistogram");var Te=p=>class extends(p||ae){static get $name(){return"TaskEditTransactional"}captureStm(e){if(this.client.transactionalFeaturesEnabled)return super.captureStm(),this.startStmTransaction(e);super.captureStm(e)}freeStm(e){if(this.hasStmCapture||!this.client.transactionalFeaturesEnabled)return super.freeStm(e)}async startStmTransaction(e){this.client.transactionalFeaturesEnabled?await this.startFeatureTransaction(e):super.startStmTransaction()}commitStmTransaction(){if(this.client.transactionalFeaturesEnabled)return this.finishFeatureTransaction();super.commitStmTransaction()}async rejectStmTransaction(){this.client.transactionalFeaturesEnabled?this.rejectFeatureTransaction():await super.rejectStmTransaction()}},Ee=p=>{var t;return t=class extends se(p||ae){detachFromProject(i){this.rejectFeatureTransaction(),super.detachFromProject(i)}getStmCapture(){const i=super.getStmCapture();return i._editorPromiseResolve=this._editorPromiseResolve,i}applyStmCapture(i){super.applyStmCapture(i),this._editorPromiseResolve=i._editorPromiseResolve}async startFeatureTransaction(){if(!this.client.transactionalFeaturesEnabled)return;const i=this,{project:r}=i.client,{stm:n}=r;let a;i.hasStmCapture?n.startTransaction():a=r.queue(()=>r.commitAsync()),r.queue(()=>{var s;return i.hasStmCapture||(i._stmInitiallyDisabled=n.disabled,i._stmInitiallyAutoRecord=n.autoRecord,n.isRecording?n.stopTransaction():i._stmInitiallyDisabled&&n.enable(),n.autoRecord=!1),n.isRecording||n.startTransaction(),(s=i.trigger)===null||s===void 0||s.call(i,"featureTransactionStart"),new Promise(o=>i._editorPromiseResolve=o)}),await a}rejectFeatureTransaction(){var i;if(!this.client.transactionalFeaturesEnabled)return;const r=this,{stm:n}=r.client.project;(i=r._editorPromiseResolve)===null||i===void 0||i.call(r),r._editorPromiseResolve=null,n.isRecording&&n.rejectTransaction(),!r.hasStmCapture&&r._stmInitiallyDisabled!=null&&(n.disabled=r._stmInitiallyDisabled,n.autoRecord=r._stmInitiallyAutoRecord),r.trigger("featureTransactionReject")}async finishFeatureTransaction(i){var r;if(!this.client.transactionalFeaturesEnabled)return;const n=this,{project:a}=n.client,{stm:s}=a;a.isEngineReady()||await a.commitAsync();const o=s.stash(),{_stmInitiallyDisabled:l,_stmInitiallyAutoRecord:d}=n,c=je.generateId("featureTransaction");return(r=n._editorPromiseResolve)===null||r===void 0||r.call(n),n._editorPromiseResolve=null,n.isDestroying||n.trigger("featureTransactionFinalizeStart",{id:c}),a.queue(async()=>{var g,m;s==null||s.applyStash(o),await(i==null?void 0:i()),await((g=a.commitAsync)===null||g===void 0?void 0:g.call(a)),s.isRecording&&s.stopTransaction(),!n.hasStmCapture&&s&&!s.isDestroying&&l!=null&&(s.disabled=l,s.autoRecord=d),(m=n.trigger)===null||m===void 0||m.call(n,"featureTransactionFinalized",{id:c})})}},E(t,"$name","TransactionalFeature"),t};const Ze=function(p){var t,e;return(t=this.source)!==null&&t!==void 0&&(e=t.client.features.taskEdit)!==null&&e!==void 0&&e._canceling?!1:V.getDistanceBetween(this.startEvent,p)};class oe extends ee.mixin(Ge,Ee,Te){construct(t,e){(e==null?void 0:e.showTooltip)===!1&&(e.tip=null),super.construct(...arguments)}changeValidatorFn(t){this.createValidatorFn=t}render(){const t=this,{client:e}=t;t.dragRootElement=t.dropRootElement=e.timeAxisSubGridElement,t.dragLock=e.isVertical?"y":"x"}onDragEndSwitch(t){const{client:e}=this,{enableEventAnimations:i}=e,{eventRecord:r,draggingEnd:n}=t,a=this.dragLock==="x",{initialDate:s}=this.dragging;e.enableEventAnimations=!1,r.set({startDate:s,endDate:s}),n?Object.assign(t,{endDate:s,toSet:"startDate",otherEnd:"endDate",setMethod:"setStartDate",setOtherMethod:"setEndDate",edge:a?"left":"top"}):Object.assign(t,{startDate:s,toSet:"endDate",otherEnd:"startDate",setMethod:"setEndDate",setOtherMethod:"setStartDate",edge:a?"right":"bottom"}),t.draggingEnd=this.draggingEnd=!n,e.enableEventAnimations=i}beforeDrag(t){const e=this,i=super.beforeDrag(t),{pan:r,eventDragSelect:n}=e.client.features;return i!==!1&&(e.preventMultiple&&!e.isRowEmpty(t.rowRecord)||e.disabled||r&&!r.disabled||n&&!n.disabled)?!1:(e.client.preventDragSelect=!0,i)}startDrag(t){const e=super.startDrag(t);if(e!==!1){const{context:i}=t;t.initialDate=i.eventRecord.get(this.draggingEnd?"startDate":"endDate"),this.client.trigger("dragCreateStart",{proxyElement:t.element,eventElement:t.element,eventRecord:i.eventRecord,resourceRecord:i.resourceRecord}),t.context.offset=0,t.context.oldValue=t.mousedownDate}return e}isOverEndHandle(){return this.draggingEnd}setupDragContext(t){const{client:e}=this;if(e.matchScheduleCell(t.target)){var i;const r=(i=e.resolveResourceRecord(t))===null||i===void 0?void 0:i.$original;if(r&&!r.isSpecialRow){const n=be().prototype.setupDragContext.call(this,t),a=[];return e.isVertical?a.push({element:e.scrollable.element,direction:"vertical"}):a.push({element:e.timeAxisSubGrid.scrollable.element,direction:"horizontal"}),n.scrollManager=e.scrollManager,n.monitoringConfig={scrollables:a},n.resourceRecord=n.rowRecord=r,n.getDistance=Ze,n}}}async dragDrop({context:t,event:e}){var i;t[t.toSet]=t.snappedDate;const{client:r}=this,{startDate:n,endDate:a,eventRecord:s}=t,{generation:o}=s;let l;(i=this.tip)===null||i===void 0||i.hide(),await r.project.commitAsync(),s.generation!==o&&(t.eventRecord[t.toSet]=t.oldValue,t.eventRecord[t.toSet]=t[t.toSet]),t.valid=n&&a&&a-n>0&&t[t.toSet]-t.oldValue&&t.valid!==!1,t.valid&&(r.trigger("beforeDragCreateFinalize",{context:t,event:e,proxyElement:t.element,eventElement:t.element,eventRecord:t.eventRecord,resourceRecord:t.resourceRecord}),l=!0),t.async||await t.finalize(l)}updateDragTolerance(t){this.dragThreshold=t}changeTip(t,e){return super.changeTip(!t||t.isTooltip?t:K.assign({id:`${this.client.id}-drag-create-tip`},t),e)}async finalize(t){if(this.finalized)return;this.finalized=!0;const e=this.owner,i=this,r=()=>{e.isDestroyed||(e.client.trigger("afterDragCreate",{proxyElement:i.element,eventElement:i.element,eventRecord:i.eventRecord,resourceRecord:i.resourceRecord}),e.cleanup(i))};if(t)await e.finalizeDragCreate(i),r();else{var n;await e.cancelDragCreate(i),(n=e.onAborted)===null||n===void 0||n.call(e,i),r()}}async cancelDragCreate(t){}async finalizeDragCreate(t){var e,i;await this.internalUpdateRecord(t,t.eventRecord);const r=this.getStmCapture();return(e=this.client)===null||e===void 0||e.trigger("dragCreateEnd",{eventRecord:t.eventRecord,resourceRecord:t.resourceRecord,event:t.event,eventElement:t.element,stmCapture:r}),(i=this.client)===null||i===void 0||i.trigger("eventAutoCreated",{eventRecord:t.eventRecord,resourceRecord:t.resourceRecord}),r.transferred}cleanup(t){var e;const{client:i}=this,{eventRecord:r}=t;r.meta.isResizing=!1,i.endListeningForBatchedUpdates(),(e=this.tip)===null||e===void 0||e.hide(),i.element.classList.remove(...this.dragActiveCls.split(" ")),t.element.parentElement.classList.remove("b-sch-dragcreating")}onElementContextMenu(){if(this.proxy)return!1}prepareCreateContextForFinalization(t,e,i,r=!1){return{...t,async:r,event:e,finalize:i}}onEventDataGenerated(t){var e,i;((e=this.dragging)===null||e===void 0||(i=e.context)===null||i===void 0?void 0:i.eventRecord)===t.eventRecord&&(t.wrapperCls["b-sch-dragcreating"]=!0,t.wrapperCls["b-too-narrow"]=this.dragging.context.tooNarrow)}triggerBeforeResize(){}triggerEventResizeStart(){}checkValidity(t,e){throw new Error("Implement in subclass")}handleBeforeDragCreate(t,e){throw new Error("Implement in subclass")}isRowEmpty(t){throw new Error("Implement in subclass")}}E(oe,"configurable",{showTooltip:!0,dragTolerance:2,preventMultiple:!1,dragTouchStartDelay:300,validatorFnThisObj:null,tipTemplate:t=>`
            <div class="b-sch-tip-${t.valid?"valid":"invalid"}">
                ${t.startClockHtml}
                ${t.endClockHtml}
                <div class="b-sch-tip-message">${t.message}</div>
            </div>
        `,dragActiveCls:"b-dragcreating"}),E(oe,"pluginConfig",{chain:["render","onEventDataGenerated"],before:["onElementContextMenu"]}),oe._$name="DragCreateBase";class we extends B{static get defaultConfig(){return{autoUpdate:!1,hoverDelay:250,hideDelay:100,template:null,cls:null,align:{align:"b-t"},clockTemplate:null,monitorRecordUpdate:null,testConfig:{hoverDelay:0}}}static get pluginConfig(){return{chain:["onPaint"]}}construct(t,e){const i=this;e=i.processConfig(e),super.construct(t,e),i.forSelector||(i.forSelector=`${t.eventInnerSelector}:not(.b-dragproxy,.b-iscreating)`),i.clockTemplate=new Q({scheduler:t}),t.ion({[`before${t.scheduledEventName}drag`]:()=>{var r;(r=i.tooltip)===null||r===void 0||r.hide()}})}processConfig(t){return typeof t=="function"?{template:t}:t}setConfig(t){super.setConfig(this.processConfig(t))}doDestroy(){this.destroyProperties("clockTemplate","tooltip"),super.doDestroy()}doDisable(t){this.tooltip&&(this.tooltip.disabled=t),super.doDisable(t)}onPaint({firstPaint:t}){if(t){var e;const i=this,{client:r}=i,n=`:not(${[".b-dragselecting",".b-eventeditor-editing",".b-taskeditor-editing",".b-resizing-event",".b-task-percent-bar-resizing-task",".b-dragcreating",`.b-dragging-${r.scheduledEventName}`,".b-creating-dependency",".b-dragproxy"].join()})`;(e=i.tooltip)===null||e===void 0||e.destroy();const a=i.tooltip=new _({axisLock:"flexible",id:i.tipId||`${i.client.id}-event-tip`,cls:i.tipCls,forSelector:`.b-timelinebase${n} .b-grid-body-container:not(.b-scrolling) ${i.forSelector}`,scrollAction:"realign",forElement:r.timeAxisSubGridElement,showOnHover:!0,anchorToTarget:!0,getHtml:i.getTipHtml.bind(i),disabled:i.disabled,...i.config,internalListeners:i.configuredListeners});a.ion({innerhtmlupdate:"updateDateIndicator",overtarget:"onOverNewTarget",show:"onTipShow",hide:"onTipHide",thisObj:i}),Object.keys(a.$meta.configs).forEach(s=>{Object.defineProperty(this,s,{set:o=>a[s]=o,get:()=>a[s]})})}}processConfiguredListeners(){}addListener(...t){var e;const i=super.addListener(...t),r=(e=this.tooltip)===null||e===void 0?void 0:e.addListener(...t);if(i||r)return()=>{i==null||i(),r==null||r()}}removeListener(...t){var e;super.removeListener(...t),(e=this.tooltip)===null||e===void 0||e.removeListener(...t)}updateDateIndicator(){const t=this,e=t.tooltip,i=e.element.querySelector(".b-sch-tooltip-enddate");t.record&&(t.clockTemplate.updateDateIndicator(e.element,t.record.startDate),i&&t.clockTemplate.updateDateIndicator(i,t.record.endDate))}resolveTimeSpanRecord(t){return this.client.resolveTimeSpanRecord(t)}getTipHtml({tip:t,activeTarget:e}){const i=this,{client:r}=i,n=i.recordType||`${r.scheduledEventName}Record`,a=i.resolveTimeSpanRecord(e);if((a==null?void 0:a.startDate)instanceof Date){const{startDate:s,endDate:o}=a,l=r.getFormattedDate(s),d=r.getDisplayEndDate(o,s),c=r.getFormattedDate(d);return t.eventRecord=a,i.template({tip:t,[`${n}`]:a,startDate:s,endDate:o,startText:l,endText:c,startClockHtml:i.clockTemplate.template({date:s,text:l,cls:"b-sch-tooltip-startdate"}),endClockHtml:a.isMilestone?"":i.clockTemplate.template({date:d,text:c,cls:"b-sch-tooltip-enddate"})})}else return t.hide(),""}get record(){return this.tooltip.eventRecord}onTipShow(){const t=this;t.monitorRecordUpdate&&!t.updateListener&&(t.updateListener=t.client.eventStore.ion({change:t.onRecordUpdate,buffer:300,thisObj:t}))}onTipHide(){var t;this.tooltip.eventRecord=null,(t=this.updateListener)===null||t===void 0||t.call(this),this.updateListener=null}onOverNewTarget({newTarget:t}){const{tooltip:e}=this;e.isVisible&&(this.client.timeAxisSubGrid.scrolling||this.client.scrolling?e.hide(!1):e.eventRecord=this.resolveTimeSpanRecord(t))}onRecordUpdate({record:t}){const{tooltip:e}=this;e!=null&&e.isVisible&&t===this.record&&(e.updateContent(),e.lastAlignSpec.aligningToElement?e.realign():e.internalOnPointerOver(this.client.lastPointerEvent))}}we._$name="TooltipBase";class te extends B.mixin(ge){static get defaultConfig(){return{rangeCls:"b-sch-range",lineCls:"b-sch-line",enableResizing:!1,showTooltip:!0,tooltipTemplate:null,dragTipTemplate:t=>`
                <div class="b-sch-tip-${t.valid?"valid":"invalid"}">
                    <div class="b-sch-tip-name">${U.encodeHtml(t.name)||""}</div>
                    ${t.startClockHtml}
                    ${t.endClockHtml||""}
                </div>
            `,baseCls:"b-sch-timerange",headerRenderer:null,bodyRenderer:null,cls:null,narrowThreshold:80}}construct(t,e){const i=this;super.construct(t,e),t.isVertical&&t.ion({renderRows:i.onUIReady,thisObj:i,once:!0}),i.cls=i.cls||`b-sch-${i.constructor.$$name.toLowerCase()}`,i.baseSelector=`.${i.baseCls}.${i.cls}`,i.enableResizing&&(i.showHeaderElements=!0)}doDestroy(){var t,e,i,r;const n=this;n.detachListeners("timeAxisViewModel"),n.detachListeners("timeAxis"),(t=n.clockTemplate)===null||t===void 0||t.destroy(),(e=n.tip)===null||e===void 0||e.destroy(),(i=n.drag)===null||i===void 0||i.destroy(),(r=n.resize)===null||r===void 0||r.destroy(),super.doDestroy()}doDisable(t){this.renderRanges(),super.doDisable(t)}setupTimeAxisViewModelListeners(){const t=this;t.detachListeners("timeAxisViewModel"),t.detachListeners("timeAxis"),t.client.timeAxisViewModel.ion({name:"timeAxisViewModel",update:"onTimeAxisViewModelUpdate",thisObj:t}),t.client.timeAxis.ion({name:"timeAxis",includeChange:"renderRanges",thisObj:t}),t.updateLineBuffer()}onUIReady(){const t=this,{client:e}=t;e.ion({timeAxisViewModelChange:t.setupTimeAxisViewModelListeners,thisObj:t}),t.setupTimeAxisViewModelListeners(),e.hideHeaders||(t.headerContainerElement&&V.on({click:t.onTimeRangeClick,dblclick:t.onTimeRangeClick,contextmenu:t.onTimeRangeClick,delegate:t.baseSelector,element:t.headerContainerElement,thisObj:t}),t.enableResizing&&(t.drag=De.new({name:"rangeDrag",lockX:e.isVertical,lockY:e.isHorizontal,constrain:!0,outerElement:t.headerContainerElement,targetSelector:`${t.baseSelector}`,isElementDraggable:(i,r)=>!e.readOnly&&t.isElementDraggable(i,r),rtlSource:e,internalListeners:{dragstart:"onDragStart",drag:"onDrag",drop:"onDrop",reset:"onDragReset",abort:"onInvalidDrop",thisObj:t}},t.dragHelperConfig),t.resize=We.new({direction:e.mode,targetSelector:`${t.baseSelector}.b-sch-range`,outerElement:t.headerContainerElement,isElementResizable:(i,r)=>!i.matches(".b-dragging,.b-readonly")&&!r.target.matches(".b-fa"),internalListeners:{resizestart:"onResizeStart",resizing:"onResizeDrag",resize:"onResize",cancel:"onInvalidResize",reset:"onResizeReset",thisObj:t}},t.resizeHelperConfig))),t.renderRanges(),t.tooltipTemplate&&(t.hoverTooltip=new _({forElement:t.headerContainerElement,getHtml({activeTarget:i}){const r=t.resolveTimeRangeRecord(i);return t.tooltipTemplate({timeRange:r})},forSelector:"."+t.baseCls+(t.cls?"."+t.cls:"")}))}refresh(){this._timeRanges=null,this.renderRanges()}getDOMConfig(t,e){const i=this,r=[],n=[];if(!i.disabled){i._labelRotationMap={};for(const a of i.timeRanges){const s=i.renderRange(a,t,e);s&&(r.push(s.bodyConfig),n.push(s.headerConfig))}}return[r,n]}renderRanges(){const t=this,{client:e}=t,{foregroundCanvas:i}=e;if(i&&e.isPainted&&!e.timeAxisSubGrid.collapsed){const{headerContainerElement:r}=t,n=[],[a,s]=t.getDOMConfig();t.bodyCanvas||(t.bodyCanvas=O.createElement({className:`b-timeranges-canvas ${t.cls}-canvas`,parent:i,retainElement:!0})),J.sync({targetElement:t.bodyCanvas,childrenOnly:!0,domConfig:{children:a,syncOptions:{releaseThreshold:0,syncIdField:"id"}},callback:t.showHeaderElements?null:({targetElement:o,action:l})=>{(l==="reuseElement"||l==="newElement"||l==="reuseOwnElement")&&n.push(o)}}),t.showHeaderElements&&!t.headerCanvas&&(t.headerCanvas=O.createElement({className:`${t.cls}-canvas`,parent:r,retainElement:!0})),t.headerCanvas&&J.sync({targetElement:t.headerCanvas,childrenOnly:!0,domConfig:{children:s,syncOptions:{releaseThreshold:0,syncIdField:"id"}}});for(const o of n)t.cacheRotation(o.elementData.timeRange,o);for(const o of n)t.applyRotation(o.elementData.timeRange,o)}}get timeRanges(){return[]}shouldRenderRange(t,e=this.client.visibleDateRange.startDate,i=this.client.visibleDateRange.endDate){const{timeAxis:r}=this.client,{startDate:n,endDate:a,duration:s}=t;return!!(n&&(r.isContinuous||r.isTimeSpanInAxis(t))&&M.intersectSpans(e,i,n,s?a:M.add(n,this._lineBufferDurationMS)))}getRangeDomConfig(t,e,i,r=0){const n=this,{client:a}=n,{rtl:s}=a,o=a.getCoordinateFromDate(M.max(t.startDate,e),{respectExclusion:!0})-r,l=t.endDate?a.getCoordinateFromDate(M.min(t.endDate,i),{respectExclusion:!0,isEnd:!0})-r:o,d=Math.abs(l-o),c=d>0,g=s?`calc(${o}px - 100%)`:`${o}px`;return{className:{[n.baseCls]:1,[n.cls]:n.cls,[n.rangeCls]:c,[n.lineCls]:!c,[t.cls]:t.cls,"b-narrow-range":c&&d<n.narrowThreshold,"b-readonly":t.readOnly,"b-rtl":s},dataset:{id:t.id},elementData:{timeRange:t},style:a.isVertical?`transform: translateY(${g}); ${c?`height:${d}px`:""};`:`transform: translateX(${g}); ${c?`width:${d}px`:""};`}}renderRange(t,e,i){const r=this,{client:n}=r,{timeAxis:a}=n;if(r.shouldRenderRange(t,e,i)&&a.startDate){const s=r.getRangeDomConfig(t,a.startDate,a.endDate),o=t.iconCls&&U.xss`<i class="${t.iconCls}"></i>`,l=t.name&&U.encodeHtml(t.name),d=l||o?`<label>${o||""}${l||"&nbsp;"}</label>`:"",c={...s,style:s.style+(t.style||""),html:r.bodyRenderer?r.bodyRenderer({timeRange:t}):r.showHeaderElements&&!r.showLabelInBody?"":d};let g;return r.showHeaderElements&&(g={...s,html:r.headerRenderer?r.headerRenderer({timeRange:t}):r.showLabelInBody?"":d}),{bodyConfig:c,headerConfig:g}}}cacheRotation(t,e){if(!t.iconCls&&!t.name||!t.duration)return;const i=e.firstElementChild;i&&!t.recurringTimeSpan&&(this._labelRotationMap[t.id]=this.client.isVertical?i.offsetHeight<e.offsetHeight:i.offsetWidth>e.offsetWidth)}applyRotation(t,e){var a;var i,r;const n=this._labelRotationMap[(a=(i=t.recurringTimeSpan)===null||i===void 0?void 0:i.id)!=null?a:t.id];(r=e.firstElementChild)===null||r===void 0||r.classList.toggle("b-vertical",!!n)}getBodyElementByRecord(t){const e=typeof t=="string"?t:t==null?void 0:t.id;return e!=null&&J.getChild(this.bodyCanvas,e)}resolveTimeRangeRecord(t){}get headerContainerElement(){const t=this,{isVertical:e,timeView:i,timeAxisColumn:r}=t.client;return t._headerContainerElement||(e&&i.element?t._headerContainerElement=i.element.parentElement:e||(t._headerContainerElement=r.element)),t._headerContainerElement}get showHeaderElements(){return!this.client.hideHeaders&&this._showHeaderElements}updateShowHeaderElements(t){const{client:e}=this;this.isConfiguring||(e.element.classList.toggle("b-sch-timeranges-with-headerelements",!!t),this.renderRanges())}populateTimeAxisHeaderMenu({column:t,items:e}){}onPaint({firstPaint:t}){t&&this.client.isHorizontal&&this.onUIReady()}onSchedulerHorizontalScroll(){this.client.isHorizontal&&this.renderRanges()}afterScroll(){this.client.isVertical&&this.renderRanges()}updateLineBuffer(){const{timeAxisViewModel:t}=this.client;this._lineBufferDurationMS=t.getDateFromPosition(300)-t.getDateFromPosition(0)}onInternalResize(t,e,i,r,n){this.client.isVertical&&n!==i&&this.renderRanges()}onTimeAxisViewModelUpdate(){this.updateLineBuffer(),this.refresh()}onTimeRangeClick(t){const e=this.resolveTimeRangeRecord(t.target);this.client.trigger(`timeRangeHeader${U.capitalize(t.type)}`,{event:t,domEvent:t,timeRangeRecord:e})}showTip(t){const e=this;e.showTooltip&&(e.clockTemplate=new Q({scheduler:e.client}),e.tip=new _(K.assign({id:`${e.client.id}-time-range-tip`,cls:"b-interaction-tooltip",align:"b-t",autoShow:!0,updateContentOnMouseMove:!0,forElement:t.element,getHtml:()=>e.getTipHtml(t.record,t.element)},e.showTooltip)))}destroyTip(){this.tip&&(this.tip.destroy(),this.tip=null)}isElementDraggable(t){return t=t.closest(this.baseSelector+":not(.b-resizing):not(.b-readonly)"),t&&!t.classList.contains("b-over-resize-handle")}onDragStart({context:t}){const{client:e,drag:i}=this;e.isVertical?(i.minY=0,i.maxY=e.timeAxisViewModel.totalSize-t.element.offsetHeight,i.minX=0,i.maxX=Number.MAX_SAFE_INTEGER):(i.minX=0,i.maxX=e.timeAxisViewModel.totalSize-t.element.offsetWidth,i.minY=0,i.maxY=Number.MAX_SAFE_INTEGER),e.element.classList.add("b-dragging-timerange")}onDrop({context:t}){this.client.element.classList.remove("b-dragging-timerange")}onInvalidDrop(){this.drag.reset(),this.client.element.classList.remove("b-dragging-timerange"),this.destroyTip()}updateDateIndicator({startDate:t,endDate:e}){const i=this,{tip:r}=i,n=r.element.querySelector(".b-sch-tooltip-enddate");i.clockTemplate.updateDateIndicator(r.element,t),n&&i.clockTemplate.updateDateIndicator(n,e)}onDrag({context:t}){const e=this,{client:i}=e,r=H.from(t.element),n=r.getStart(i.rtl,i.isHorizontal),a=r.getEnd(i.rtl,i.isHorizontal),s=i.getDateFromCoordinate(n,"round",!1),o=i.getDateFromCoordinate(a,"round",!1);e.updateDateIndicator({startDate:s,endDate:o})}onDragReset(){}onResizeStart(){}onResizeDrag(){}onResize(){}onInvalidResize(){}onResizeReset(){}getTipHtml(t,e){const i=this,{client:r}=i,n=H.from(e),a=n.getStart(r.rtl,r.isHorizontal),s=n.getEnd(r.rtl,r.isHorizontal),o=r.getDateFromCoordinate(a,"round",!1),l=t.endDate&&r.getDateFromCoordinate(s,"round",!1),d=r.getFormattedDate(o),c=l&&r.getFormattedEndDate(l,o);return i.dragTipTemplate({name:t.name||"",startDate:o,endDate:l,startText:d,endText:c,startClockHtml:i.clockTemplate.template({date:o,text:d,cls:"b-sch-tooltip-startdate"}),endClockHtml:c&&i.clockTemplate.template({date:l,text:c,cls:"b-sch-tooltip-enddate"})})}}E(te,"configurable",{showHeaderElements:!0}),E(te,"pluginConfig",{chain:["onPaint","populateTimeAxisHeaderMenu","onSchedulerHorizontalScroll","afterScroll","onInternalResize"]}),te._$name="AbstractTimeRanges";const Ke=Object.freeze({});class me extends B.mixin(se,ge){static get $name(){return"ColumnLines"}static get delayable(){return{refresh:{type:"raf",cancelOutstanding:!0}}}static get pluginConfig(){return{after:["render","updateCanvasSize","onVisibleDateRangeChange","onVisibleResourceRangeChange"]}}construct(t,e){t.useBackgroundCanvas=!0,super.construct(t,e)}attachToResourceStore(t){const{client:e}=this;super.attachToResourceStore(t),e.isVertical&&e.resourceStore.ion({name:"resourceStore",group({groupers:i}){i.length===0&&this.refresh()},thisObj:this})}doDisable(t){super.doDisable(t),this.isConfiguring||this.refresh()}render(){this.refresh()}getColumnLinesDOMConfig(t,e){const i=this,{client:r}=i,{rtl:n}=r,a=n?-1:1,{timeAxisViewModel:s,isHorizontal:o,resourceStore:l,variableColumnWidths:d}=r,{columnConfig:c}=s,g=s.columnLinesFor,m=Math.max(g-1,0),f=t.getTime(),h=e.getTime(),u=[],v=new Set,b=o?"X":"Y";if(!i.disabled){const w=(y,T)=>{const x=y.start.getTime();x>f&&x<h&&!v.has(x)&&(v.add(x),u.push({role:"presentation",className:T?"b-column-line-major":"b-column-line",style:{transform:`translate${b}(${y.coord*a}px)`},dataset:{line:T?`major-${y.index}`:`line-${y.index}`}}))};if(g!==m)for(let y=1;y<=c[m].length-1;y++)w(c[m][y],!0);for(let y=1;y<=c[g].length-1;y++)w(c[g][y],!1);if(!o&&r.columnLines){const{columnWidth:y}=r.resourceColumns;let{first:T,last:x}=r.currentOrientation.getResourceRange(!0),A=0;if(T>-1)for(let R=T;R<x+1;R++){var D,C;const z=l.getAt(R);if(z.isGroupHeader){x++,A++;continue}const S=z.instanceMeta(l),k=d?S.insetStart+z.columnWidth-1:(R-A+1)*y-1;u.push({className:{"b-column-line":1,"b-resource-column-line":1,"b-resource-group-divider":l.isGrouped&&((D=S.groupParent)===null||D===void 0?void 0:D.groupChildren[((C=S.groupParent)===null||C===void 0?void 0:C.groupChildren.length)-1])===z},style:{transform:`translateX(${k*a}px)`},dataset:{line:`resource-${R}`}})}}}return u}refresh(){const t=this,{client:e}=t,{timeAxis:i}=e,{startDate:r,endDate:n}=e.visibleDateRange||Ke;if(!i.startDate||!r||t.client.timeAxisSubGrid.collapsed)return;t.element||(t.element=O.createElement({parent:e.backgroundCanvas,className:"b-column-lines-canvas"}));const s=t.getColumnLinesDOMConfig(r,n);J.sync({targetElement:t.element,onlyChildren:!0,domConfig:{children:s,syncOptions:{releaseThreshold:4}},syncIdField:"line"})}onVisibleDateRangeChange(){this.refresh()}onVisibleResourceRangeChange({firstResource:t,lastResource:e}){this.refresh()}updateCanvasSize(){this.refresh()}}me._$name="ColumnLines",P.registerFeature(me,!0,["Scheduler","Gantt","TimelineHistogram"]);var Re=p=>class extends(p||ae){static get $name(){return"DependencyCreation"}static get defaultConfig(){return{allowDropOnEventBar:!0,showCreationTooltip:!0,creationTooltip:null,terminalCls:"b-sch-terminal",terminalSides:["start","top","end","bottom"],allowCreate:!0}}construct(e,i){super.construct(e,i);const r=this;r.view=e,r.eventName=e.scheduledEventName,e.ion({readOnly:()=>r.updateCreateListeners()}),r.updateCreateListeners(),r.chain(e,"onElementTouchMove","onElementTouchMove")}doDestroy(){var e,i;const r=this;r.detachListeners("view"),r.creationData=null,(e=r.pointerUpMoveDetacher)===null||e===void 0||e.call(r),(i=r.creationTooltip)===null||i===void 0||i.destroy(),super.doDestroy()}updateCreateListeners(){const e=this;e.view&&(e.detachListeners("view"),e.isCreateAllowed&&e.view.ion({name:"view",[`${e.eventName}mouseenter`]:"onTimeSpanMouseEnter",[`${e.eventName}mouseleave`]:"onTimeSpanMouseLeave",thisObj:e}))}set allowCreate(e){this._allowCreate=e,this.updateCreateListeners()}get allowCreate(){return this._allowCreate}get isCreateAllowed(){return this.allowCreate&&!this.view.readOnly&&!this.disabled}onTimeSpanMouseEnter({event:e,source:i,[`${this.eventName}Record`]:r,[`${this.eventName}Element`]:n}){if(!r.isCreating&&!r.readOnly&&(!this.client.features.nestedEvents||r.parent.isRoot)){const a=this,{creationData:s}=a,o=O.down(n,i.eventInnerSelector);r!==(s==null?void 0:s.source)&&(a.showTerminals(r,o),s&&e.target.closest(a.client.eventSelector)&&(s.timeSpanElement=o,a.onOverTargetEventBar(e)))}}onTimeSpanMouseLeave(e){var i;const r=this,{creationData:n}=r,a=e[`${r.eventName}Element`],s=O.down(a,r.view.eventInnerSelector),o=(i=e.event)===null||i===void 0?void 0:i.relatedTarget,l=n==null?void 0:n.timeSpanElement;o&&((!n||!l||!o||!O.isDescendant(l,o))&&(e.event.isTrusted||s!==(n==null?void 0:n.sourceElement))&&r.hideTerminals(a),n&&!n.finalizing&&!o.closest(r.client.eventSelector)&&(n.timeSpanElement=null,r.onOverNewTargetWhileCreating(void 0,void 0,e)))}onTerminalMouseOver(e){this.creationData&&this.onOverTargetEventBar(e)}onTerminalMouseOut(e){const i=this,{creationData:r}=i,n=e.target.closest(i.view.eventSelector);n&&(!i.showingTerminalsFor||!O.isDescendant(n,i.showingTerminalsFor))&&(!r||n!==r.timeSpanElement)&&(i.hideTerminals(n),i.view.unhover(n,e)),r&&i.onOverNewTargetWhileCreating(e.relatedTarget,r.target,e)}onTerminalPointerDown(e){const i=this;if(e.button===0&&!i.creationData){var r;const n=i.view,a=n.timeAxisSubGridElement,s=e.target,o=s.closest(n.eventInnerSelector),l=H.from(n.element,document.body);e.stopPropagation(),i.creationData={sourceElement:o,source:n.resolveTimeSpanRecord(o).$original,fromSide:s.dataset.side,startPoint:H.from(s,a).center,startX:e.pageX-l.x+n.scrollLeft,startY:e.pageY-l.y+n.scrollTop,valid:!1,sourceResource:(r=n.resolveResourceRecord)===null||r===void 0?void 0:r.call(n,e),tooltip:i.creationTooltip},i.pointerUpMoveDetacher=V.on({pointerup:{element:n.element.getRootNode(),handler:"onMouseUp",passive:!1},pointermove:{element:a,handler:"onMouseMove",passive:!1},thisObj:i}),i.documentPointerUpDetacher=V.on({pointerup:{element:document,handler:"onDocumentMouseUp"},keydown:{element:document,handler:({key:d})=>{d==="Escape"&&i.abort()}},thisObj:i})}}onElementTouchMove(e){var i;(i=super.onElementTouchMove)===null||i===void 0||i.call(this,e),this.connector&&e.preventDefault()}onMouseMove(e){const i=this,{view:r,creationData:n}=i,a=H.from(r.element,document.body),s=e.pageX-a.x+r.scrollLeft-n.startX,o=e.pageY-a.y+r.scrollTop-n.startY,l=Math.round(Math.sqrt(s*s+o*o))-3,d=Math.atan2(o,s);let{connector:c}=i;if(!c){if(i.onRequestDragCreate(e)===!1)return;c=i.connector}c.style.width=`${l}px`,c.style.transform=`rotate(${d}rad)`,i.lastMouseMoveEvent=e}onRequestDragCreate(e){const i=this,{view:r,creationData:n}=i;if(r.trigger("beforeDependencyCreateDrag",{data:n,source:n.source})===!1)return i.abort(),!1;if(r.element.classList.add("b-creating-dependency"),i.createConnector(n.startPoint.x,n.startPoint.y),r.trigger("dependencyCreateDragStart",{data:n,source:n.source}),i.showCreationTooltip){const a=i.creationTooltip||(i.creationTooltip=i.createDragTooltip());i.creationData.tooltip=a,a.disabled=!1,a.show(),a.onMouseMove(e)}r.scrollManager.startMonitoring({scrollables:[{element:r.timeAxisSubGrid.scrollable.element,direction:"horizontal"},{element:r.scrollable.element,direction:"vertical"}],callback:()=>i.lastMouseMoveEvent&&i.onMouseMove(i.lastMouseMoveEvent)})}onOverTargetEventBar(e){var i;const r=this,{view:n,creationData:a,allowDropOnEventBar:s}=r,{target:o}=e;let l=n.resolveTimeSpanRecord(o).$original;(i=l)!==null&&i!==void 0&&i.isEventSegment&&(l=l.event),!(N.isPromise(a.valid)||!s&&!o.classList.contains(r.terminalCls))&&l!==a.source&&r.onOverNewTargetWhileCreating(o,l,e)}async onOverNewTargetWhileCreating(e,i,r){const n=this,{view:a,creationData:s,allowDropOnEventBar:o,connector:l}=n;if(!N.isPromise(s.valid)&&!s.finalizing&&l){if(l.classList.remove("b-valid","b-invalid"),s.timeSpanElement&&O.removeClsGlobally(s.timeSpanElement,"b-sch-terminal-active"),!i||i===s.source||!o&&!e.classList.contains(n.terminalCls))s.target=s.toSide=null,s.valid=!1,l.classList.add("b-invalid");else{var d,c;const g=s.target=i,{source:m}=s;let f=e.dataset.side;o&&!e.classList.contains(n.terminalCls)&&(f=n.getTargetSideFromType(n.dependencyStore.modelClass.fieldMap.type.defaultValue||G.Type.EndToStart)),a.resolveResourceRecord&&(s.targetResource=a.resolveResourceRecord(r));let h;s.toSide=f;const u=s.fromSide,v=C=>{n.isDestroyed||(s.valid=C,e.classList.add(C?"b-valid":"b-invalid"),l.classList.add(C?"b-valid":"b-invalid"),a.trigger("dependencyValidationComplete",{data:s,source:m,target:g,dependencyType:h}))};switch(!0){case(u==="start"&&f==="start"):h=G.Type.StartToStart;break;case(u==="start"&&f==="end"):h=G.Type.StartToEnd;break;case(u==="end"&&f==="start"):h=G.Type.EndToStart;break;case(u==="end"&&f==="end"):h=G.Type.EndToEnd;break}a.trigger("dependencyValidationStart",{data:s,source:m,target:g,dependencyType:h});let b=s.valid=n.dependencyStore.isValidDependency(m,g,h);N.isPromise(b)&&(b=await b),v(b);const D=b?"b-valid":"b-invalid";l.classList.add(D),(d=s.timeSpanElement)===null||d===void 0||(c=d.querySelector(`.b-sch-terminal[data-side=${f}]`))===null||c===void 0||c.classList.add("b-sch-terminal-active",D)}n.updateCreationTooltip()}}async onMouseUp(){var e;const i=this,r=i.creationData;if(r.finalizing=!0,(e=i.pointerUpMoveDetacher)===null||e===void 0||e.call(i),r.valid)if(await i.view.trigger("beforeDependencyCreateFinalize",r)===!1?r.valid=!1:N.isPromise(r.valid)&&(r.valid=await r.valid),r.valid){let a=i.createDependency(r);a!==null&&(N.isPromise(a)&&(a=await a),r.dependency=a,i.view.trigger("dependencyCreateDrop",{data:r,source:r.source,target:r.target,dependency:a}),i.doAfterDependencyDrop(r))}else i.doAfterDependencyDrop(r);else r.valid=!1,i.doAfterDependencyDrop(r);i.abort()}doAfterDependencyDrop(e){this.view.trigger("afterDependencyCreateDrop",{data:e,...e})}onDocumentMouseUp({target:e}){this.view.timeAxisSubGridElement.contains(e)||this.abort()}abort(){var e,i;const r=this,{view:n,creationData:a}=r;if(a){const{source:s,sourceResource:o,target:l,targetResource:d}=a;if(s){const c=n.getElementFromEventRecord(s,o);c&&r.hideTerminals(c)}if(l){const c=n.getElementFromEventRecord(l,d);c&&r.hideTerminals(c)}}r.creationTooltip&&(r.creationTooltip.disabled=!0),r.creationData=r.lastMouseMoveEvent=null,(e=r.pointerUpMoveDetacher)===null||e===void 0||e.call(r),(i=r.documentPointerUpDetacher)===null||i===void 0||i.call(r),r.removeConnector()}createConnector(e,i){const r=this,{view:n}=r;r.clearTimeout(r.removeConnectorTimeout),r.connector=O.createElement({parent:n.timeAxisSubGridElement,className:`${r.baseCls}-connector`,style:`left:${e}px;top:${i}px`}),n.element.classList.add("b-creating-dependency")}createDragTooltip(){const e=this,{view:i}=e;return e.creationTooltip=_.new({id:`${i.id}-dependency-drag-tip`,cls:"b-sch-dependency-creation-tooltip",loadingMsg:"",anchorToTarget:!1,forElement:i.timeAxisSubGridElement,trackMouse:!0,constrainTo:null,header:{dock:"right"},internalListeners:{beforeShow:"updateCreationTooltip",thisObj:e}},e.creationTooltip)}removeConnector(){const e=this,{connector:i,view:r}=e;i&&(i.classList.add("b-removing"),i.style.width="0",e.removeConnectorTimeout=e.setTimeout(()=>{i.remove(),e.connector=null},200)),r.element.classList.remove("b-creating-dependency"),e.creationTooltip&&e.creationTooltip.hide(),r.scrollManager.stopMonitoring()}showTerminals(e,i){const r=this;if(!r.isCreateAllowed||!e.project)return;const n=r.terminalCls,a=`${n}s-visible`;if(i=O.down(i,r.view.eventInnerSelector),!i.classList.contains(a)&&!r.view.element.classList.contains("b-resizing-event")&&!r.view.readOnly){if(r.client.trigger("beforeShowTerminals",{source:e})===!1)return;r.terminalSides.forEach(s=>{s=r.fixSide(s);const o=O.createElement({parent:i,className:`${n} ${n}-${s}`,dataset:{side:s,feature:!0}});o.detacher=V.on({element:o,mouseover:"onTerminalMouseOver",mouseout:"onTerminalMouseOut",pointerdown:{handler:"onTerminalPointerDown",capture:!0},thisObj:r})}),i.classList.add(a),e.internalCls.add(a),r.showingTerminalsFor=i}}fixSide(e){return e==="left"?"start":e==="right"?"end":e}hideTerminals(e){const i=this,r=i.client.getTimeSpanMouseEventParams(e),n=r==null?void 0:r[`${i.eventName}Record`],a=`${i.terminalCls}s-visible`;O.forEachSelector(e,`.${i.terminalCls}`,s=>{s.detacher&&s.detacher(),s.remove()}),O.down(e,i.view.eventInnerSelector).classList.remove(a),n.internalCls.remove(a),i.showingTerminalsFor=null}createDependency(e){const{source:i,target:r,fromSide:n,toSide:a}=e,s=(n==="start"?0:2)+(a==="end"?1:0),o=this.dependencyStore.add({from:i.id,to:r.id,type:s,fromSide:n,toSide:a});return o!==null?o[0]:null}getTargetSideFromType(e){return e===G.Type.StartToStart||e===G.Type.EndToStart?"start":"end"}updateCreationTooltip(){const e=this,i=e.creationData,{valid:r}=i,n=e.creationTooltip,{classList:a}=n.element;if(N.isPromise(r))return a.remove("b-invalid"),a.add("b-checking"),new Promise(s=>r.then(o=>{i.valid=o,n.isDestroyed||s(e.updateCreationTooltip())}));n.html=e.creationTooltipTemplate(i)}creationTooltipTemplate(e){var d;var i;const r=this,{tooltip:n,valid:a}=e,{classList:s}=n.element;Object.assign(e,{fromText:U.encodeHtml(e.source.name),toText:U.encodeHtml((d=(i=e.target)===null||i===void 0?void 0:i.name)!=null?d:""),fromSide:e.fromSide,toSide:e.toSide||""});let o,l;return s.toggle("b-invalid",!a),s.remove("b-checking"),a===!0?(o="valid",l=r.L("L{Dependencies.valid}")):(o="invalid",l=r.L("L{Dependencies.invalid}")),n.title=`<i class="b-icon b-icon-${o}"></i>${l}`,{children:[{className:"b-sch-dependency-tooltip",children:[{dataset:{ref:"fromLabel"},tag:"label",text:r.L("L{Dependencies.from}")},{dataset:{ref:"fromText"},text:e.fromText},{dataset:{ref:"fromBox"},className:`b-sch-box b-${e.fromSide}`},{dataset:{ref:"toLabel"},tag:"label",text:r.L("L{Dependencies.to}")},{dataset:{ref:"toText"},text:e.toText},{dataset:{ref:"toBox"},className:`b-sch-box b-${e.toSide}`}]}]}}doDisable(e){this.isConfiguring||this.updateCreateListeners(),super.doDisable(e)}};const le=25;var Je=p=>{var t;return t=class extends p{constructor(){super(...arguments);E(this,"gridCache",null)}getDependenciesToConsider(r,n,a,s){const o=this,{gridCache:l}=o,{timeAxis:d}=o.client;if(l){const c=new Set,g=Math.floor((r-d.startMS)/o.MS_PER_CELL),m=Math.floor((n-d.startMS)/o.MS_PER_CELL),f=Math.floor(a/le),h=Math.floor(s/le);for(let u=g;u<=m;u++){const v=l[u];if(v)for(let b=f;b<=h;b++){const D=v[b];if(D)for(let C=0;C<D.length;C++)c.add(D[C])}}return c}}afterDrawDependency(r,n,a,s,o){var d,c;const l=this;if(l.constructGridCache){const{MS_PER_CELL:g}=l,{startMS:m,endMS:f}=l.client.timeAxis,h=Math.ceil((f-m)/g),u=Math.floor((s-m)/g),v=Math.floor((o-m)/g),b=Math.floor(n/le),D=Math.floor(a/le),C=Math.min(u,v),w=Math.max(u,v),y=Math.min(b,D),T=Math.max(b,D);if(C<0&&w<0||C>h&&w>h)return;const x=Math.max(C,0),A=Math.min(w,h);for(let R=x;R<=A;R++){const z=(d=l.gridCache[R])!=null?d:l.gridCache[R]={};for(let S=y;S<=T;S++)((c=z[S])!=null?c:z[S]=[]).push(r)}}}beforeDraw(){const r=this;if(!r.gridCache){const{visibleDateRange:n}=r.client;r.constructGridCache=!0,r.MS_PER_CELL=Math.max(n.endMS-n.startMS,1e3),r.gridCache={}}}afterDraw(){this.constructGridCache=!1}reset(){this.gridCache=null}},E(t,"$name","DependencyGridCache"),t};const Qe=Math.min(1/globalThis.devicePixelRatio,.75),et=["start","end","top","bottom"],W=(p,t)=>Math.abs(p-t)<.1;class X extends ae{static get configurable(){return{startSide:"right",startArrowMargin:12,startShift:0,endSide:"left",endArrowMargin:12,endShift:0,verticalMargin:2,horizontalMargin:5,otherBoxes:null,client:{}}}findPath(t,e){const i=this,r=t;let n,a,s,o,l,d,c,g,m,f,h,u,v,b,D,C,w,y,T,x,A,R,z,S,k,L,I,$,F;for(e=Be.asArray(e),F=0;t&&!$;){if(n=Object.assign(i.config,t),a=n.startBox,s=n.endBox,o=n.startShift,l=n.endShift,d=n.startSide,c=n.endSide,g=n.startArrowMargin,m=n.endArrowMargin,f=n.horizontalMargin,h=n.verticalMargin,u=n.hasOwnProperty("startHorizontalMargin")?n.startHorizontalMargin:f,v=n.hasOwnProperty("startVerticalMargin")?n.startVerticalMargin:h,b=n.hasOwnProperty("endHorizontalMargin")?n.endHorizontalMargin:f,D=n.hasOwnProperty("endVerticalMargin")?n.endVerticalMargin:h,C=n.hasOwnProperty("otherHorizontalMargin")?n.otherHorizontalMargin:f,w=n.hasOwnProperty("otherVerticalMargin")?n.otherVerticalMargin:h,y=n.otherBoxes,d=i.normalizeSide(d),c=i.normalizeSide(c),T=i.getConnectionCoordinatesFromBoxSideShift(a,d,o),x=i.getConnectionCoordinatesFromBoxSideShift(s,c,l),k=i.calcGridBaseBoxFromBoxAndDrawParams(a,d,g,u,v),L=i.calcGridBaseBoxFromBoxAndDrawParams(s,c,m,b,D),et.forEach(Y=>{Math.abs(k[Y]-L[Y])<=Qe&&(L[Y]=k[Y])}),i.shouldLookForPath(a,s,k,L)){var ce;y=(ce=y)===null||ce===void 0?void 0:ce.map(Y=>i.calcGridBaseBoxFromBoxAndDrawParams(Y,!1,0,C,w)),A=i.getConnectionCoordinatesFromBoxSideShift(k,d,o),R=i.getConnectionCoordinatesFromBoxSideShift(L,c,l),I=i.buildPathGrid(k,L,A,R,d,c,y),z=i.convertDecartPointToGridPoint(I,A),S=i.convertDecartPointToGridPoint(I,R),$=i.findPathOnGrid(I,z,S,d,c)}for(t=!1;!$&&!t&&e&&F<e.length;F++)t=e[F](n,r)}return $&&($=i.prependPathWithArrowStaffSegment($,T,d),$=i.appendPathWithArrowStaffSegment($,x,c),$=i.optimizePath($)),$}static calculateRelativePosition(t,e,i=!1){const r=i?"top":"start",n=i?"bottom":"end";let a;return t[n]<e[r]?a=0:t[n]<=e[n]&&t[n]>=e[r]&&t[r]<e[r]?a=1:t[r]>=e[r]&&t[n]<=e[n]?a=2:t[r]<e[r]&&t[n]>e[n]?a=-2:t[r]<=e[n]&&t[n]>e[n]?a=3:a=4,a}static boxOverlapChanged(t,e,i,r,n=!1){const a=X.calculateRelativePosition,s=a(t,e,n),o=a(i,r,n);return s!==o}shouldLookForPath(t,e,i,r){let n=!0;return(t.end-t.start<=this.startArrowMargin||e.end-e.start<=this.endArrowMargin)&&Math.abs(X.calculateRelativePosition(t,e,!0))===2&&(n=!X.boxOverlapChanged(t,e,i,r)),n}getConnectionCoordinatesFromBoxSideShift(t,e,i){let r;switch(e){case"left":r={x:t.start,y:(t.top+t.bottom)/2+i};break;case"right":r={x:t.end,y:(t.top+t.bottom)/2+i};break;case"top":r={x:(t.start+t.end)/2+i,y:t.top};break;case"bottom":r={x:(t.start+t.end)/2+i,y:t.bottom};break}return r}calcGridBaseBoxFromBoxAndDrawParams(t,e,i,r,n){let a;switch(this.normalizeSide(e)){case"left":a={start:t.start-Math.max(i,r),end:t.end+r,top:t.top-n,bottom:t.bottom+n};break;case"right":a={start:t.start-r,end:t.end+Math.max(i,r),top:t.top-n,bottom:t.bottom+n};break;case"top":a={start:t.start-r,end:t.end+r,top:t.top-Math.max(i,n),bottom:t.bottom+n};break;case"bottom":a={start:t.start-r,end:t.end+r,top:t.top-n,bottom:t.bottom+Math.max(i,n)};break;default:a={start:t.start-r,end:t.end+r,top:t.top-n,bottom:t.bottom+n}}return a}normalizeSide(t){const{rtl:e}=this.client;return t==="start"?e?"right":"left":t==="end"?e?"left":"right":t}buildPathGrid(t,e,i,r,n,a,s){let o,l,d,c,g,m,f,h,u,v,b,D,C;const w={},y=[];for(o=[t.start,n==="left"||n==="right"?(t.start+t.end)/2:i.x,t.end,e.start,a==="left"||a==="right"?(e.start+e.end)/2:r.x,e.end],l=[t.top,n==="top"||n==="bottom"?(t.top+t.bottom)/2:i.y,t.bottom,e.top,a==="top"||a==="bottom"?(e.top+e.bottom)/2:r.y,e.bottom],s&&s.forEach(T=>{o.push(T.start,(T.start+T.end)/2,T.end),l.push(T.top,(T.top+T.bottom)/2,T.bottom)}),o=[...new Set(o.sort((T,x)=>T-x))],l=[...new Set(l.sort((T,x)=>T-x))],m=0,h=l.length;m<h;++m)for(w[m]=w[m]||{},d=l[m],g=0,f=o.length;g<f;++g){if(c=o[g],D=(c<=t.start||c>=t.end||d<=t.top||d>=t.bottom)&&(c<=e.start||c>=e.end||d<=e.top||d>=e.bottom),s)for(u=0,v=s.length;D&&u<v;++u)b=s[u],D=c<=b.start||c>=b.end||d<=b.top||d>=b.bottom||c===i.x&&d===i.y||c===r.x&&d===r.y;C={distance:Number.MAX_SAFE_INTEGER,permitted:D,x:c,y:d,ix:g,iy:m},w[m][g]=C,y.push(C)}return{width:o.length,height:l.length,xs:o,ys:l,points:w,linearPoints:y}}convertDecartPointToGridPoint(t,e){const i=t.xs.indexOf(e.x),r=t.ys.indexOf(e.y);return t.points[r][i]}findPathOnGrid(t,e,i,r,n){const a=this;let s=!1;return e.permitted&&i.permitted&&(t=a.waveForward(t,e,0),s=a.collectPath(t,i,n)),s}getGridPointNeighbors(t,e,i){const r=e.ix,n=e.iy,a=[];let s;return n<t.height-1&&(s=t.points[n+1][r],(!i||i(s))&&a.push(s)),n>0&&(s=t.points[n-1][r],(!i||i(s))&&a.push(s)),r<t.width-1&&(s=t.points[n][r+1],(!i||i(s))&&a.push(s)),r>0&&(s=t.points[n][r-1],(!i||i(s))&&a.push(s)),a}waveForward(t,e,i){const r=this;return Ne.preWalkUnordered([e,i],([n,a])=>r.getGridPointNeighbors(t,n,s=>s.permitted&&s.distance>a+1).map(s=>[s,a+1]),([n,a])=>n.distance=a),t}collectPath(t,e,i){const r=this,n=[];let a=!0,s,o,l,d;for(;a&&e.distance;)if(s=r.getGridPointNeighbors(t,e,c=>c.permitted&&c.distance===e.distance-1),a=s.length>0,a){switch(s=s.sort((c,g)=>{let m,f;m=c.ix-e.ix,f=c.iy-e.iy;const h=(i==="left"||i==="right")&&f===0||(i==="top"||i==="bottom")&&m===0?-1:1;m=g.ix-e.ix,f=g.iy-e.iy;const u=(i==="left"||i==="right")&&f===0||(i==="top"||i==="bottom")&&m===0?-1:1;if(h>u)return 1;if(h<u)return-1;if(h===u)return c.y>g.y?-1:1}),o=s[0],n.push({x1:o.x,y1:o.y,x2:e.x,y2:e.y}),l=o.ix-e.ix,d=o.iy-e.iy,!0){case(!d&&l>0):i="left";break;case(!d&&l<0):i="right";break;case(!l&&d>0):i="top";break;case(!l&&d<0):i="bottom";break}e=o}return a&&n.reverse()||!1}prependPathWithArrowStaffSegment(t,e,i){if(t.length>0){const r=t[0],n={x2:r.x1,y2:r.y1};switch(i){case"left":n.x1=e.x,n.y1=r.y1;break;case"right":n.x1=e.x,n.y1=r.y1;break;case"top":n.x1=r.x1,n.y1=e.y;break;case"bottom":n.x1=r.x1,n.y1=e.y;break}t.unshift(n)}return t}appendPathWithArrowStaffSegment(t,e,i){if(t.length>0){const r=t[t.length-1],n={x1:r.x2,y1:r.y2};switch(i){case"left":n.x2=e.x,n.y2=r.y2;break;case"right":n.x2=e.x,n.y2=r.y2;break;case"top":n.x2=r.x2,n.y2=e.y;break;case"bottom":n.x2=r.x2,n.y2=e.y;break}t.push(n)}return t}optimizePath(t){const e=[];let i,r;if(t.length>0)for(i=t.shift(),e.push(i);t.length>0;)r=t.shift(),W(i.x1,r.x1)&&W(i.y1,r.y1)&&W(i.x2,r.x2)&&W(i.y2,r.y2)?i=r:W(i.y1,i.y2)&&W(r.y1,r.y2)?i.x2=r.x2:W(i.x1,i.x2)&&W(r.x1,r.x2)?i.y2=r.y2:(e.push(r),i=r);return e}}X._$name="RectangularPathFinder";function Me(p){return p.x1===p.x2?p.y2>p.y1?"d":"u":p.x2>p.x1?"r":"l"}function fe(p){return p.x1===p.x2?p.y2-p.y1:p.x2-p.x1}function tt(p,t,e){const i=Me(p)+Me(t),r=e*(i.includes("l")?-1:1),n=e*(i.includes("u")?-1:1);return`a${r},${n} 0 0 ${i==="ur"||i==="lu"||i==="dl"||i==="rd"?1:0} ${r},${n}`}function it(p,t,e,i,r){let n=p.x1===p.x2?"v":"h",a=i;if(i){const s=fe(p),o=t?Math.abs(fe(t)):Number.MAX_SAFE_INTEGER,l=Math.sign(s);r==null&&(r=i),(Math.abs(s)<i*2||o<i*2)&&(a=Math.min(Math.abs(s),o)/2);const d=e==="single"?0:e==="first"?a:e==="between"?r+a:r,c=s-d*l;n+=Math.sign(c)!==l?0:c,e!=="last"&&e!=="single"&&a>0&&(n+=` ${tt(p,t,a)}`)}else n+=fe(p);return{line:n,currentRadius:i!==a?a:null}}function rt(p,t){const{length:e}=t;if(!e)return"";let i=null;return`M${t[0].x1},${t[0].y1} ${t.map((r,n)=>{const a=e===1?"single":n===e-1?"last":n===0?"first":"between",s=it(r,t[n+1],a,p,i);return{currentRadius:i}=s,s.line}).join(" ")}`}var nt=p=>{var t;return t=class extends p{constructor(){super(...arguments);E(this,"lineCache",{})}onSVGReady(){const r=this;r.pathFinder=new X({...r.pathFinderConfig,client:r.client}),r.lineDefAdjusters=r.createLineDefAdjusters(),r.createMarker()}changeRadius(r){return r!==null&&K.assertNumber(r,"radius"),r}updateRadius(){this.isConfiguring||this.reset()}updateRenderer(){this.isConfiguring||this.reset()}changeClickWidth(r){return r!==null&&K.assertNumber(r,"clickWidth"),r}updateClickWidth(){this.isConfiguring||this.reset()}createMarker(){var l;var r;const n=this,{markerDef:a}=n,s=this.client.svgCanvas,o=a?`${n.client.id}-arrowEnd`:"arrowEnd";(r=n.marker)===null||r===void 0||r.remove(),s.style.setProperty("--scheduler-dependency-marker",`url(#${o})`),n.marker=O.createElement({parent:s,id:o,tag:"marker",className:"b-sch-dependency-arrow",ns:"http://www.w3.org/2000/svg",markerHeight:11,markerWidth:11,refX:8.5,refY:3,viewBox:"0 0 9 6",orient:"auto-start-reverse",markerUnits:"userSpaceOnUse",retainElement:!0,children:[{tag:"path",ns:"http://www.w3.org/2000/svg",d:(l=n.markerDef)!=null?l:"M3,0 L3,6 L9,3 z"}]})}updateMarkerDef(){this.isConfiguring||this.createMarker()}getAssignmentElement(r){var n,a;return((n=this.client.features.eventDrag)===null||n===void 0||(a=n.getProxyElement)===null||a===void 0?void 0:a.call(n,r))||this.client.getElementFromAssignmentRecord(r)}getDomConfigs(r,n,a,s){var g;const o=this,l=o.getDependencyKey(r,n,a),d=o.lineCache[l];if(o.constructLineCache||!d||s||o.drawingLive&&(o.getAssignmentElement(n)||o.getAssignmentElement(a))){const m=o.prepareLineDef(r,n,a,s),f=m&&o.pathFinder.findPath(m,o.lineDefAdjusters),{client:h,clickWidth:u}=o,{toEvent:v}=r;if(f){var c;const b=o.highlighted.get(r),D={tag:"path",ns:"http://www.w3.org/2000/svg",d:rt((g=o.radius)!=null?g:0,f),role:"presentation",dataset:{syncId:l,depId:r.id,fromId:n.id,toId:a.id},elementData:{dependency:r,points:f},class:{[o.baseCls]:1,[r.cls]:r.cls,[r.highlighted]:r.highlighted,[b&&[...b].join(" ")]:b,[o.noMarkerCls]:m.hideMarker,"b-inactive":r.active===!1,"b-sch-bidirectional-line":r.bidirectional,"b-readonly":r.readOnly,"b-sch-dependency-ends-outside":!v.milestone&&(v.endDate<=h.startDate||h.endDate<=v.startDate)||v.milestone&&(v.endDate<h.startDate||h.endDate<v.startDate)}};(c=o.renderer)===null||c===void 0||c.call(o,{domConfig:D,points:f,dependencyRecord:r,fromAssignmentRecord:n,toAssignmentRecord:a,fromBox:m.startBox,toBox:m.endBox,fromSide:m.startSide,toSide:m.endSide});const C=[D];return u>1&&C.push({...D,class:{...D.class,"b-click-area":1},dataset:{...D.dataset,syncId:`${D.dataset.syncId}-click-area`},style:{strokeWidth:u}}),o.lineCache[l]=C}return o.lineCache[l]=null}return d}generateBoundaryBoxes(r,n){return n==="bottom"?[{start:r.left,end:r.left+r.width/2,top:r.rowTop,bottom:r.rowBottom},{start:r.left+r.width/2,end:r.right,top:r.rowTop,bottom:r.rowBottom}]:[{start:r.left-this.pathFinder.startArrowMargin,end:r.right+this.pathFinder.startArrowMargin,top:r.rowTop,bottom:r.rowBottom}]}getAssignmentBounds(r){const{client:n}=this,a=this.getAssignmentElement(r);if(a&&!n.isExporting){const s=H.from(a,this.relativeTo);if(n.isHorizontal){let o=n.getRowById(r.resource.id);if(s.y<o.top||s.bottom>o.bottom){const l=n.rowManager.getRowAt(s.center.y,!0);l&&(o=l)}s.rowTop=o.top,s.rowBottom=o.bottom}return s}return n.isEngineReady&&n.getAssignmentEventBox(r,!0)}getConnectorStartSide(r){return this.client.currentOrientation.getConnectorStartSide(r)}getConnectorEndSide(r){return this.client.currentOrientation.getConnectorEndSide(r)}getDependencyStartSide(r){const{fromEvent:n,type:a,fromSide:s}=r;if(s)return s;switch(!0){case a===j.Type.StartToEnd:case a===j.Type.StartToStart:return this.getConnectorStartSide(n);case a===j.Type.EndToStart:case a===j.Type.EndToEnd:return this.getConnectorEndSide(n);default:return this.getConnectorEndSide(n)}}getDependencyEndSide(r){const{toEvent:n,type:a,toSide:s}=r;if(s)return s;switch(!0){case a===j.Type.EndToEnd:case a===j.Type.StartToEnd:return this.getConnectorEndSide(n);case a===j.Type.EndToStart:case a===j.Type.StartToStart:return this.getConnectorStartSide(n);default:return this.getConnectorStartSide(n)}}createLineDefAdjusters(){const{client:r}=this;function n(o){const{barMargin:l}=r;let d=!1;return(o.startArrowMargin>l||o.endArrowMargin>l)&&(o.startArrowMargin=o.endArrowMargin=l,d=!0),d&&o}function a(o){let l=!1;return(o.startArrowMargin>0||o.endArrowMargin>0)&&(o.startArrowMargin=o.endArrowMargin=0,l=!0),l&&o}function s(o,l){let d=!1;return o.horizontalMargin>2&&(o.horizontalMargin=1,d=!0,l.hideMarker=!0),d&&o}return[n,a,s]}adjustLineDef(r,n){return n}prepareLineDef(r,n,a,s){var u,v;const o=this,l=o.getDependencyStartSide(r),d=o.getDependencyEndSide(r),c=(u=s==null?void 0:s.from)!=null?u:o.getAssignmentBounds(n),g=(v=s==null?void 0:s.to)!=null?v:o.getAssignmentBounds(a),m=[];if(!c||!g)return null;let{startArrowMargin:f,verticalMargin:h}=o.pathFinder;return o.client.isHorizontal&&(c.rowTop!=null&&c.rowTop!==g.rowTop&&m.push(...o.generateBoundaryBoxes(c,l)),r.bidirectional||(/(top|bottom)/.test(l)&&(f=o.client.barMargin/2),h=o.client.barMargin/2)),o.adjustLineDef(r,{startBox:c,endBox:g,otherBoxes:m,startArrowMargin:f,verticalMargin:h,otherVerticalMargin:0,otherHorizontalMargin:0,startSide:l,endSide:d})}beforeDraw(){super.beforeDraw(),Object.keys(this.lineCache).length||(this.constructLineCache=!0)}afterDraw(){super.afterDraw(),this.constructLineCache=!1}reset(){super.reset(),this.lineCache={}}},E(t,"$name","DependencyLineGenerator"),t};const at=["start","start","end","end"],st=["start","end","start","end"];var xe=p=>{var t;return t=class extends p{changeTooltip(i,r){const n=this;return r==null||r.destroy(),!n.showTooltip||!i?null:_.new({align:"b-t",id:`${n.client.id}-dependency-tip`,forSelector:`.b-timelinebase:not(.b-eventeditor-editing,.b-taskeditor-editing,.b-resizing-event,.b-dragcreating,.b-dragging-event,.b-creating-dependency) .${n.baseCls}`,forElement:n.client.timeAxisSubGridElement,showOnHover:!0,hoverDelay:0,hideDelay:0,anchorToTarget:!1,textContent:!1,trackMouse:!1,getHtml:n.getHoverTipHtml.bind(n)},i)}getHoverTipHtml({activeTarget:i}){return this.tooltipTemplate(this.resolveDependencyRecord(i))}},E(t,"$name","DependencyTooltip"),E(t,"configurable",{showTooltip:!0,tooltipTemplate(i){return{children:[{className:"b-sch-dependency-tooltip",children:[{tag:"label",text:this.L("L{Dependencies.from}")},{text:i.fromEvent.name},{className:`b-sch-box b-${i.fromSide||at[i.type]}`},{tag:"label",text:this.L("L{Dependencies.to}")},{text:i.toEvent.name},{className:`b-sch-box b-${i.toSide||st[i.type]}`}]}]}},tooltip:{$config:"nullify",value:{}}}),t};const ot={click:"Click",dblclick:"DblClick",contextmenu:"ContextMenu"},lt=Object.freeze({}),ke=p=>{var t;const e=[p];return(t=p.resource)!==null&&t!==void 0&&t.hasLinks&&e.push(...p.resource.$links.map(i=>({id:`${i.id}_${p.id}`,resource:i,event:p.event,drawDependencies:p.drawDependencies}))),e};class q extends B.mixin(se,ge,Re,Je,nt,xe){constructor(){super(...arguments);E(this,"domConfigs",new Map);E(this,"drawingLive",!1);E(this,"lastScrollX",null);E(this,"highlighted",new Map);E(this,"visibleResources",null);E(this,"usingLinks",null);E(this,"visibleDateRange",null);E(this,"relativeTo",null)}static get pluginConfig(){return{chain:["render","onPaint","onElementClick","onElementDblClick","onElementContextMenu","onElementMouseOver","onElementMouseOut","bindStore"],assign:["getElementForDependency","getElementsForDependency","resolveDependencyRecord"]}}construct(e,i){super.construct(e,i);const{scheduledEventName:r}=e;e.ion({svgCanvasCreated:"onSVGReady",animationStart:"refresh",[r+"DragStart"]:"refresh",[r+"DragAbort"]:"refresh",[r+"ResizeStart"]:"refresh",[r+"SegmentDragStart"]:"refresh",[r+"SegmentResizeStart"]:"refresh",timelineViewportResize:"reset",timeAxisViewModelUpdate:"reset",toggleNode:"reset",thisObj:this}),e.rowManager.ion({refresh:"reset",changeTotalHeight:"reset",thisObj:this}),this.bindStore(e.store)}doDisable(e){this.isConfiguring||(this._isDisabling=e,this.draw(),this._isDisabling=!1),super.doDisable(e)}get rowStore(){return this.client.isVertical?this.client.resourceStore:this.client.store}bindStore(e){const i=this;i.client.isVertical||(i.detachListeners("store"),i.client.usesDisplayStore&&(e==null||e.ion({name:"store",refresh:"onStoreRefresh",thisObj:i}),i.reset()))}onStoreRefresh(){this.reset()}attachToProject(e){super.attachToProject(e),e==null||e.ion({name:"project",commitFinalized:"reset",thisObj:this})}attachToResourceStore(e){super.attachToResourceStore(e),e==null||e.ion({name:"resourceStore",change:"onResourceStoreChange",refresh:"onResourceStoreChange",thisObj:this})}onResourceStoreChange(){this.usingLinks=null,this.reset()}attachToEventStore(e){super.attachToEventStore(e),e==null||e.ion({name:"eventStore",refresh:"reset",thisObj:this})}attachToAssignmentStore(e){super.attachToAssignmentStore(e),e==null||e.ion({name:"assignmentStore",refresh:"reset",thisObj:this})}attachToDependencyStore(e){super.attachToDependencyStore(e),e==null||e.ion({name:"dependencyStore",change:"reset",refresh:"reset",thisObj:this})}updateDrawOnScroll(e){const i=this;i.detachListeners("scroll"),e?i.client.ion({name:"scroll",scroll:"doRefresh",horizontalScroll:"onHorizontalScroll",prio:-100,thisObj:i}):(i.client.scrollable.ion({name:"scroll",scrollEnd:"draw",thisObj:i}),i.client.timeAxisSubGrid.scrollable.ion({name:"scroll",scrollEnd:"draw",thisObj:i}))}onHorizontalScroll({subGrid:e,scrollX:i}){i!==this.lastScrollX&&e===this.client.timeAxisSubGrid&&(this.lastScrollX=i,this.draw())}onPaint(){this.refresh()}static getLocalizedDependencyType(e){return e?this.L(`L{DependencyType.${e}}`):""}getElementForDependency(e,i,r){return this.getElementsForDependency(e,i,r)[0]}getElementsForDependency(e,i,r){let n=`[data-dep-id="${e.id}"]`;return i&&(n+=`[data-from-id="${i.id}"]`),r&&(n+=`[data-to-id="${r.id}"]`),Array.from(this.client.svgCanvas.querySelectorAll(n))}resolveDependencyRecord(e){var i;return(i=e.elementData)===null||i===void 0?void 0:i.dependency}isDependencyElement(e){return e.matches(`.${this.baseCls}`)}onElementClick(e){const i=this.resolveDependencyRecord(e.target);if(i){const r=ot[e.type];this.client.trigger(`dependency${r}`,{dependency:i,event:e})}}onElementDblClick(e){return this.onElementClick(e)}onElementContextMenu(e){return this.onElementClick(e)}onElementMouseOver(e){const i=this,r=i.resolveDependencyRecord(e.target);r&&(i.client.trigger("dependencyMouseOver",{dependency:r,event:e}),i.overCls&&i.highlight(r))}onElementMouseOut(e){const i=this,r=i.resolveDependencyRecord(e.target);r&&(i.client.trigger("dependencyMouseOut",{dependency:r,event:e}),i.overCls&&i.unhighlight(r))}isDependencyVisible(e){const i=this,{rowStore:r}=i,{fromEvent:n,toEvent:a}=e;if(!n||!a)return!1;const s=n.resource,o=a.resource;return!r.isAvailable(s)||!r.isAvailable(o)?!1:n.isModel&&!s.instanceMeta(r).hidden&&!o.instanceMeta(r).hidden}updateHighlightDependenciesOnEventHover(e){const i=this;if(e){const{client:r}=i;r.ion({name:"highlightOnHover",[`${r.scheduledEventName}MouseEnter`]:n=>i.highlightEventDependencies(n.eventRecord||n.taskRecord),[`${r.scheduledEventName}MouseLeave`]:n=>i.unhighlightEventDependencies(n.eventRecord||n.taskRecord),thisObj:i})}else i.detachListeners("highlightOnHover")}highlight(e,i=this.overCls){let r=this.highlighted.get(e);r||this.highlighted.set(e,r=new Set),r.add(i);for(const n of this.getElementsForDependency(e))n.classList.add(i)}unhighlight(e,i=this.overCls){const r=this.highlighted.get(e);r&&(r.delete(i),r.size||this.highlighted.delete(e));for(const n of this.getElementsForDependency(e))n.classList.remove(i)}highlightEventDependencies(e,i){e.dependencies.forEach(r=>this.highlight(r,i))}unhighlightEventDependencies(e,i){e.dependencies.forEach(r=>this.unhighlight(r,i))}getDependenciesToConsider(e,i,r,n){var s;var a;return(s=(a=super.getDependenciesToConsider)===null||a===void 0?void 0:a.call(this,e,i,r,n))!=null?s:this.project.dependencyStore.records.filter(o=>o.isValid)}getDependencyKey(e,i,r){return`dep:${e.id};from:${i.id};to:${r.id}`}drawDependency(e,i=!1,r=null){var n,a;const s=this,{domConfigs:o,client:l,rowStore:d,topIndex:c,bottomIndex:g}=s,{eventStore:m,useInitialAnimation:f}=l,{idMap:h}=d,{startMS:u,endMS:v}=s.visibleDateRange,{fromEvent:b,toEvent:D}=e;let C=b.assigned,w=D.assigned;if(b.isScheduled&&D.isScheduled&&m.includes(b)&&m.includes(D)&&(n=C)!==null&&n!==void 0&&n.size&&(a=w)!==null&&a!==void 0&&a.size){s.usingLinks&&(C=[...C].flatMap(ke),w=[...w].flatMap(ke));for(const R of C)for(const z of w){var y,T,x,A;const S=(y=h[(T=R.resource)===null||T===void 0?void 0:T.id])===null||y===void 0?void 0:y.index,k=(x=h[(A=z.resource)===null||A===void 0?void 0:A.id])===null||x===void 0?void 0:x.index,L=Math.min(b.startDateMS,D.startDateMS),I=Math.max(b.endDateMS,D.endDateMS);if(l.isExporting||S!=null&&k!=null&&R.drawDependencies!==!1&&z.drawDependencies!==!1&&d.isAvailable(R.resource)&&d.isAvailable(z.resource)&&!(S<c&&k<c||S>g&&k>g||L<u&&I<u||L>v&&I>v)){const $=s.getDependencyKey(e,R,z),F=s.getDomConfigs(e,R,z,r);F?(f&&(F[0].style={animationDelay:`${Math.max(S,k)/20*1e3}ms`}),o.set($,F)):o.delete($)}s.afterDrawDependency(e,S,k,L,I)}}i||s.domSync()}afterDrawDependency(e,i,r,n,a){var s;(s=super.afterDrawDependency)===null||s===void 0||s.call(this,e,i,r,n,a)}beforeDraw(){var e;(e=super.beforeDraw)===null||e===void 0||e.call(this)}afterDraw(){var e;(e=super.afterDraw)===null||e===void 0||e.call(this)}domSync(e=this.client.svgCanvas){J.sync({targetElement:e,domConfig:{onlyChildren:!0,children:Array.from(this.domConfigs.values()).flat()},syncIdField:"syncId",releaseThreshold:0,strict:!0,callback(){}})}fillDrawingCache(){const e=this,{client:i}=e;e.relativeTo=H.from(i.foregroundCanvas),e.visibleResources=i.visibleResources,e.visibleDateRange=i.visibleDateRange,e.topIndex=e.rowStore.indexOf(e.visibleResources.first),e.bottomIndex=e.rowStore.indexOf(e.visibleResources.last),e.usingLinks==null&&(e.usingLinks=i.resourceStore.some(r=>r.hasLinks))}draw(){const e=this,{client:i}=e,{visibleDateRange:r}=i;if(!(i.refreshSuspended||!i.foregroundCanvas||!r||!i.isEngineReady||e.disabled&&!e._isDisabling||i.isExporting)){if(e.fillDrawingCache(),e.domConfigs.clear(),i.firstVisibleRow&&i.lastVisibleRow&&i.timeAxis.count&&!e.disabled&&r.endMS-r.startMS>0){const{topIndex:n,bottomIndex:a}=e,s=e.getDependenciesToConsider(r.startMS,r.endMS,n,a);e.beforeDraw();for(const o of s)e.drawDependency(o,!0);e.afterDraw()}e.domSync(),i.trigger("dependenciesDrawn")}}doRefresh(){var e,i,r,n;const a=this,{client:s}=a,{scheduledEventName:o}=s;a.draw(),a.drawingLive=s.dependencyStore.count&&(s.isAnimating||s.useInitialAnimation&&s.eventStore.count||((e=s.features[`${o}Drag`])===null||e===void 0?void 0:e.isActivelyDragging)||((i=s.features[`${o}Resize`])===null||i===void 0?void 0:i.isResizing)||((r=s.features[`${o}SegmentDrag`])===null||r===void 0?void 0:r.isActivelyDragging)||((n=s.features[`${o}SegmentResize`])===null||n===void 0?void 0:n.isResizing)),a.drawingLive&&a.refresh(!1)}refresh(e=this.immediateRefresh){const{client:i}=this;!i.refreshSuspended&&!this.disabled&&i.isPainted&&!i.timeAxisSubGrid.collapsed&&(e===!0?this.doRefresh.now:this.doRefresh).call(this)}reset({source:e,type:i}=lt){var r;(r=super.reset)===null||r===void 0||r.call(this),this.refresh(e===this.client&&i==="timelineviewportresize")}drawForEvent(){ne.deprecate("Scheduler","6.0.0","Dependencies.drawForEvent() is no longer needed"),this.refresh()}render(){this.client.getConfig("svgCanvas")}}E(q,"$name","Dependencies"),E(q,"configurable",{overCls:"b-sch-dependency-over",baseCls:"b-sch-dependency",noMarkerCls:"b-sch-dependency-markerless",markerDef:null,radius:null,renderer:null,highlightDependenciesOnEventHover:null,drawOnScroll:!0,clickWidth:null,immediateRefresh:null}),E(q,"delayable",{doRefresh:10}),q._$name="Dependencies",P.registerFeature(q,!1,["Scheduler","ResourceHistogram"]);class ie extends B{static get $name(){return"EventFilter"}static get pluginConfig(){return{chain:["populateTimeAxisHeaderMenu"]}}populateTimeAxisHeaderMenu({items:t}){const e=this;t.eventsFilter={text:"L{filterEvents}",icon:"b-fw-icon b-icon-filter",disabled:e.disabled,localeClass:e,weight:100,menu:{type:"popup",localeClass:e,items:{nameFilter:{weight:110,type:"textfield",cls:"b-eventfilter b-last-row",clearable:!0,keyStrokeChangeDelay:300,label:"L{byName}",localeClass:e,width:200,internalListeners:{change:e.onEventFilterChange,thisObj:e}}},onBeforeShow({source:i}){const[r]=i.items,n=e.store.filters.getBy("property","name");r.value=(n==null?void 0:n.value)||""}}}}onEventFilterChange({value:t}){t!==""?this.store.filter("name",t):this.store.removeFilter("name")}get store(){const{client:t}=this;return t.isGanttBase?t.store:t.eventStore}}ie.featureClass="b-event-filter",ie._$name="EventFilter",P.registerFeature(ie,!0,["Scheduler","Gantt"]),P.registerFeature(ie,!1,"ResourceHistogram");var ze=p=>{var t;return t=class extends p{getNonWorkingTimeRanges(i,r,n){if(!i.getNonWorkingTimeRanges){const a=[];return i.forEachAvailabilityInterval({startDate:r,endDate:n,isForward:!0},(s,o,l)=>{for(const[d,c]of l.intervalGroups)c.getIsWorking()||a.push({name:d.name,iconCls:d.iconCls,cls:d.cls,startDate:s,endDate:o})}),a}return i.getNonWorkingTimeRanges(r,n)}getCalendarTimeRanges(i,r=!1){const n=this,{timeAxis:a,fillTicks:s}=n.client,{unit:o,increment:l}=a,d=!n.maxTimeAxisUnit||M.compareUnits(o,n.maxTimeAxisUnit)<=0;if(i&&d&&a.count){const c=n.getNonWorkingTimeRanges(i,a.startDate,a.endDate),g=c.map(h=>new ve({name:h.name,cls:`b-nonworkingtime ${h.cls||""}`,startDate:h.startDate,endDate:h.endDate})),m=[];let f=null;for(const h of g)f&&h.startDate<=f.endDate&&(r||h.name===f.name)&&h.duration>0?f.endDate=h.endDate:(m.push(h),h.setData("id",`nonworking-${m.length}`),f=h);return s&&m.forEach(h=>{h.setStartEndDate(M.ceil(h.startDate,{magnitude:l,unit:o}),M.floor(h.endDate,{magnitude:l,unit:o}))}),m}else return[]}setupDefaultCalendar(){const{client:i,project:r}=this;!this.autoGeneratedWeekends&&!i.isSchedulerPro&&!i.isGantt&&r.effectiveCalendar===r.defaultCalendar&&!r.defaultCalendar.intervalStore.count&&(this.autoGeneratedWeekends=!0,this.updateDefaultCalendar())}updateDefaultCalendar(){if(this.autoGeneratedWeekends){const i=this.client.project.effectiveCalendar,r=this.defaultNonWorkingIntervals,n=!!r.length;i.ignoreTimeZone=!0,i.clearIntervals(n),n&&i.addIntervals(r)}}updateLocalization(){var i;(i=super.updateLocalization)===null||i===void 0||i.call(this),this.autoGeneratedWeekends&&this.updateDefaultCalendar()}get defaultNonWorkingIntervals(){const i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return M.nonWorkingDaysAsArray.map(r=>({recurrentStartDate:`on ${i[r]} at 0:00`,recurrentEndDate:`on ${i[(r+1)%7]} at 0:00`,isWorking:!1}))}},E(t,"$name","NonWorkingTimeMixin"),E(t,"configurable",{maxTimeAxisUnit:"week"}),t};class Z extends te.mixin(se,ze){static get defaultConfig(){return{highlightWeekends:null,hideRangesOnZooming:!0,showHeaderElements:!0,showLabelInBody:!0,autoGeneratedWeekends:!1}}doDestroy(){this.attachToCalendar(null),super.doDestroy()}set highlightWeekends(t){ne.deprecate("Scheduler","6.0.0","Deprecated in favour of disabling the feature"),this.disabled=!t}get highlightWeekends(){return!this.disabled}onConfigChange({name:t}){!this.isConfiguring&&t==="fillTicks"&&this.refresh()}attachToProject(t){super.attachToProject(t),this.attachToCalendar(t.effectiveCalendar),!t.graph&&!this.client.isScheduler&&t.ion({name:"project",dataReady:{fn:()=>this.attachToCalendar(t.effectiveCalendar),once:!0},thisObj:this}),t.ion({name:"project",calendarChange:()=>this.attachToCalendar(t.effectiveCalendar),thisObj:this})}onTimeAxisViewModelUpdate(...t){return this._timeAxisUnitDurationMs=null,super.onTimeAxisViewModelUpdate(...t)}attachToCalendar(t){const e=this,{project:i,client:r}=e;e.detachListeners("calendar"),e.autoGeneratedWeekends=!1,t&&(e.setupDefaultCalendar(),t.intervalStore.ion({name:"calendar",change:()=>e.setTimeout(()=>e.refresh(),1)})),r.isEngineReady&&!r.project.isDelayingCalculation&&!r.isDestroying?e.refresh():i.isDestroyed||(e.detachListeners("initialProjectListener"),i.ion({name:"initialProjectListener",refresh({isCalculated:n}){n!==!1&&(e.refresh(),e.detachListeners("initialProjectListener"))},thisObj:e}))}get calendar(){var t;return(t=this.project)===null||t===void 0?void 0:t.effectiveCalendar}get timeAxisUnitDurationMs(){return this._timeAxisUnitDurationMs||(this._timeAxisUnitDurationMs=M.as("ms",1,this.client.timeAxis.unit)),this._timeAxisUnitDurationMs}shouldRenderRange(t){return super.shouldRenderRange(t)&&(!this.hideRangesOnZooming||t.durationMS>=this.timeAxisUnitDurationMs)}get timeRanges(){const t=this;return t._timeRanges||(t._timeRanges=t.getCalendarTimeRanges(t.calendar)),t._timeRanges}}E(Z,"$name","NonWorkingTime"),E(Z,"pluginConfig",{chain:["onPaint","attachToProject","updateLocalization","onConfigChange","onSchedulerHorizontalScroll"]}),Z._$name="NonWorkingTime",P.registerFeature(Z,!1,"Scheduler"),P.registerFeature(Z,!0,["SchedulerPro","Gantt","ResourceHistogram"]);class re extends B{static get $name(){return"ScheduleTooltip"}static get configurable(){return{messageTemplate:t=>`<div class="b-sch-hovertip-msg">${t.message}</div>`,hideForNonWorkingTime:null}}static get pluginConfig(){return{chain:["onPaint"]}}onPaint({firstPaint:t}){if(!t)return;const e=this,{client:i}=e;i.isSchedulerPro&&e.hideForNonWorkingTime===void 0&&(e.hideForNonWorkingTime=!0);let r;const n=e.hoverTip=new _({id:`${i.id}-schedule-tip`,cls:"b-sch-scheduletip",allowOver:!0,hoverDelay:0,hideDelay:100,showOnHover:!0,forElement:i.timeAxisSubGridElement,anchorToTarget:!1,trackMouse:!0,updateContentOnMouseMove:!0,monitorResize:!1,textContent:!1,forSelector:".b-schedulerbase:not(.b-dragging-event):not(.b-dragcreating) .b-grid-body-container:not(.b-scrolling) .b-timeline-subgrid:not(.b-scrolling) > :not(.b-sch-foreground-canvas):not(.b-group-footer):not(.b-group-row) *",getHtml:e.getHoverTipHtml.bind(e),onDocumentMouseDown(a){n.forElement.contains(a.event.target)&&(r=V.on({thisObj:e,element:i.timeAxisSubGridElement,mousemove:o=>n.internalOnPointerOver(o),capture:!0}));const s=n.hideAnimation;n.hideAnimation=!1,n.constructor.prototype.onDocumentMouseDown.call(n,a),n.hideAnimation=s},...e.config,internalListeners:e.configuredListeners});n.ion({pointerover({event:a}){const s="buttons"in a?a.buttons>0:a.which>0;return!s&&r&&r(),!e.disabled&&!s},innerhtmlupdate({source:a}){e.clockTemplate.updateDateIndicator(a.element,e.lastTime)}}),i.ion({timeAxisViewModelUpdate:"updateTip",thisObj:e}),e.clockTemplate=new Q({scheduler:i})}processConfiguredListeners(){}updateTip(){this.hoverTip.isVisible&&this.hoverTip.updateContent()}doDestroy(){this.destroyProperties("clockTemplate","hoverTip"),super.doDestroy()}getHoverTipHtml({tip:t,event:e}){const i=this,r=i.client,n=e&&r.getDateFromDomEvent(e,"floor",!0);let a=i.lastHtml;if(n&&e.target){const s=r.resolveResourceRecord(e);if(s&&(n-i.lastTime!==0||s.id!==i.lastResourceId)){if(i.hideForNonWorkingTime){const o=s.isWorkingTime(n);t.element.classList.toggle("b-nonworking-time",!o)}i.lastResourceId=s.id,a=i.lastHtml=i.generateTipContent({date:n,event:e,resourceRecord:s})}}else t.hide(),i.lastTime=null,i.lastResourceId=null;return a}generateTipContent({date:t,event:e,resourceRecord:i}){const r=this,n=r.clockTemplate.generateContent({date:t,text:r.client.getFormattedDate(t)}),a=r.messageTemplate({message:r.getText(t,e,i)||""});return r.lastTime=t,n+a}getText(t,e,i){}}re.featureClass="b-scheduletip",re._$name="ScheduleTooltip",P.registerFeature(re,!0,"Scheduler"),P.registerFeature(re,!1,"ResourceUtilization");const dt={maintainVisibleStart:!0};class pe extends Fe{static get $name(){return"TimeAxisHeaderMenu"}static get defaultConfig(){return{processItems:null,items:null,type:"timeAxisHeader"}}static get pluginConfig(){const t=super.pluginConfig;return t.chain.push("populateTimeAxisHeaderMenu"),t}construct(){super.construct(...arguments),this.triggerEvent.includes("click")&&this.client.zoomOnTimeAxisDoubleClick&&(this.client.zoomOnTimeAxisDoubleClick=!1)}shouldShowMenu(t){const{column:e,targetElement:i}=t,{client:r}=this;return r.isHorizontal?(e==null?void 0:e.enableHeaderContextMenu)!==!1&&(e==null?void 0:e.isTimeAxisColumn):i.matches(".b-sch-header-timeaxis-cell")}showContextMenu(t){super.showContextMenu(...arguments),this.menu&&(this.menu.scrollAction="realign")}populateTimeAxisHeaderMenu({items:t}){const e=this,{client:i}=e,r={magnitude:i.timeAxis.shiftIncrement,unit:i.timeAxis.shiftUnit};Object.assign(t,{zoomLevel:{text:"L{pickZoomLevel}",localeClass:e,icon:"b-fw-icon b-icon-search-plus",disabled:!i.presets.count||e.disabled,weight:200,menu:{type:"popup",items:{zoomSlider:{weight:210,type:"slider",minWidth:130,showValue:!1,triggerChangeOnInput:!0}},onBeforeShow({source:n}){const[a]=n.items;a.min=i.minZoomLevel,a.max=i.maxZoomLevel,a.value=i.zoomLevel,e.zoomDetatcher=a.ion({change:"onZoomSliderChange",thisObj:e})},onHide(){e.zoomDetatcher&&(e.zoomDetatcher(),e.zoomDetatcher=null)}}},dateRange:{text:"L{activeDateRange}",localeClass:e,icon:"b-fw-icon b-icon-calendar",weight:300,menu:{type:"popup",cls:"b-sch-timeaxis-menu-daterange-popup",defaults:{localeClass:e},items:{startDateField:{type:"datefield",label:"L{startText}",weight:310,labelWidth:"6em",required:!0,step:r,internalListeners:{change:e.onRangeDateFieldChange,thisObj:e}},endDateField:{type:"datefield",label:"L{endText}",weight:320,labelWidth:"6em",required:!0,step:r,internalListeners:{change:e.onRangeDateFieldChange,thisObj:e}},leftShiftBtn:{type:"button",weight:330,cls:"b-left-nav-btn",icon:"b-icon b-icon-previous",color:"b-blue b-raised",flex:1,margin:0,internalListeners:{click:e.onLeftShiftBtnClick,thisObj:e}},todayBtn:{type:"button",weight:340,cls:"b-today-nav-btn",color:"b-blue b-raised",text:"L{todayText}",flex:4,margin:"0 8",internalListeners:{click:e.onTodayBtnClick,thisObj:e}},rightShiftBtn:{type:"button",weight:350,cls:"b-right-nav-btn",icon:"b-icon b-icon-next",color:"b-blue b-raised",flex:1,internalListeners:{click:e.onRightShiftBtnClick,thisObj:e}}},internalListeners:{paint:e.initDateRangeFields,thisObj:e}}}})}onZoomSliderChange({value:t}){const e=this;e.menu.scrollAction="realign",e.client.zoomLevel=t,e.menu.setTimeout({fn:()=>e.menu.scrollAction="hide",delay:100,cancelOutstanding:!0})}initDateRangeFields({source:t,firstPaint:e}){if(e){const{widgetMap:i}=t;this.startDateField=i.startDateField,this.endDateField=i.endDateField}this.initDates()}initDates(){const t=this;t.startDateField.suspendEvents(),t.endDateField.suspendEvents(),t.startDateField.value=t.startDateFieldInitialValue=t.client.startDate,t.endDateField.value=t.endDateFieldInitialValue=t.client.endDate,t.startDateField.resumeEvents(),t.endDateField.resumeEvents()}onRangeDateFieldChange({source:t}){const e=this,i=t===e.startDateField,{client:r}=e,{timeAxis:n}=r,a=e.startDateFieldInitialValue&&!i?e.startDateFieldInitialValue:e.startDateField.value;let s=e.endDateFieldInitialValue&&i?e.endDateFieldInitialValue:e.endDateField.value;i?e.startDateFieldInitialValue=null:e.endDateFieldInitialValue=null,s-a?s<a&&(s=M.add(a,n.shiftIncrement,n.shiftUnit)):s=M.add(s,n.shiftIncrement,n.shiftUnit),r.setTimeSpan(a,s,dt),e.initDates()}onLeftShiftBtnClick(){this.client.timeAxis.shiftPrevious(),this.initDates()}onTodayBtnClick(){const t=M.clearTime(new Date);this.client.setTimeSpan(t,M.add(t,1,"day")),this.initDates()}onRightShiftBtnClick(){this.client.timeAxis.shiftNext(),this.initDates()}}pe._$name="TimeAxisHeaderMenu",P.registerFeature(pe,!0,["Scheduler","TimelineHistogram","Gantt"]);export{te as AbstractTimeRanges,Xe as Base,de as CalendarCacheIntervalMultiple,Ce as CalendarCacheMultiple,me as ColumnLines,q as Dependencies,Re as DependencyCreation,xe as DependencyTooltip,Se as DragBase,oe as DragCreateBase,he as DurationColumn,ie as EventFilter,ee as EventResize,Z as NonWorkingTime,ze as NonWorkingTimeMixin,X as RectangularPathFinder,re as ScheduleTooltip,Te as TaskEditTransactional,pe as TimeAxisHeaderMenu,we as TooltipBase,Ee as TransactionalFeature,qe as combineCalendars};
//# sourceMappingURL=TimeAxisHeaderMenu.js.map
