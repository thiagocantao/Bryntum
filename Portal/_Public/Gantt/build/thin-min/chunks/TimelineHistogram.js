/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var Be=Object.defineProperty;var Oe=(R,e,t)=>e in R?Be(R,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):R[e]=t;var p=(R,e,t)=>(Oe(R,typeof e!="symbol"?e+"":e,t),t);import{ObjectHelper as z,InstancePlugin as ae,EventHelper as ie,StringHelper as Te,Popup as ke,Rectangle as _,Duration as Pe,Delayable as Le,DomHelper as H,DateHelper as j,DomSync as fe,parseAlign as Ie,Base as Se,ArrayHelper as ve,Tooltip as $e,Objects as X}from"./Editor.js";import{AttachToProjectMixin as pe,TimelineBase as _e}from"./ScheduleMenu.js";import{ColumnStore as je,Column as We,GridFeatureManager as F,CopyPasteBase as Ge}from"./GridBase.js";import"./MessageDialog.js";import{DependencyModel as we,TimeSpan as ze}from"./CrudManagerView.js";import{DragBase as Ve,DragCreateBase as Ne,TooltipBase as Ue,AbstractTimeRanges as Ke}from"./TimeAxisHeaderMenu.js";import"./Tree.js";import{Scale as Xe,Histogram as Ye}from"./Scale.js";class Y extends We{static get fields(){return["scalePoints"]}static get defaults(){return{text:"\xA0",width:40,minWidth:40,field:"scalePoints",cellCls:"b-scale-cell",editor:!1,sortable:!1,groupable:!1,filterable:!1,alwaysClearCell:!1,scalePoints:null}}onDestroy(){this.scaleWidget.destroy()}set width(e){super.width=e,this.scaleWidget.width=e}get width(){return super.width}applyValue(e,t,r){return t==="scalePoints"&&(this.scaleWidget[t]=r),super.applyValue(...arguments)}buildScaleWidget(){const e=this,t=new Xe({owner:e.grid,appendTo:e.grid.floatRoot,cls:"b-hide-offscreen",align:"right",scalePoints:e.scalePoints,monitorResize:!1});return Object.defineProperties(t,{width:{get(){return e.width},set(r){this.element.style.width=`${r}px`,this._width=e.width}},height:{get(){return this._height},set(r){this.element.style.height=`${r}px`,this._height=r}}}),t.width=e.width,t}get scaleWidget(){const e=this;return e._scaleWidget||(e._scaleWidget=e.buildScaleWidget()),e._scaleWidget}renderer({cellElement:e,value:t,scaleWidgetConfig:r,scaleWidget:i=this.scaleWidget}){z.assign(i,{scalePoints:t||this.scalePoints,height:this.grid.rowHeight},r),i.refresh();const s=i.element.cloneNode(!0);s.removeAttribute("id"),s.classList.remove("b-hide-offscreen"),e.innerHTML="",e.appendChild(s)}}p(Y,"$name","ScaleColumn"),p(Y,"type","scale"),p(Y,"isScaleColumn",!0),je.registerColumnType(Y),Y._$name="ScaleColumn";class oe extends ae.mixin(pe){static get pluginConfig(){return{chain:["getEventsToRender","onEventDataGenerated","noFeatureElementsInAxis"],override:["matchScheduleCell","resolveResourceRecord"]}}noFeatureElementsInAxis(){const{timeAxis:e}=this.client;return!this.needsRefresh&&this.store&&!this.store.storage.values.some(t=>e.isTimeSpanInAxis(t))}doDisable(e){this.client.isPainted&&this.client.refresh(),super.doDisable(e)}updateTabIndex(){this.isConfiguring||this.client.refresh()}getEventsToRender(e,t){throw new Error("Implement in subclass")}onEventDataGenerated(e){const t=this,{eventRecord:r,iconCls:i}=e;t.shouldInclude(r)&&(t.client.isVertical?e.width=e.resourceRecord.columnWidth||t.client.resourceColumnWidth:e.top=0,e.fillSize=!0,e.wrapperCls["b-sch-resourcetimerange"]=1,t.rangeCls&&(e.wrapperCls[t.rangeCls]=1),e.wrapperCls[`b-sch-color-${r.timeRangeColor}`]=r.timeRangeColor,e.eventContent.text=r.name,e.children.push(e.eventContent),e.tabIndex=t.tabIndex!=null?String(t.tabIndex):null,(i==null?void 0:i.length)>0&&e.children.unshift({tag:"i",className:i.toString()}),e.eventId=t.generateElementId(r))}generateElementId(e){return e.domId}resolveResourceTimeRangeRecord(e){var t;return e==null||(t=e.closest(`.${this.rangeCls}`))===null||t===void 0?void 0:t.elementData.eventRecord}getElementFromResourceTimeRangeRecord(e){return this.client.foregroundCanvas.syncIdMap[e.domId]}resolveResourceRecord(e){var t;return this.overridden.resolveResourceRecord(...arguments)||((t=this.resolveResourceTimeRangeRecord(e.target||e))===null||t===void 0?void 0:t.resource)}shouldInclude(e){throw new Error("Implement in subclass")}onStoreChange(e){(e.action==="removeall"||e.action==="dataset")&&(this.needsRefresh=!0),this.client.onInternalEventStoreChange(e),this.needsRefresh=!1}matchScheduleCell(e){let t=this.overridden.matchScheduleCell(e);if(!t&&this.enableMouseEvents){const{client:r}=this,i=e.closest(`.${this.rangeCls}`);t=i&&r.getCell({record:r.isHorizontal?i.elementData.resource:r.store.first,column:r.timeAxisColumn})}return t}handleRangeMouseEvent(e){var i;const t=this,r=e.target.closest(`.${t.rangeCls}`);if(r){const s=(i=ie.eventNameMap[e.type])!=null?i:Te.capitalize(e.type),n=t.resolveResourceTimeRangeRecord(r);t.client.trigger(t.entityName+s,{feature:t,[`${t.entityName}Record`]:n,resourceRecord:t.client.resourceStore.getById(n.resourceId),domEvent:e})}}updateEnableMouseEvents(e){var t;const r=this,{client:i}=r;if((t=r.mouseEventsDetacher)===null||t===void 0||t.call(r),r.mouseEventsDetacher=null,e){let s=function(){r.mouseEventsDetacher=ie.on({element:i.foregroundCanvas,delegate:`.${r.rangeCls}`,mousedown:"handleRangeMouseEvent",mouseup:"handleRangeMouseEvent",click:"handleRangeMouseEvent",dblclick:"handleRangeMouseEvent",contextmenu:"handleRangeMouseEvent",mouseover:"handleRangeMouseEvent",mouseout:"handleRangeMouseEvent",thisObj:r})};i.whenVisible(s)}i.element.classList.toggle("b-interactive-resourcetimeranges",!!e)}}p(oe,"configurable",{tabIndex:null,entityName:"resourceTimeRange"}),oe.featureClass="",oe._$name="ResourceTimeRangesBase";class xe extends ke{static get $name(){return"DependencyEditor"}static get defaultConfig(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible"}}processWidgetConfig(e){const{dependencyEditFeature:t}=this;return e.ref==="lagField"&&!t.showLagField||e.ref==="deleteButton"&&!t.showDeleteButton?!1:super.processWidgetConfig(e)}afterShow(...e){const{deleteButton:t}=this.widgetMap;t&&(t.hidden=!this.record.isPartOfStore()),super.afterShow(...e)}onInternalKeyDown(e){this.trigger("keyDown",{event:e}),super.onInternalKeyDown(e)}}xe._$name="DependencyEditor";class Re extends ae{static get $name(){return"DependencyEdit"}static get configurable(){return{autoClose:!0,saveAndCloseOnEnter:!0,showDeleteButton:!0,triggerEvent:"dependencydblclick",showLagField:!1,dependencyRecord:null,editorConfig:{title:"L{Edit dependency}",localeClass:this,closable:!0,defaults:{localeClass:this},items:{fromNameField:{type:"display",weight:100,label:"L{From}"},toNameField:{type:"display",weight:200,label:"L{To}"},typeField:{type:"combo",weight:300,label:"L{Type}",name:"type",editable:!1,valueField:"id",displayField:"name",localizeDisplayFields:!0,buildItems:function(){const e=this.parent;return Object.keys(we.Type).map(t=>({id:we.Type[t],name:e.L(t),localeKey:t}))}},lagField:{type:"duration",weight:400,label:"L{Lag}",name:"lag",allowNegative:!0}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler"},saveButton:{color:"b-green",text:"L{Save}"},deleteButton:{color:"b-gray",text:"L{Delete}"},cancelButton:{color:"b-gray",text:"L{Object.Cancel}"}}}}}}construct(e,t){const r=this;if(e.dependencyEdit=r,super.construct(e,t),!e.features.dependencies)throw new Error("Dependencies feature required when using DependencyEdit");r.clientListenersDetacher=e.ion({[r.triggerEvent]:r.onActivateEditor,thisObj:r})}doDestroy(){var e;this.clientListenersDetacher(),(e=this.editor)===null||e===void 0||e.destroy(),super.doDestroy()}changeEditorConfig(e){const t=this,{autoClose:r,cls:i,client:s}=t;return z.assign({owner:s,align:"b-t",id:`${s.id}-dependency-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",clippedBy:[s.timeAxisSubGridElement,s.bodyContainer],constrainTo:globalThis,autoClose:r,cls:i},e)}get isValid(){return Object.values(this.editor.widgetMap).every(e=>!e.name||e.hidden?!0:e.isValid!==!1)}get values(){const e={};return this.editor.eachWidget(t=>{!t.name||t.hidden||(e[t.name]=t.value)},!0),e}onBeforeSave(e){}onAfterSave(e){}updateRecord(e){const{values:t}=this;t.lag&&(t.lagUnit=t.lag.unit,t.lag=t.lag.magnitude),"type"in t&&(e.fromSide!=null&&(t.fromSide=null),e.toSide!=null&&(t.toSide=null)),z.cleanupProperties(t,!0),e.set(t)}onPopupKeyDown({event:e}){e.key==="Enter"&&this.saveAndCloseOnEnter&&e.target.tagName.toLowerCase()==="input"&&(e.preventDefault(),this.onSaveClick())}onSaveClick(){this.save()&&(this.afterSave(),this.editor.hide())}async onDeleteClick(){await this.deleteDependency()&&this.afterDelete(),this.editor.hide()}onCancelClick(){this.afterCancel(),this.editor.hide()}afterSave(){}afterDelete(){}afterCancel(){}internalShowEditor(e){const t=this,{client:r}=t,i=t.getEditor(e);t.loadRecord(e),r.trigger("beforeDependencyEditShow",{dependencyEdit:t,dependencyRecord:e,editor:i});let s=t.lastPointerDownCoordinate;if(!s){const n=_.from(r.element).center;s=[n.x-i.width/2,n.y-i.height/2]}return i.showBy(s)}async editDependency(e){const t=this,{client:r}=t;return r.readOnly||e.readOnly||await r.trigger("beforeDependencyEdit",{dependencyEdit:t,dependencyRecord:e})===!1?!1:(await this.internalShowEditor(e),!0)}getEditor(){var e,t,r;const i=this;let{editor:s}=i;return s||(s=i.editor=xe.new({dependencyEditFeature:i,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,autoClose:i.autoClose,cls:i.cls,rootElement:i.client.rootElement,internalListeners:{keydown:i.onPopupKeyDown,thisObj:i}},i.editorConfig),s.items.length===0&&console.warn("Editor configured without any `items`"),s.eachWidget(n=>{const a=n.ref||n.id;a&&!i[a]&&(i[a]=n)}),(e=i.saveButton)===null||e===void 0||e.ion({click:"onSaveClick",thisObj:i}),(t=i.deleteButton)===null||t===void 0||t.ion({click:"onDeleteClick",thisObj:i}),(r=i.cancelButton)===null||r===void 0||r.ion({click:"onCancelClick",thisObj:i}),i.editor)}loadRecord(e){const t=this;t.fromNameField.value=e.fromEvent.name,t.toNameField.value=e.toEvent.name,t.lagField&&(t.lagField.value=new Pe(e.lag,e.lagUnit)),t.editor.record=t.dependencyRecord=e}async save(){const e=this,{client:t,dependencyRecord:r}=e;if(!r||!e.isValid)return;const{dependencyStore:i,values:s}=e;if(t.trigger("beforeDependencySave",{dependencyRecord:r,values:s})!==!1){var n;if(e.onBeforeSave(r),e.updateRecord(r),i&&!r.stores.length){if(t.trigger("beforeDependencyAdd",{dependencyRecord:r,dependencyEdit:e})===!1)return;i.add(r)}await((n=t.project)===null||n===void 0?void 0:n.commitAsync()),t.trigger("afterDependencySave",{dependencyRecord:r}),e.onAfterSave(r)}return r}async deleteDependency(){const{client:e,editor:t,dependencyRecord:r}=this;if(e.trigger("beforeDependencyDelete",{dependencyRecord:r})!==!1){var i;return t.containsFocus&&t.revertFocus(),e.dependencyStore.remove(r),await((i=e.project)===null||i===void 0?void 0:i.commitAsync()),!0}return!1}get dependencyStore(){return this.client.dependencyStore}onActivateEditor({dependency:e,event:t}){this.disabled||(this.lastPointerDownCoordinate=[t.clientX,t.clientY],this.editDependency(e))}}Re._$name="DependencyEdit",F.registerFeature(Re,!1);class Z extends ae.mixin(Le){static get $name(){return"ScheduleContext"}construct(e,t){super.construct(e,t);const{triggerEvent:r}=this,i={datachange:"syncContextElement",timeaxisviewmodelupdate:"onTimeAxisViewModelUpdate",presetchange:"clearContext",thisObj:this};r==="mouseover"?i.timelineContextChange="onTimelineContextChange":((r==="click"||r==="mousedown")&&(i.schedulecontextmenu="onScheduleContextGesture"),Object.assign(i,{[`schedule${r}`]:"onScheduleContextGesture",[`event${r}`]:"onScheduleContextGesture",...i})),e.useBackgroundCanvas=!0,e.ion(i),e.rowManager.ion({rowheight:"syncContextElement",thisObj:this})}changeTriggerEvent(e){return(e==="hover"||e==="mousemove")&&(e="mouseover"),e}get element(){return this._element||(this._element=H.createElement({parent:this.client.backgroundCanvas,className:"b-schedule-selected-tick"}))}onTimelineContextChange({context:e}){this.context=e}onScheduleContextGesture(e){this.context=e}onTimeAxisViewModelUpdate({source:e}){var t;e.timeAxis.includes((t=this.context)===null||t===void 0?void 0:t.tick)?this.syncContextElement():this.clearContext()}clearContext(){this.context=null}updateContext(e,t){this.syncContextElement()}syncContextElement(){if(this.context&&this.enabled){const e=this,{client:t,element:r,context:i,renderer:s}=e,{isVertical:n}=t,{style:a}=r,o=n?t.rowManager.rows[0]:t.getRowFor(i.resourceRecord);if(o){const{tickStartDate:l,tickEndDate:c,resourceRecord:d}=i,u=t.currentOrientation.getTimeSpanRenderData({startDate:l,endDate:c,startDateMS:l.getTime(),endDateMS:c.getTime()},d);let h,m,T;n?(h=u.top,m=u.resourceWidth,T=u.height):(h=o.top,m=u.width,T=o.height),a.display="",a.width=`${m}px`,a.height=`${T}px`,H.setTranslateXY(r,u.left,h),i.index=o.index,r.innerHTML="",s&&e.callback(s,e,[i,r])}else a.display="none"}else this.element.style.display="none"}}p(Z,"delayable",{syncContextElement:"raf"}),p(Z,"configurable",{triggerEvent:"click",renderer:null,context:{$config:{equal(e,t){return(e==null?void 0:e.index)===(t==null?void 0:t.index)&&(e==null?void 0:e.tickParentIndex)===(t==null?void 0:t.tickParentIndex)&&!(((e==null?void 0:e.tickStartDate)||0)-((t==null?void 0:t.tickStartDate)||0))}}}}),Z.featureClass="b-scheduler-context",Z._$name="ScheduleContext",F.registerFeature(Z,!1,["Scheduler"]);class V extends Ge.mixin(pe){constructor(){super(...arguments);p(this,"entityName","event")}construct(t,r){super.construct(t,r),t.ion({eventClick:"onEventClick",scheduleClick:"onScheduleClick",projectChange:()=>{this.clearClipboard(),this._cellClickedContext=null},thisObj:this})}get scheduler(){return this.client}attachToEventStore(t){super.attachToEventStore(t),delete this._eventClickedContext}onEventDataGenerated(t){const{assignmentRecord:r}=t;r&&(t.cls["b-cut-item"]=r.meta.isCut)}onEventClick(t){this._cellClickedContext=null,this._eventClickedContext=t}onScheduleClick(t){this._cellClickedContext=t,this._eventClickedContext=null}isActionAvailable({event:t}){var r,i;return!this.disabled&&globalThis.getSelection().toString().length===0&&!((r=this.client.features.cellEdit)!==null&&r!==void 0&&r.isEditing)&&!!t.target.closest(".b-timeaxissubgrid")&&!((i=this.client.focusedCell)!==null&&i!==void 0&&i.isSpecialRow)}async copy(){await this.copyEvents()}async cut(){await this.copyEvents(void 0,!0)}async paste(){await this.pasteEvents()}async copyEvents(t=this.scheduler.selectedAssignments,r=!1){const i=this,{scheduler:s}=i;if(s.splitFrom)return s.splitFrom.features.eventCopyPaste.copyEvents(t,r);if(!(t!=null&&t.length))return;let n=t.slice();t[0].isEventModel&&(n=t.map(o=>o.assignments).flat()),r&&(n=n.filter(o=>!o.event.readOnly));const a=n.map(o=>o.event);!n.length||s.readOnly||(await i.writeToClipboard({assignmentRecords:n,eventRecords:a},r),s.trigger("copy",{assignmentRecords:n,eventRecords:a,isCut:r,entityName:i.entityName}),s.refreshWithTransition(),i._focusedEventOnCopy=i._eventClickedContext)}async beforeCopy({data:{assignmentRecords:t,eventRecords:r},isCut:i}){return await this.scheduler.trigger("beforeCopy",{assignmentRecords:t,eventRecords:r,isCut:i,entityName:this.entityName})}handleCutData({source:t}){var r;const i=this;if(t!==i&&(r=i.cutData)!==null&&r!==void 0&&r.length){const{assignmentRecords:s,eventRecords:n}=i.cutData[0];s!=null&&s.length&&i.scheduler.assignmentStore.remove(s),n!=null&&n.length&&i.scheduler.eventStore.remove(n)}}stringConverter({eventRecords:t}){const r=[];for(const i of t)r.push(this.eventToStringFields.map(s=>{const n=i[s];return n instanceof Date?j.format(n,this.dateFormat):n}).join("	"));return r.join(`
`)}setIsCut({assignmentRecords:t},r){t.forEach(i=>{i.meta.isCut=r}),this.scheduler.refreshWithTransition()}async pasteEvents(t,r){var i;const s=this,{scheduler:n}=s;if(n.splitFrom)return n.splitFrom.features.eventCopyPaste.pasteEvents(t,r);const{entityName:a,isCut:o,_cellClickedContext:l,_eventClickedContext:c}=s,{eventStore:d,assignmentStore:u}=n;arguments.length===0&&(l?(t=l.date,r=l.resourceRecord):s._focusedEventOnCopy!==c&&(t=c.eventRecord.startDate,r=c.resourceRecord)),r&&(r=r.$original);const h=await s.readFromClipboard({resourceRecord:r,date:t});if(!(h!=null&&(i=h.assignmentRecords)!==null&&i!==void 0&&i.length))return;const{assignmentRecords:m,eventRecords:T}=h;let C=null;const A=new Set,M=[];for(const y of m){let{event:E}=y;const w=r||y.resource,G=t||y.event.startDate;if(A.has(E)){o&&y.remove();continue}if(A.add(E),o)y.meta.isCut=!1,y.resource=w,C=y;else if(d.usesSingleAssignment||s.copyPasteAction==="clone")E=E.copy(),E.name=s.generateNewName(E),d.add(E),E.assign(w),C=u.last;else if(!E.resources.includes(w)){const U=y.copy();U.resource=w,[C]=u.add(U)}E.startDate=G,E.constraintDate&&(E.constraintDate=null),M.push(E)}n.trigger("paste",{assignmentRecords:m,pastedEventRecords:M,eventRecords:T,resourceRecord:r,date:t,isCut:o,entityName:a});const I=n.ion({renderEvent({assignmentRecord:y}){y===C&&(n.navigateTo(y,{scrollIntoView:!1}),I())}});o&&await s.clearClipboard()}async beforePaste({data:{assignmentRecords:t,eventRecords:r},resourceRecord:i,isCut:s,date:n}){const{scheduler:a}=this,o={assignmentRecords:t,eventRecords:r,resourceRecord:i||t[0].resource,date:n,isCut:s,entityName:this.entityName};let l;return i!=null&&i.readOnly&&(l="resourceReadOnly"),a.allowOverlap||t.some(d=>!a.isDateRangeAvailable(d.event.startDate,d.event.endDate,s?d.event:null,d.resource))&&(l="overlappingEvents"),l?(a.trigger("pasteNotAllowed",{...o,reason:l}),!1):await this.scheduler.trigger("beforePaste",o)}stringParser(t){const{eventStore:r,assignmentStore:i}=this.scheduler,{modifiedRecords:s}=this.setFromStringData(t,!0,r,this.eventToStringFields),n=[];for(const a of s){const o=new i.modelClass({eventId:a.id});o.event=a,n.push(o)}return{eventRecords:s,assignmentRecords:n}}populateEventMenu({assignmentRecord:t,items:r}){const i=this,{scheduler:s}=i;s.readOnly||(r.copyEvent={text:"L{copyEvent}",localeClass:i,icon:"b-icon b-icon-copy",weight:110,onItem:()=>{const n=s.isAssignmentSelected(t)?s.selectedAssignments:[t];i.copyEvents(n)}},r.cutEvent={text:"L{cutEvent}",localeClass:i,icon:"b-icon b-icon-cut",weight:120,disabled:t.event.readOnly,onItem:()=>{const n=s.isAssignmentSelected(t)?s.selectedAssignments:[t];i.copyEvents(n,!0)}})}populateScheduleMenu({items:t,resourceRecord:r}){const i=this,{scheduler:s}=i;!s.readOnly&&i.hasClipboardData()!==!1&&(t.pasteEvent={text:"L{pasteEvent}",localeClass:i,icon:"b-icon b-icon-paste",disabled:s.resourceStore.count===0||r.readOnly,weight:110,onItem:({date:n,resourceRecord:a})=>i.pasteEvents(n,a,s.getRowFor(a))})}generateNewName(t){const r=t.getValue(this.nameField);let i=2;for(;this.client.eventStore.findRecord(this.nameField,`${r} - ${i}`);)i++;return`${r} - ${i}`}}p(V,"$name","EventCopyPaste"),p(V,"pluginConfig",{assign:["copyEvents","pasteEvents"],chain:["populateEventMenu","populateScheduleMenu","onEventDataGenerated"]}),p(V,"configurable",{nameField:"name",copyPasteAction:"clone",eventToStringFields:["name","startDate","endDate","duration","durationUnit","allDay"]}),V.featureClass="b-event-copypaste",V._$name="EventCopyPaste",F.registerFeature(V,!0,"Scheduler");class le extends Ve{static get $name(){return"EventDrag"}static get configurable(){return{constrainDragToResource:!1,constrainDragToTimeSlot:!1,externalDropTargetSelector:null,validatorFn:(e,t)=>{},validatorFnThisObj:null,unifiedDrag:null,snapToPosition:null,copyKey:"SHIFT",copyMode:"auto",mode:"move",capitalizedEventName:null}}afterConstruct(){this.capitalizedEventName=this.capitalizedEventName||this.client.capitalizedEventName,super.afterConstruct(...arguments)}changeMode(e){const{dragData:t,copyMode:r}=this;if((r==="event"||r==="auto"||r==="assignment"&&!this.scheduler.eventStore.usesSingleAssignment)&&(!t||t.eventRecords.every(i=>!i.isRecurring)))return e}updateMode(e){this.dragData&&(e==="copy"?this.setCopying():this.setMoving(),this.client.trigger("eventDragModeChange",{mode:e}))}setCopying(){const{dragData:e}=this;e&&(e.eventBarCopies.some(t=>t.isConnected)?e.eventBarCopies.forEach(t=>{t.classList.remove("b-hidden")}):e.eventBarCopies.forEach(t=>{t.classList.add("b-drag-proxy-copy"),t.classList.remove("b-hidden"),e.context.grabbedParent.appendChild(t),t.retainElement=!0}))}setMoving(){const{dragData:e}=this;e&&e.eventBarCopies.forEach(t=>{t.classList.add("b-hidden")})}get scheduler(){return this.client}onAfterDragStart(e){const t=this,{context:{element:r}}=e;super.onAfterDragStart(e),t.handleKeyDownOrMove(e.event),t.keyEventDetacher=ie.on({element:H.getRootElement(r),keydown:t.handleKeyDownOrMove,keyup:t.handleKeyUp,thisObj:t})}onDragReset(e){var t;super.onDragReset(e),(t=this.keyEventDetacher)===null||t===void 0||t.call(this),this.mode="move"}onDrop(e){var t;return(t=this.dragData.eventBarCopies)===null||t===void 0||t.forEach(r=>r.remove()),super.onDrop(e)}getDraggableElement(e){return e==null?void 0:e.closest(this.drag.targetSelector)}resolveEventRecord(e,t=this.client){return t.resolveEventRecord(e)}isElementDraggable(e,t){var r;const i=this,{client:s}=i,n=i.getDraggableElement(e);if(!n||i.disabled||s.readOnly||e.matches('[class$="-handle"]'))return!1;const a=i.resolveEventRecord(n,s);return!a||!a.isDraggable||a.readOnly?!1:!(((r=s[`is${i.capitalizedEventName}ElementDraggable`])===null||r===void 0?void 0:r.call(s,n,a,e,t))===!1)}getTriggerParams(e){const{assignmentRecords:t,eventRecords:r,resourceRecord:i,browserEvent:s}=e;return{context:e,eventRecords:r,resourceRecord:i,assignmentRecords:t,event:s,domEvent:s}}triggerBeforeEventDrag(e,t){return this.client.trigger(e,t)}triggerEventDrag(e,t){this.client.trigger("eventDrag",Object.assign(this.getTriggerParams(e),{startDate:e.startDate,endDate:e.endDate,newResource:e.newResource}))}triggerDragStart(e){this.client.navigator.skipNextClick=!0,this.client.trigger("eventDragStart",this.getTriggerParams(e))}triggerDragAbort(e){this.client.trigger("eventDragAbort",this.getTriggerParams(e))}triggerDragAbortFinalized(e){this.client.trigger("eventDragAbortFinalized",this.getTriggerParams(e))}triggerAfterDrop(e,t){const r=this;if(r.currentOverClient.trigger("afterEventDrop",Object.assign(r.getTriggerParams(e),{valid:t})),!t){const{assignmentStore:i,eventStore:s}=r.client;r.dragData.initialAssignmentsState.find(({resource:a,assignment:o},l)=>{var c;return!i.includes(o)||!s.includes(o.event)||a.id!==((c=r.dragData.assignmentRecords[l])===null||c===void 0?void 0:c.resourceId)})&&r.client.refresh()}r.client.setTimeout(()=>r.client.navigator.skipNextClick=!1,10)}handleKeyDownOrMove(e){if(this.mode!=="copy"){var t,r;(e.key&&ie.specialKeyFromEventKey(e.key)===((t=this.copyKey)===null||t===void 0?void 0:t.toLowerCase())||e[`${(r=this.copyKey)===null||r===void 0?void 0:r.toLowerCase()}Key`])&&(this.mode="copy")}}handleKeyUp(e){ie.specialKeyFromEventKey(e.key)===this.copyKey.toLowerCase()&&(this.mode="move")}isValidDrop(e){const{newResource:t,resourceRecord:r,browserEvent:i}=e,s=e.draggedEntities[0],{target:n}=i;return t?t.isSpecialRow||t.readOnly?!1:r!==t?!s.event.resources.includes(t):!0:!this.constrainDragToTimeline&&this.externalDropTargetSelector?!!n.closest(this.externalDropTargetSelector):!1}checkDragValidity(e,t){var o;var r;const i=this,s=i.currentOverClient;let n;if((r=e.newResource)!==null&&r!==void 0&&r.readOnly)return!1;if(!s.allowOverlap&&!s.isDateRangeAvailable(e.startDate,e.endDate,e.draggedEntities[0],e.newResource)?n={valid:!1,message:i.L("L{eventOverlapsExisting}")}:n=i.validatorFn.call(i.validatorFnThisObj||i,e,t),!n||n.valid){var a;n=(o=(a=s.checkEventDragValidity)===null||a===void 0?void 0:a.call(s,e,t))!=null?o:n}return n}async updateRecords(e){const t=this,r=t.client,i=t.currentOverClient,s=t.mode==="copy",{draggedEntities:n,timeDiff:a,initialAssignmentsState:o}=e,l=o[0].startDate,c=t.adjustStartDate(l,a);let d;return e.externalDropTarget||(i.timeAxis.timeSpanInAxis(c,j.add(c,n[0].event.durationMS,"ms"))||(e.valid=!1),e.valid&&(r.eventStore.suspendAutoCommit(),i.eventStore.suspendAutoCommit(),d=await t.updateAssignments(r,i,e,s),r.eventStore.resumeAutoCommit(),i.eventStore.resumeAutoCommit())),e.valid&&i.trigger("eventDrop",Object.assign(t.getTriggerParams(e),{isCopy:s,copyMode:t.copyMode,domEvent:e.browserEvent,targetEventRecord:e.targetEventRecord,targetResourceRecord:e.newResource,externalDropTarget:e.externalDropTarget})),d}async updateAssignments(e,t,r,i){const s=this,{copyMode:n}=s,a=e!==t,{isVertical:o}=t,{assignmentStore:l,eventStore:c}=e,{assignmentStore:d,eventStore:u}=t,h=e.isVertical?e.resourceStore:e.store,m=o?t.resourceStore:t.store,{eventRecords:T,assignmentRecords:C,timeDiff:A,initialAssignmentsState:M,resourceRecord:I,newResource:y}=r,{unifiedDrag:E}=s,w=u.usesSingleAssignment||u.usesSingleAssignment!==!1&&c.usesSingleAssignment,G=n==="event"?"event":n==="assignment"?"assignment":w?"event":"assignment",U=s.adjustStartDate(C[0].event.startDate,A),O=[],J=[],k=[],ue=[],ge=[],Q=new Set,ee=h.getAllDataRecords();e.suspendRefresh(),t.suspendRefresh();let K=!1,Ce=!1,$;a?$=m.indexOf(y)-h.indexOf(I):s.constainDragToResource?$=0:o&&m.isGrouped?$=ee.indexOf(I)-ee.indexOf(y):$=h.indexOf(I)-h.indexOf(y),o&&T.forEach((v,S)=>{const g=r.eventBarEls[S];delete v.instanceMeta(e).hasTemporaryDragElement,g.dataset.transient&&g.remove()});const he=r.eventBarEls.slice(),P=[],ne={};for(let v=0;v<C.length;v++){const S=C[v];let g=S.event,f;if(i?(f=S.copy(),ne[S.id]=f):f=S,!f.isOccurrenceAssignment&&(!l.includes(S)||!c.includes(g))){he[v].remove(),he.splice(v,1),C.splice(v,1),v--;continue}const te=M[v],B=g,re=te.startDate,L=te.resource,ye=this.constrainDragToTimeSlot?re:E?U:s.adjustStartDate(re,A);if(l!==d){const x=B.assignments.length>1||i;let b;i?b=f:(b=f.copy(),ne[f.id]=b),b.event&&!w&&(b.event=b.event.id,b.resource=b.resource.id),i||ue.push(f),x||J.push(B),(i&&(n==="event"||n==="auto"&&u.usesSingleAssignment)||!u.getById(B.id))&&(g=u.createRecord({...B.data,id:i&&(n==="event"||n==="auto")?void 0:B.id,calendar:null}),b.set({eventId:g.id,event:g}),O.push(g)),w||k.push(b),f=b}let D=y,Ee=null;if(!E)if(a){if(v>0){const x=h.indexOf(L);D=m.getAt(x+$)||D}}else if($!==0){var me;let x;o&&m.isGrouped?(x=Math.max(Math.min(ee.indexOf(L)-$,ee.length-1),0),D=ee[x]):(x=Math.max(Math.min(h.indexOf(L)-$,h.count-1),0),D=h.getAt(x),D.isSpecialRow&&(D=h.getNext(D,!1,!0)||h.getPrevious(D,!1,!0))),D=(me=D)===null||me===void 0?void 0:me.$original}else D=L;const be=f.resourceId!==D.id;if(be){if(Ee=h.getById(f.resourceId),i&&l===d){f.setData({resource:null,resourceId:null}),f.resource=D,f.event=u.getById(f.eventId);const x=n==="event"||c.usesSingleAssignment&&n==="auto";x&&(g=g.copy(),g.meta.endDateCached=s.adjustStartDate(g.endDate,A),g.endDate=null,f.event=g,u.usesSingleAssignment&&(g.resource=D,g.resourceId=D.id)),!d.find(b=>b.eventId===f.eventId&&b.resourceId===f.resourceId)&&!k.find(b=>b.eventId===f.eventId&&b.resourceId===f.resourceId)&&(x&&O.push(g),k.push(f))}else f.resource=D;g.isEvent&&Q.add(g),K=!0,g.isOccurrence&&g.set("newResource",D),a&&w&&(g.resourceId=D.id)}else i&&(n==="event"||n==="auto"&&c.usesSingleAssignment)&&!O.includes(g)&&(g=g.copy(),g.meta.endDateCached=s.adjustStartDate(g.endDate,A),g.endDate=null,O.push(g),f.event=g,u.usesSingleAssignment&&g.set({resource:D,resourceId:D.id}),k.push(f));if(!ge.find(x=>x.draggedEvent===g)&&!j.isEqual(g.startDate,ye)){for(;!g.isOccurrence&&g.isBatchUpdating;)g.endBatch(!0);i&&!a&&!w&&G==="assignment"&&be||(g.startDate=ye,ge.push({draggedEvent:g,originalStartDate:re})),g.isEvent&&Q.add(g),Ce=!0}t.processEventDrop({eventRecord:g,resourceRecord:D,element:v===0?r.context.element:r.context.relatedElements[v-1],context:r,toScheduler:t,reassignedFrom:Ee,eventsToAdd:O,addedEvents:P,draggedAssignment:f}),t.trigger("processEventDrop",{originalAssignment:S,draggedAssignment:f,context:r,copyMode:n,isCopy:i})}if(l.remove(ue),c.remove(J),d.add(k),i&&l===d){const{syncIdMap:v}=e.foregroundCanvas;Object.entries(ne).forEach(([S,g])=>{const f=v[S];delete v[S],v[g.id]=f})}if(O.length&&P.push(...u.add(O)),!s.constrainDragToTimeline)for(let v=0;v<C.length;v++){const S=ne[C[v].id]||C[v],g=S.event,f=(P==null?void 0:P.find(L=>L.id===g.id))||g,te=r.eventBarEls[v],B=v===0?r.context.element:r.context.relatedElements[v-1],re=t.isInTimeAxis(f);if(delete f.meta.endDateCached,i||fe.removeChild(te.parentElement,te),f.resource&&(o||t.rowManager.getRowFor(f.resource))&&re){if(!f.parent||f.parent.isRoot){const L=_.from(B,t.foregroundCanvas,!0);H.setTopLeft(B,L.y,L.x),fe.addChild(t.foregroundCanvas,B,f.assignments[0].id),a&&t.processCrossSchedulerEventDrop({eventRecord:f,toScheduler:t})}B.classList.remove("b-sch-event-hover","b-active","b-drag-proxy","b-dragging"),B.retainElement=!1}}P==null||P.forEach(v=>Q.add(v)),(ue.length||J.length||k.length||O.length)&&(K=!0),(K||Ce)&&(w&&Q.forEach(v=>v.beginBatch()),await Promise.all([t.project!==e.project?t.project.commitAsync():null,e.project.commitAsync()]),w&&Q.forEach(v=>v.endBatch(!1,!0))),K||(K=ge.some(({draggedEvent:v,originalStartDate:S})=>!j.isEqual(v.startDate,S))),t.resumeRefresh(),e.resumeRefresh(),C.length>0&&(K?(he.forEach(v=>delete v.lastDomConfig),t.refreshWithTransition(),a&&(e.refreshWithTransition(),t.selectedEvents=P)):r.valid=!1)}getProductDragContext(e){const t=this,{currentOverClient:r}=t,i=e.browserEvent.target,s=e.newResource||e.resourceRecord,n=e.targetEventRecord;let a=r?t.resolveEventRecord(i,r):null,o,l;e.eventRecords.includes(a)&&(a=null),t.constrainDragToResource?o=e.resourceRecord:t.constrainDragToTimeline?r&&(o=t.resolveResource()||e.newResource||e.resourceRecord):o=t.resolveResource();const{assignmentRecords:c,eventRecords:d}=e,u=s!==o;let h=!!(o&&!o.isSpecialRow);return!o&&t.externalDropTargetSelector&&(l=i.closest(t.externalDropTargetSelector),h=!!l),{valid:h,externalDropTarget:l,eventRecords:d,assignmentRecords:c,newResource:o,targetEventRecord:a,dirty:u||a!==n,proxyElements:[e.context.element,...e.context.relatedElements||[]]}}getMinimalDragData(e){const t=this,{scheduler:r}=t,i=t.getElementFromContext(e),s=t.resolveEventRecord(i,r),n=r.resolveResourceRecord(i),a=r.resolveAssignmentRecord(i),o=a?[a]:[];a&&(r.isAssignmentSelected(o[0])||t.drag.startEvent.ctrlKey&&r.multiEventSelect)&&o.push.apply(o,t.getRelatedRecords(a));const l=[...new Set(o.map(c=>c.event))];return{eventRecord:s,resourceRecord:n,assignmentRecord:a,eventRecords:l,assignmentRecords:o}}setupProductDragData(e){var t;const r=this,{scheduler:i}=r,s=r.getElementFromContext(e),{eventRecord:n,resourceRecord:a,assignmentRecord:o,assignmentRecords:l}=r.getMinimalDragData(e),c=[];if(r.constrainDragToResource&&!a)throw new Error("Resource could not be resolved for event: "+n.id);let d;if(r.constrainDragToTimeline){var u;d=(u=r.getDateConstraints)===null||u===void 0?void 0:u.call(r,a,n);const h=r.constrainRectangle=r.getConstrainingRectangle(d,a,n),m=_.from(s,i.timeAxisSubGridElement);super.setupConstraints(h,m,i.timeAxisViewModel.snapPixelAmount,!!d.start)}return l.forEach(h=>{let m=i.getElementFromAssignmentRecord(h,!0);m||(m=i.currentOrientation.addTemporaryDragElement(h.event,h.resource)),c.push(m)}),{record:o,draggedEntities:l,dateConstraints:(t=d)!==null&&t!==void 0&&t.start?d:null,eventBarCopies:c.map(h=>r.createProxy(h)),eventBarEls:c}}getDateConstraints(e,t){var r;const{scheduler:i}=this,s=(r=i.getDateConstraints)===null||r===void 0?void 0:r.call(i,e,t);let n,a;return this.constrainDragToTimeSlot?(n=t.startDate,a=t.endDate):s&&(n=s.start,a=s.end),{start:n,end:a}}getConstrainingRectangle(e,t,r){return this.scheduler.getScheduleRegion(this.constrainDragToResource&&t,r,!0,e&&{start:e.start,end:e.end})}getDragData(e){const t=this.getMinimalDragData(e)||{};return{...super.getDragData(e),...t,initialAssignmentsState:t.assignmentRecords.map(r=>({startDate:r.event.startDate,resource:r.resource,assignment:r}))}}getRelatedRecords(e){return this.scheduler.selectedAssignments.filter(t=>t!==e&&!t.resource.readOnly&&t.event.isDraggable)}getCoordinate(e,t,r){const i=this.currentOverClient;if(i.isHorizontal){let s=r[0];if(i.milestoneLayoutMode!=="default"&&e.isMilestone)switch(i.milestoneAlign){case"center":s+=t.offsetWidth/2;break;case"end":s+=t.offsetWidth;break}return s}else{let s=r[1];if(i.milestoneLayoutMode!=="default"&&e.isMilestone)switch(i.milestoneAlign){case"center":s+=t.offsetHeight/2;break;case"end":s+=t.offsetHeight;break}return s}}resolveResource(){const e=this,t=e.currentOverClient,{isHorizontal:r}=t,{context:i,browserEvent:s,dragProxy:n}=e.dragData,a=n||i.element,o=_.from(a,null,!0),l=t.isVertical||e.unifiedDrag?i.clientY:o.center.y,c=_.from(a,t.timeAxisSubGridElement,!0),{x:d,y:u}=c.center,h=e.getMouseMoveEventTarget(s);let m=null;if(t.element.contains(h))if(r){const T=t.rowManager.getRowAt(l);m=T&&t.store.getAt(T.dataIndex)}else m=t.resolveResourceRecord(t.timeAxisSubGridElement.querySelector(".b-sch-timeaxis-cell"),[d,u]);return m}adjustStartDate(e,t){const r=this.currentOverClient;return e=r.timeAxis.roundDate(new Date(e-0+t),r.snapRelativeToEventStartDate?e:!1),this.constrainStartDate(e)}getRecordElement(e){return this.client.getElementFromAssignmentRecord(e,!0)}getProxyElement(e){if(this.isDragging){const t=this.dragData.assignmentRecords.indexOf(e);if(t>=0)return this.dragData.proxyElements[t]}return null}getMouseMoveEventTarget(e){return e.target}}le._$name="EventDrag",F.registerFeature(le,!0,"Scheduler"),F.registerFeature(le,!1,"ResourceHistogram");class q extends Ne{get scheduler(){return this.client}get store(){return this.client.eventStore}get project(){return this.client.project}updateLockLayout(e){this.dragActiveCls=`b-dragcreating${e?" b-dragcreate-lock":""}`}handleBeforeDragCreate(e,t,r){var i;const{resourceRecord:s}=e;if(s.readOnly||!this.scheduler.resourceStore.isAvailable(s))return!1;const{scheduler:n}=this,a=!n.isSchedulerPro||t.ignoreResourceCalendar||s.isWorkingTime(e.mousedownDate),o=a&&n.trigger("beforeDragCreate",{resourceRecord:s,date:e.mousedownDate,event:r});return this.dateConstraints=(i=n.getDateConstraints)===null||i===void 0?void 0:i.call(n,s,t),o}dragStart(e){var t;const r=this,{client:i}=r,{eventStore:s,assignmentStore:n,enableEventAnimations:a,enableTransactionalFeatures:o}=i,{resourceRecord:l}=e,c=r.createEventRecord(e),d=[l];if(c.set("duration",j.diff(c.startDate,c.endDate,c.durationUnit,!0)),c.isCreating=!0,c.meta.isDragCreating=!0,i.features.taskEdit&&i.features.taskEdit.doCancel(),r.handleBeforeDragCreate(e,c,e.event)===!1)return!1;r.captureStm(!0);let u=[];return l&&(s.usesSingleAssignment||!o?u=n.assignEventToResource(c,l):u=[n.createRecord({event:c,resource:l})]),i.trigger("beforeEventAdd",{eventRecord:c,resourceRecords:d,assignmentRecords:u})===!1?((s.usesSingleAssignment||!o)&&n.remove(u),!1):(r.lockLayout&&(c.meta.excludeFromLayout=!0),(t=i.onEventCreated)===null||t===void 0||t.call(i,c),i.enableEventAnimations=!1,s.addAsync(c).then(()=>i.enableEventAnimations=a),!s.usesSingleAssignment&&o&&n.add(u[0]),i.isCreating=!0,i.refreshRows(),i.isCreating=!1,e.itemElement=e.element=i.getElementFromEventRecord(c),H.isInView(e.itemElement)||i.scrollable.scrollIntoView(e.itemElement,{animate:!0,edgeOffset:i.barMargin}),super.dragStart(e))}checkValidity(e,t){const r=this,{client:i}=r;return e.resourceRecord=r.dragging.resourceRecord,(i.allowOverlap||i.isDateRangeAvailable(e.startDate,e.endDate,e.eventRecord,e.resourceRecord))&&r.createValidatorFn.call(r.validatorFnThisObj||r,e,t)}isRowEmpty(e){const t=this.store.getEventsForResource(e);return!t||!t.length}triggerBeforeFinalize(e){this.client.trigger("beforeDragCreateFinalize",e)}createEventRecord(e){const t=this,{client:r}=t,i=r.isHorizontal?"X":"Y",{timeAxis:s,eventStore:n,weekStartDay:a}=r,{event:o,mousedownDate:l}=e,c=t.draggingEnd=o[`page${i}`]>e.startEvent[`page${i}`],d={name:n.modelClass.fieldMap.name.defaultValue||t.L("L{Object.newEvent}"),startDate:c?j.floor(l,s.resolution,null,a):l,endDate:c?l:j.ceil(l,s.resolution,null,a)};return r.project.isGanttProjectMixin&&z.assign(d,{constraintDate:d.startDate,constraintType:"startnoearlierthan"}),n.createRecord(d)}async internalUpdateRecord(e,t){await super.internalUpdateRecord(e,t),this.client.hasEventEditor||(e.eventRecord.isCreating=!1)}async finalizeDragCreate(e){const{meta:t}=e.eventRecord;t.excludeFromLayout=!1,t.isDragCreating=!1;const r=await super.finalizeDragCreate(e);return r?this.hasStmCapture=!1:await this.freeStm(!0),r}async cancelDragCreate(e){await super.cancelDragCreate(e),await this.freeStm(!1)}getTipHtml(...e){const t=super.getTipHtml(...e),{element:r}=this.tip;return r.classList.add("b-sch-dragcreate-tooltip"),r.classList.toggle("b-too-narrow",this.dragging.context.tooNarrow),t}onAborted(e){var t,r;const{eventRecord:i,resourceRecord:s}=e;(t=(r=this.store).unassignEventFromResource)===null||t===void 0||t.call(r,i,s),this.store.remove(i)}}p(q,"$name","EventDragCreate"),p(q,"configurable",{validatorFn:()=>!0,lockLayout:!1}),q._$name="EventDragCreate",F.registerFeature(q,!0,"Scheduler"),F.registerFeature(q,!1,"ResourceHistogram");const Ae=[0,0],Ze=[null,[0,10],[10,0]];class ce extends Ue{static get $name(){return"EventTooltip"}static get defaultConfig(){return{template:e=>`
                ${e.eventRecord.name?Te.xss`<div class="b-sch-event-title">${e.eventRecord.name}</div>`:""}
                ${e.startClockHtml}
                ${e.endClockHtml}`,cls:"b-sch-event-tooltip",monitorRecordUpdate:!0,scrollAction:"hide"}}construct(e,t){super.construct(e,t),typeof this.align=="string"&&(this.align={align:this.align})}onPaint({firstPaint:e}){if(super.onPaint(...arguments),e){const{dependencies:t}=this.client.features;t&&this.tooltip.ion({beforeAlign({source:r,offset:i=Ae}){const{edgeAligned:s}=Ie(r.align.align),n=t.disabled?Ae:Ze[s];arguments[0].offset=[i[0]+n[0],i[1]+n[1]]}})}}}ce._$name="EventTooltip",F.registerFeature(ce,!0,"Scheduler"),F.registerFeature(ce,!1,"ResourceHistogram");const qe={width:0,height:0};class N extends ae{construct(e,t){super.construct(e,t),e.isVertical&&(this.toUpdate=new Set,e.ion({scroll:"onSchedulerScroll",horizontalScroll:"onHorizontalScroll",thisObj:this,prio:1e4}))}onEventDataGenerated(e){this.client.isHorizontal?e.wrapperCls["b-disable-sticky"]=e.eventRecord.stickyContents===!1:(this.syncEventContentPosition(e,void 0,!0),this.updateStyles())}onSchedulerScroll(){this.disabled||this.verticalSyncAllEventsContentPosition(this.client)}onHorizontalScroll({subGrid:e}){e===this.client.timeAxisSubGrid&&this.verticalSyncAllEventsContentPosition(this.client)}updateStyles(){for(const{contentEl:e,style:t}of this.toUpdate)H.applyStyle(e,t);this.toUpdate.clear()}verticalSyncAllEventsContentPosition(e){const{resourceMap:t}=e.currentOrientation;for(const r of t.values())for(const{renderData:i,elementConfig:s}of Object.values(r)){const n=[i];s&&i.eventRecord.isResourceTimeRange&&n.push(s.children[0]),this.syncEventContentPosition.apply(this,n)}this.toUpdate.size&&this.updateStyles()}syncEventContentPosition(e,t=e.eventContent,r=!1){if(this.disabled||e.eventRecord.stickyContents===!1)return;const{client:i}=this,{eventRecord:s,resourceRecord:n,useEventBuffer:a,bufferAfterWidth:o,bufferBeforeWidth:l,top:c,height:d}=e,u=i.scrollable.y,h=r?null:i.getElementFromEventRecord(s,n,!0),m=h&&fe.getChild(h,"event.content"),T=s.instanceMeta(i),C=typeof t.style=="string"?t.style=H.parseStyle(t.style):t.style||(t.style={});if(h!=null&&h.classList.contains("b-dragging"))return;let A=c,M=d,I=A+M;if(a&&(A+=l,M=M-l-o,I=A+M),A<u&&I>=u&&!s.isMilestone){const y=m==null?void 0:m.offsetWidth,E=(m==null?void 0:m.parentNode)&&H.getStyleValue(m.parentNode,"justifyContent"),w=E==="center"?(e.width-y)/2:0,G=A,U=G+M-1;if((!m||y)&&G<u&&U>=u){const O=this.getEventContentMargins(m),J=m?M-m.offsetHeight-O.height-w:Number.MAX_SAFE_INTEGER,k=Math.min(u-G,J-2);C.transform=k>0?`translateY(${k}px)`:"",T.stuck=!0}else C.transform="",T.stuck=!1;m&&this.toUpdate.add({contentEl:m,style:C})}else m&&T.stuck&&(C.transform="",T.stuck=!1,this.toUpdate.add({contentEl:m,style:C}))}getEventContentMargins(e){return e!=null&&e.classList.contains("b-sch-event-content")?H.getEdgeSize(e,"margin"):qe}doDisable(){super.doDisable(...arguments),this.isConfiguring||this.client.refreshWithTransition()}}p(N,"$name","StickyEvents"),p(N,"type","stickyEvents"),p(N,"pluginConfig",{chain:["onEventDataGenerated"]}),N._$name="StickyEvents",F.registerFeature(N,!0,"Scheduler"),F.registerFeature(N,!1,"ResourceHistogram");class de extends Ke.mixin(pe){static get $name(){return"TimeRanges"}static get defaultConfig(){return{store:!0}}doDestroy(){var e;(e=this.storeDetacher)===null||e===void 0||e.call(this),super.doDestroy()}get timeRanges(){const e=this;if(!e._timeRanges){const{store:t}=e;let{records:r}=t;if(t.recurringEvents){const{startDate:i,endDate:s}=e.client.timeAxis;r=r.flatMap(n=>n.isRecurring?n.getOccurrencesForDateRange(i,s):n)}e.currentTimeLine&&(t.recurringEvents||(r=r.slice()),r.push(e.currentTimeLine)),e._timeRanges=r}return e._timeRanges}attachToProject(e){var t;super.attachToProject(e);const r=this;if((t=r.projectTimeZoneChangeDetacher)===null||t===void 0||t.call(r),r.showCurrentTimeLine){var i;r.projectTimeZoneChangeDetacher=(i=r.client.project)===null||i===void 0?void 0:i.ion({timeZoneChange:()=>r.updateCurrentTimeLine()}),r.currentTimeLine&&r.updateCurrentTimeLine()}}initCurrentTimeLine(){const e=this;if(e.currentTimeLine||!e.showCurrentTimeLine)return;const t=typeof e.showCurrentTimeLine=="object"?e.showCurrentTimeLine:{};e.currentTimeLine=e.store.modelClass.new({id:"currentTime",cls:"b-sch-current-time"},t),e.currentTimeInterval=e.setInterval(()=>e.updateCurrentTimeLine(),e.currentTimeLineUpdateInterval),e._timeRanges=null,e.updateCurrentTimeLine()}updateCurrentTimeLine(){var e;const t=this,{currentTimeLine:r}=t;r.timeZone=(e=t.project)===null||e===void 0?void 0:e.timeZone,r.setLocalDate("startDate",new Date),r.endDate=r.startDate,r.originalData.name||(r.name=j.format(r.startDate,t.currentDateFormat)),t.renderRanges()}hideCurrentTimeLine(){const e=this;e.currentTimeLine&&(e.clearInterval(e.currentTimeInterval),e.currentTimeLine=null,e.refresh())}updateShowCurrentTimeLine(e){e?this.initCurrentTimeLine():this.hideCurrentTimeLine()}populateTimeAxisHeaderMenu({items:e}){e.currentTimeLine={weight:400,text:this.L("L{showCurrentTimeLine}"),checked:this.currentTimeLine,onToggle:({checked:t})=>this.updateShowCurrentTimeLine(t&&this.showCurrentTimeLine)}}attachToStore(e){const t=this;let r=!1;t.storeDetacher&&(t.storeDetacher(),r=!0),t.storeDetacher=e.ion({change:"onStoreChange",refresh:"onStoreChange",thisObj:t}),t._timeRanges=null,r&&t.renderRanges()}get store(){return this.client.project.timeRangeStore}updateStore(e){const t=this,{client:r}=t,{project:i}=r;e=i.timeRangeStore,t.attachToStore(e),r.timeRanges&&!r._timeRangesExposed&&(e.add(r.timeRanges),delete r.timeRanges)}attachToTimeRangeStore(e){this.store=e}resolveTimeRangeRecord(e){return this.store.getById(e.closest(this.baseSelector).dataset.id)}onStoreChange({type:e,action:t}){const r=this;r._timeRanges=null,!(r.disabled||!r.client.isVisible||r.isConfiguring||e==="refresh"&&t!=="batch")&&r.client.runWithTransition(()=>r.renderRanges(),!r.client.refreshSuspended)}onDragStart(e){const t=this,{context:r}=e,i=t.resolveTimeRangeRecord(r.element.closest(t.baseSelector)),s=t.getBodyElementByRecord(i);r.relatedElements=[s],Object.assign(r,{record:i,rangeBodyEl:s,originRangeX:H.getTranslateX(s),originRangeY:H.getTranslateY(s)}),super.onDragStart(e),t.showTip(r)}onDrop(e){const{context:t}=e;if(!t.valid)return this.onInvalidDrop({context:t});const r=this,{client:i}=r,{record:s}=t,n=_.from(t.rangeBodyEl),a=i.getDateFromCoordinate(n.getStart(i.rtl,i.isHorizontal),"round",!1);s.startDate-a!==0?s.setStartDate(a):r.onInvalidDrop(),r.destroyTip(),super.onDrop(e)}onResizeStart({context:e}){const t=this,r=t.resolveTimeRangeRecord(e.element.closest(t.baseSelector)),i=t.getBodyElementByRecord(r);Object.assign(e,{record:r,rangeBodyEl:i}),t.showTip(e)}onResizeDrag({context:e}){const t=this,{rangeBodyEl:r}=e,{client:i}=t,s=_.from(e.element),n=s.getStart(i.rtl,i.isHorizontal),a=s.getEnd(i.rtl,i.isHorizontal),o=i.getDateFromCoordinate(n,"round",!1),l=i.getDateFromCoordinate(a,"round",!1);t.client.isVertical?(e.edge==="top"&&H.setTranslateY(r,e.newY),r.style.height=e.newHeight+"px"):(e.edge==="left"&&H.setTranslateX(r,e.newX),r.style.width=e.newWidth+"px"),t.updateDateIndicator({startDate:o,endDate:l})}onResize({context:e}){if(!e.valid)return this.onInvalidDrop({context:e});const t=this,{client:r}=t,{rtl:i}=r,s=e.record,n=_.from(e.element),a=n.getStart(i,r.isHorizontal),o=n.getEnd(i,r.isHorizontal),l=r.getDateFromCoordinate(a,"round",!1),c=i&&e.edge==="right"||!i&&e.edge==="left"||e.edge==="top",d=r.getDateFromCoordinate(o,"round",!1);(c&&s.startDate-l!==0||d&&s.endDate-d!==0)&&d>l?c?s.setStartDate(l,!1):s.setEndDate(d,!1):t.onInvalidResize({context:e}),t.destroyTip()}onInvalidResize({context:e}){const t=this;t.resize.reset(),e.rangeBodyEl.parentElement.lastDomConfig=e.rangeBodyEl.lastDomConfig=null,t.renderRanges(),t.destroyTip()}}p(de,"configurable",{store:{modelClass:ze},currentTimeLineUpdateInterval:1e4,currentDateFormat:"HH:mm",showCurrentTimeLine:!1}),de._$name="TimeRanges",F.registerFeature(de,!1,["Scheduler","Gantt"]);var He=R=>{var e;return e=class extends(R||Se){static get properties(){return{recordsToRefresh:new Set}}beforeRenderRow({record:r}){var i;return(i=this.recordIsReadyForRendering)!==null&&i!==void 0&&i.call(this,r)&&this.unscheduleRecordRefresh(r),super.beforeRenderRow(...arguments)}cleanupScheduledRecord(){const{rowManager:r,store:i}=this;for(const s of[...this.recordsToRefresh])(!s.stores.includes(i)||!r.getRowById(s))&&this.recordsToRefresh.delete(s)}renderScheduledRecords(){const r=this;if(r.refreshSuspended)r.scheduleRecordRefresh();else{r.cleanupScheduledRecord();const{rowManager:i}=r,s=[...r.recordsToRefresh],n=s.map(a=>i.getRowById(a));n.length&&(i.renderRows(n),r.trigger("scheduledRecordsRender",{records:s,rows:n})),r.recordsToRefresh.size&&r.scheduleRecordRefresh()}}unscheduleRecordRefresh(r=!0){const i=this;r===!0?i.recordsToRefresh.clear():r&&ve.asArray(r).forEach(s=>i.recordsToRefresh.delete(s)),i.scheduledRecordsRefreshTimer&&!i.recordsToRefresh.size&&i.clearTimeout(i.scheduledRecordsRefreshTimer)}scheduleRecordRefresh(r){const i=this;r&&ve.asArray(r).forEach(s=>i.recordsToRefresh.add(s)),i.scheduledRecordsRefreshTimer=i.setTimeout({fn:"renderScheduledRecords",delay:i.scheduledRecordsRefreshTimeout,cancelOutstanding:!0})}get widgetClass(){}},p(e,"$name","DelayedRecordsRendering"),p(e,"configurable",{scheduledRecordsRefreshTimeout:10}),e};class De extends Se{construct(e){super.construct(),this.client=e}init(){}onTimeAxisViewModelUpdate(){const{scrollable:e}=this.client.timeAxisSubGrid;this.updateFromHorizontalScroll(e.x)}updateFromHorizontalScroll(e){const t=this,{client:r,scrollBuffer:i}=t,{timeAxisSubGrid:s,timeAxis:n,rtl:a}=r,{width:o}=s,{totalSize:l}=r.timeAxisViewModel,c=e,d=s.scrollable.maxX!==0&&Math.abs(s.scrollable.maxX)<=Math.round(c)+5,u=r.getDateFromCoord({coord:Math.max(0,c-i),ignoreRTL:!0}),h=d?n.endDate:r.getDateFromCoord({coord:c+o+i,ignoreRTL:!0})||n.endDate;if(u&&!r._viewPresetChanging){t._visibleDateRange={startDate:u,endDate:h,startMS:u.getTime(),endMS:h.getTime()},t.viewportCoords=a?{left:l-e-o+i,right:l-e-i}:{left:e-i,right:e+o+i};const m=r.timeView.range={startDate:u,endDate:h};if(r.onVisibleDateRangeChange(m),!r.refreshSuspended&&r.rowManager.rows.length){if(r.rowManager.rows[0].id===null)return;(t._timeAxisStartDate-n.startDate||t._timeAxisEndDate-n.endDate)&&(t._timeAxisStartDate=n.startDate,t._timeAxisEndDate=n.endDate,r.rowManager.renderRows(r.rowManager.rows))}}}onViewportResize(){}refreshRows(){}get visibleDateRange(){return this._visibleDateRange}translateToPageCoordinate(e){const{client:t}=this,{scrollable:r}=t.timeAxisSubGrid;let i=e+t.timeAxisSubGridElement.getBoundingClientRect().left;return t.rtl?i-=r.maxX-Math.abs(t.scrollLeft):i-=t.scrollLeft,i}translateToScheduleCoordinate(e){const{client:t}=this,{scrollable:r}=t.timeAxisSubGrid;let i=e-t.timeAxisSubGridElement.getBoundingClientRect().left-globalThis.scrollX;return t.rtl?i+=r.maxX-Math.abs(t.scrollLeft):i+=t.scrollLeft,i}getDateFromXY(e,t,r,i=!1){const{client:s}=this;let n=e[0];return r||(n=this.translateToScheduleCoordinate(n)),n=s.getRtlX(n),s.timeAxisViewModel.getDateFromPosition(n,t,i)}}p(De,"configurable",{scrollBuffer:0}),De._$name="TimelineHistogramRendering";const Je={series:null,topValue:null},Qe=()=>{};class W extends _e.mixin(He){static get properties(){return{histogramDataByRecord:new Map,collectingDataFor:new Map}}updateGetRecordData(e){this._getRecordData=e?this.resolveCallback(e):null}updateHardRefreshOnTimeAxisReconfigure(e){const t="hardRefreshOnTimeAxisReconfigure";e?this.timeAxis.ion({name:t,endReconfigure:"onTimeAxisEndReconfigure",thisObj:this}):this.detachListeners(t)}construct(e){super.construct(e);const t=this;t.scheduleRefreshRows=t.createOnFrame(t.refreshRows,[],t,!0),t.rowManager.ion({beforeRowHeight:"onBeforeRowHeight",thisObj:t})}onDestroy(){var e;this.clearHistogramDataCache(),(e=this._histogramWidget)===null||e===void 0||e.destroy(),this.barTooltip=null}resolveTimeSpanRecord(e){}getScheduleMouseEventParams(e,t){return{record:this.store.getById(e.id)}}get currentOrientation(){return this._currentOrientation||(this._currentOrientation=new De(this)),this._currentOrientation}updateSeries(e){const t=this;t.histogramWidget.series=e,t._series=t.histogramWidget.series,t.isPainted&&!t.isConfiguring&&t.scheduleRefreshRows()}getAsyncEventSuffixForStore(e){return e.isAbstractPartOfProjectStoreMixin?"PreCommit":""}scheduleRefreshRows(){}getRowHeight(){return this.rowHeight}onPaint({firstPaint:e}){super.onPaint({firstPaint:e}),e&&this.showBarTip&&(this.barTooltip={})}updateGetBarTip(e){return e&&(this.barTooltipTemplate=null),e}changeBarTooltip(e,t){return t==null||t.destroy(),e?e.isTooltip?e:this.barTooltipClass.new({forElement:this.timeAxisSubGridElement,forSelector:".b-histogram rect",hoverDelay:0,trackMouse:!1,cls:"b-celltooltip-tip",getHtml:this.getTipHtml.bind(this)},this.showBarTip,e):null}async getTipHtml(e){if(this.showBarTip&&this.barTooltipTemplate){const{activeTarget:t}=e,r=parseInt(t.dataset.index,10),i=this.getRecordFromElement(t),s=await this.getRecordHistogramData(i);return this.barTooltipTemplate({...e,datum:this.extractHistogramDataArray(s,i)[r],record:i,index:r})}}collectTicksWidth(){const{ticks:e}=this.timeAxis,t=e[0].endDate-e[0].startDate,r={0:t};let i=t,s=!0;for(let n=1,{length:a}=e;n<a;n++){const o=e[n],l=o.endDate-o.startDate;t!==l&&(s=!1),i+=l,r[n]=l}if(s)this.ticksWidth=null;else{const n={};for(let a=0,{length:o}=e;a<o;a++)n[a]=r[a]/i;this.ticksWidth=n}}changeHistogramWidget(e){const t=this;if(e&&!e.isHistogram){var r;t.getBarTextRenderData&&!e.getBarTextRenderData&&(e.getBarTextRenderData=t.getBarTextRenderData),e=t.histogramWidgetClass.new({owner:t,appendTo:t.element,height:t.rowHeight,width:((r=t.timeAxisColumn)===null||r===void 0?void 0:r.width)||0,getBarTip:!t.barTooltipTemplate&&t.getBarTip||Qe,getRectClass:t.getRectClass||t.getRectClassDefault,getBarText:t.getBarText||t.getBarTextDefault,getOutlineClass:t.getOutlineClass,getRectConfig:t.getRectConfig},e),e.suspendRefresh(),t.getBarTextDefault=t.getBarTextDefault.bind(e)}return e}getRectClassDefault(e,t,r){}getBarTextDefault(e,t){}updateShowBarTip(e){this.barTooltip=e}get columns(){return super.columns}set columns(e){const t=this;super.columns=e,t.isDestroying||(t.timeAxisColumn.renderer=t.histogramRenderer.bind(t),t.timeAxisColumn.cellCls=t.timeAxisColumnCellCls)}onHistogramDataCacheSet({record:e,data:t}){this.scheduleRecordRefresh(e)}onTimeAxisEndReconfigure(){this.hardRefreshOnTimeAxisReconfigure&&(this.clearHistogramDataCache(),this.scheduleRefreshRows())}onStoreUpdateRecord({record:e,changes:t}){const r=this;return!r.getRecordData&&r.dataModelField&&t[r.dataModelField]&&r.clearHistogramDataCache(e),super.onStoreUpdateRecord(...arguments)}onStoreRemove({records:e}){super.onStoreRemove(...arguments);for(const t of e)this.clearHistogramDataCache(t)}onBeforeRowHeight({height:e}){if(this._timeAxisColumn){const t=this._histogramWidget;t&&(t.height=e,t.onElementResize(t.element))}}onTimeAxisViewModelUpdate(){super.onTimeAxisViewModelUpdate(...arguments);const e=this._histogramWidget;e&&(e.width=this.timeAxisViewModel.totalSize,e.onElementResize(e.element)),this.collectTicksWidth()}extractHistogramDataArray(e,t){return e}processRecordRenderData(e){return e}clearHistogramDataCache(e){e?this.histogramDataByRecord.delete(e):this.histogramDataByRecord.clear()}setHistogramDataCache(e,t){const r={record:e,data:t};this.trigger("beforeHistogramDataCacheSet",r),this.histogramDataByRecord.set(r.record,r.data),this.trigger("histogramDataCacheSet",r)}getHistogramDataCache(e){return e?this.histogramDataByRecord.get(e):this.histogramDataByRecord}hasHistogramDataCache(e){return this.histogramDataByRecord.has(e)}finalizeDataRetrievingInternal(e,t){return this.collectingDataFor.delete(e),this.setHistogramDataCache(e,t),t}finalizeDataRetrieving(e,t){return X.isPromise(t)?(this.collectingDataFor.set(e,t),t.then(r=>this.finalizeDataRetrievingInternal(e,r))):this.finalizeDataRetrievingInternal(e,t)}getRecordHistogramData(e){const t=this,{getRecordData:r}=t;let i=t.collectingDataFor.get(e)||t.getHistogramDataCache(e);return!i&&!t.hasHistogramDataCache(e)&&(r?i=r.handler.call(r.thisObj,...arguments):i=e.get(t.dataModelField),i=t.finalizeDataRetrieving(e,i)),i}recordIsReadyForRendering(e){return!this.collectingDataFor.has(e)}beforeRenderRow(e){const t=this,r=t.getRecordHistogramData(e.record);if(!X.isPromise(r)){const i=r?t.extractHistogramDataArray(r,e.record):[];if(t.ticksWidth)for(let n=0,{length:a}=i;n<a;n++)i[n].width=t.ticksWidth[n];const s=X.merge({topValue:null},t.initialConfig.histogramWidget,{data:i,series:{...t.series}});e={...e,histogramConfig:s,histogramData:r,histogramWidget:t.histogramWidget},t.trigger("beforeRenderHistogramRow",e),delete e.eventName,delete e.source,delete e.type,delete e.oldId,delete e.row,delete e.recordIndex,t._recordRenderData=t.processRecordRenderData(e)}super.beforeRenderRow(...arguments)}applyHistogramWidgetConfig(e=this.histogramWidget,t){Object.assign(e,Je,t)}renderRecordHistogram(e){const t=this,{histogramData:r,cellElement:i}=e;if(!r){i.innerHTML="";return}t.trigger("beforeRenderRecordHistogram",e),delete e.eventName,delete e.type,delete e.source;const s=e.histogramWidget||t.histogramWidget;t.applyHistogramWidgetConfig(s,e.histogramConfig),s.refresh({args:[e]});const n=s.element.cloneNode(!0);n.removeAttribute("id"),n.classList.remove("b-hide-offscreen"),i.innerHTML="",i.appendChild(n)}histogramRenderer(e){const t=this,r=e.histogramData||t.getRecordHistogramData(e.record);return X.isPromise(r)?"":(Object.assign(e,t._recordRenderData),t.renderRecordHistogram(...arguments))}buildGroupHeader(e){return e.column===this.timeAxisColumn?this.histogramRenderer(e):this.features.group.buildGroupHeader(e)}get widgetClass(){}}p(W,"$name","TimelineHistogramBase"),p(W,"type","timelinehistogrambase"),p(W,"configurable",{timeAxisColumnCellCls:"b-sch-timeaxis-cell b-timelinehistogram-cell",mode:"horizontal",rowHeight:50,showBarTip:!1,barTooltip:null,barTooltipClass:$e,series:null,dataModelField:"histogramData",getRecordData:null,hardRefreshOnTimeAxisReconfigure:!0,getRectClass:null,getOutlineClass(e){return""},readOnly:!0,getBarTip:null,barTooltipTemplate:null,getBarText:null,getRectConfig:null,getBarTextRenderData:void 0,histogramWidgetClass:Ye,histogramWidget:{cls:"b-hide-offscreen b-timelinehistogram-histogram",omitZeroHeightBars:!0,data:[]},fixedRowHeight:!0}),W.initClass(),W._$name="TimelineHistogramBase";var Fe=R=>{var e;return e=class extends(R||W){afterConfigure(){const r=this;r.internalAggregateDataEntry=r.internalAggregateDataEntry.bind(this),r.internalInitAggregatedDataEntry=r.internalInitAggregatedDataEntry.bind(this),super.afterConfigure(),r.features.treeGroup&&r.features.treeGroup.ion({beforeDataLoad:r.onTreeGroupBeforeDataLoad,thisObj:r})}updateAggregateFunctions(r){for(const[i,s]of Object.entries(r))if(s.id=i,s.aliases)for(const n of s.aliases)r[n]=s}updateStore(r){super.updateStore(...arguments),this.detachListeners("store"),r&&r.ion({name:"store",group:this.onStoreGroup,thisObj:this})}changeAggregateDataEntry(r){return this.bindCallback(r)}changeGetDataEntryForAggregating(r){return this.bindCallback(r)}changeInitAggregatedDataEntry(r){return this.bindCallback(r)}onHistogramDataCacheSet({record:r,data:i}){super.onHistogramDataCacheSet(...arguments),this.aggregateHistogramDataForGroups&&this.scheduleRecordParentsRefresh(r)}onTreeGroupBeforeDataLoad(){this.aggregateHistogramDataForGroups&&this.resetGeneratedRecordsHistogramDataCache()}onStoreGroup(){this.aggregateHistogramDataForGroups&&this.resetGeneratedRecordsHistogramDataCache()}getRecordHistogramData(r,i){const s=this;let n;return s.aggregateHistogramDataForGroups&&s.isGroupRecord(r)?(n=s.collectingDataFor.get(r)||s.getHistogramDataCache(r),!n&&!s.hasHistogramDataCache(r)&&(n=s.getGroupRecordHistogramData(r,i),n=s.finalizeDataRetrieving(r,n))):n=super.getRecordHistogramData(...arguments),n}internalAggregateDataEntry(r,...i){const{aggregateFunctions:s}=this;for(const{id:n,aggregate:a="sum"}of Object.values(this.series)){let o;a!==!1&&(o=s[a].entry)&&(r=o(n,r,...i))}return this.aggregateDataEntry?this.aggregateDataEntry(r,...i):r}internalInitAggregatedDataEntry(){const r=this.initAggregatedDataEntry?this.initAggregatedDataEntry(...arguments):{},{aggregateFunctions:i}=this;for(const{id:s,aggregate:n="sum"}of Object.values(this.series)){const a=i[n].init;a&&n!==!1&&a(s,r,...arguments)}return r}resetGeneratedRecordsHistogramDataCache(){const{store:r}=this;for(const i of this.getHistogramDataCache().keys())(i.isGroupHeader||i.generatedParent||i.isLinked&&!r.includes(i))&&this.clearHistogramDataCache(i)}setHistogramDataCache(r,i){if(super.setHistogramDataCache(r,i),r.isLinked)super.setHistogramDataCache(r.$original,i);else if(r.$links){const{store:s}=this;for(const n of r.$links)s.includes(n)&&super.setHistogramDataCache(n,i)}}getHistogramDataCache(r){let i=super.getHistogramDataCache(r);return!i&&r.isLinked&&(i=super.getHistogramDataCache(r.$original)),i}getGroupRecordHistogramData(r,i={}){i.parentRecord=r;const s=this.aggregateRecordsHistogramData(this.getGroupChildren(r),i);return X.isPromise(s)?s.then(n=>n):s}aggregateRecordsHistogramData(r,i={}){const s=this,n=[],{parentRecord:a}=i;let o=!1;for(const l of r){const c=s.getRecordHistogramData(l,i);o=o||X.isPromise(c),c&&n.push(c)}return o?Promise.all(n).then(l=>(i.parentRecord=a,l=l.filter(c=>c),s.aggregateHistogramData(l,r,i))):s.aggregateHistogramData(n,r,i)}isGroupRecord(r){return r.isGroupHeader||this.isTreeGrouped&&r.generatedParent}getGroupChildren(r){return r.groupChildren||r.children}getRecordParent(r){const i=r.instanceMeta(this.store.id);return(i==null?void 0:i.groupParent)||this.isTreeGrouped&&r.parent}scheduleRecordParentsRefresh(r,i=!0){const s=this;let n;for(;n=s.getRecordParent(r);)i&&s.clearHistogramDataCache(n),s.scheduleRecordRefresh(n),r=n}aggregateHistogramData(r,i,s={}){const n=this,{aggregateFunctions:a}=n;s.recordsData=r,s.records=i;const o=r.map((c,d)=>n.extractHistogramDataArray(c,i[d])),l=ve.aggregate(o,n.getDataEntryForAggregating||(c=>c),n.internalAggregateDataEntry,n.internalInitAggregatedDataEntry,s);for(const{id:c,aggregate:d="sum"}of Object.values(n.series)){const u=a[d].finalize;u&&d!==!1&&u(c,l,...arguments)}return l}get widgetClass(){}},p(e,"$name","TimelineHistogramGrouping"),p(e,"configurable",{aggregateHistogramDataForGroups:!0,aggregateDataEntry:null,getDataEntryForAggregating:null,initAggregatedDataEntry:null,aggregateFunctions:{sum:{aliases:["add"],entry(r,i,s){return i[r]=(i[r]||0)+s[r],i}},min:{entry(r,i,s){const n=s[r];return n<(i[r]||Number.MAX_VALUE)&&(i[r]=n),i}},max:{entry(r,i,s){const n=s[r];return n>(i[r]||Number.MIN_VALUE)&&(i[r]=n),i}},count:{init(r,i,s,n){i[r]=n.arrays.length}},avg:{entry(r,i,s){return i[r]=(i[r]||0)+s[r],i},finalize(r,i,s,n,a){const o=a.arrays.length;i.forEach(l=>l[r]/=o)}}}}),e},Me=R=>{var e;return e=class extends R{updateScalePoints(r){const i=this,s=r[r.length-1];s&&(i.scaleUnit=s.unit,i.histogramWidget.topValue=i.getTopValueByScalePoints(r)),i.scaleColumn&&(i.scaleColumn.scalePoints=r)}changeColumns(r,i){const s=this,n=s.getConfig("scaleColumn");if(r&&n){var a;const o=Array.isArray(r);let l=r;o||(l=r.data);let c=(a=l)===null||a===void 0?void 0:a.length,d=n;l.some((u,h)=>{if(u.type==="scale")return c=h,d=z.assign(u,d),!0}),l=l.slice(),l[c]={type:"scale",...d},o?r=l:r.data=l}return super.changeColumns(r,i)}updateColumns(r,i){super.updateColumns(r,i),r&&(this._scaleColumn=this.columns.find(s=>s.isScaleColumn))}onColumnsChanged({action:r,changes:i,record:s,records:n}){const{scaleColumn:a,columns:o}=this;a&&(r==="dataset"||r==="batch")&&!o.includes(a)&&o.add(a,!0),super.onColumnsChanged(...arguments)}convertUnitsToHistogramValue(r,i){return r}convertHistogramValueToUnits(r,i){return r}extractHistogramDataArray(r,i){return r}getTopValueByScalePoints(r){const i=this,{scaleColumn:s}=i,n=r[r.length-1],{value:a,unit:o}=n;let l=a;return s&&(l*=1+(s.scaleWidget.scaleMaxPadding||0)),i.convertUnitsToHistogramValue(l,o||i.scaleUnit)}processRecordRenderData(r){if(r=super.processRecordRenderData(...arguments),this.scaleColumn){var i;const s=this,{record:n,histogramData:a,histogramConfig:o={}}=r;let l=(i=s.initialConfig.histogramWidget)===null||i===void 0?void 0:i.topValue,c=s.scalePoints||n.get(s.scalePointsModelField);if(!l){if(c&&s.calculateTopValueByScalePoints&&(l=s.getTopValueByScalePoints(c)),!l&&a){const d=r.histogramWidget||s.histogramWidget;z.assign(d,o),l=d.getDataTopValue(a),c=[{value:s.convertHistogramValueToUnits(l,s.scaleUnit),text:s.convertHistogramValueToUnits(l,s.scaleUnit)}],l+=s.scaleColumn.scaleWidget.scaleMaxPadding*l}r.scaleWidgetConfig={scalePoints:c},r.histogramConfig={...o,topValue:l}}}return r}buildGroupHeader(r){return r.column===this.scaleColumn?this.scaleColumn.renderer(r):super.buildGroupHeader(...arguments)}beforeRenderCell(r){return this.scaleColumn&&r.column===this.scaleColumn&&(r.histogramData=this.getRecordHistogramData(r.record),z.isPromise(r.histogramData)||Object.assign(r,this._recordRenderData)),super.beforeRenderCell(...arguments)}renderRecordScale(r,i){if(this.scaleColumn){const s=this.getRowFor(r),n=s==null?void 0:s.getCell(this.scaleColumn.id);n&&s.renderCell(n)}}get widgetClass(){}},p(e,"$name","TimelineHistogramScaleColumn"),p(e,"configurable",{scaleColumn:{},scalePoints:null,scalePointsModelField:"scalePoints",calculateTopValueByScalePoints:!0}),e};class se extends W.mixin(Fe,Me){}p(se,"$name","TimelineHistogram"),p(se,"type","timelinehistogram"),se.initClass(),se._$name="TimelineHistogram";export{He as DelayedRecordsRendering,Re as DependencyEdit,V as EventCopyPaste,le as EventDrag,q as EventDragCreate,ce as EventTooltip,oe as ResourceTimeRangesBase,Y as ScaleColumn,Z as ScheduleContext,N as StickyEvents,de as TimeRanges,se as TimelineHistogram,W as TimelineHistogramBase,Fe as TimelineHistogramGrouping,Me as TimelineHistogramScaleColumn};
//# sourceMappingURL=TimelineHistogram.js.map
