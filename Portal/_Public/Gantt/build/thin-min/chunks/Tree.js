/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var K=Object.defineProperty;var V=(m,e,l)=>e in m?K(m,e,{enumerable:!0,configurable:!0,writable:!0,value:l}):m[e]=l;var C=(m,e,l)=>(V(m,typeof e!="symbol"?e+"":e,l),l);import{ColumnStore as M,Column as S,GridFeatureManager as P}from"./GridBase.js";import{NumberFormat as k}from"./MessageDialog.js";import{ObjectHelper as j,DomHelper as O,InstancePlugin as D,Delayable as z}from"./Editor.js";class h extends S{static get defaults(){return{filterType:"number",format:""}}get defaultEditor(){const{format:e,name:l,max:t,min:r,step:o,largeStep:n,align:s}=this;return j.cleanupProperties({type:"numberfield",format:e,name:l,max:t,min:r,step:o,largeStep:n,textAlign:s})}get formatter(){const e=this,{format:l}=e;let t=e._formatter;return(!t||e._lastFormat!==l)&&(e._formatter=t=k.get(e._lastFormat=l)),t}formatValue(e){return e!=null&&(e=this.formatter.format(e),this.unit&&(e=`${e}${this.unit}`)),e!=null?e:""}defaultRenderer({value:e}){return this.formatValue(e)}}C(h,"type","number"),C(h,"fieldType","number"),C(h,"fields",["format","min","max","step","largeStep","unit"]),M.registerColumnType(h,!0),h.exposeProperties(),h._$name="NumberColumn";let G=!1;class y extends S{static get defaults(){return{tree:!0,hideable:!1,minWidth:150}}static get fields(){return[{name:"expandIconCls",defaultValue:"b-icon b-icon-tree-expand"},{name:"collapseIconCls",defaultValue:"b-icon b-icon-tree-collapse"},{name:"collapsedFolderIconCls"},{name:"expandedFolderIconCls"},{name:"indentSize",defaultValue:1.7},{name:"leafIconCls",defaultValue:"b-icon b-icon-tree-leaf"},{name:"editTargetSelector",defaultValue:".b-tree-cell-value"},"renderer"]}constructor(e,l){super(...arguments);const t=this;t.shouldHtmlEncode=t.htmlEncode,t.setData("htmlEncode",!1),t.renderer&&(t.originalRenderer=t.renderer),t.renderer=t.treeRenderer.bind(t)}treeRenderer(e){var R;const l=this,{grid:t,cellElement:r,row:o,record:n,isExport:s}=e,d=n.instanceMeta(t.store),f=!n.isLeaf&&d.collapsed,g={className:"b-tree-cell-value"},u=[g],c={className:{"b-tree-cell-inner":1},tag:n.href?"a":"div",href:n.href,target:n.target,children:u},v={"b-tree-parent-row":0,"b-tree-collapsed":0,"b-tree-expanded":0,"b-loading-children":0};let A,w,{value:i}=e,p=l;const N=t.isTreeGrouped&&!n.isLeaf&&t.features.treeGroup.parentRenderer;if(l.originalRenderer||N){var E;let a;if(N){if(n.field){var I;p=t.columns.get(n.field),i=p.isWidgetColumn?i:(R=(I=p.renderer||p.defaultRenderer)===null||I===void 0?void 0:I.call(p,{...e,column:p,value:n.name,isTreeGroup:!0}))!=null?R:n.name}a=t.features.treeGroup.parentRenderer({field:n.field,value:i,column:p,record:n.firstGroupChild,grid:t})}else a=l.originalRenderer(e);const x=(E=t.hasFrameworkRenderer)===null||E===void 0?void 0:E.call(t,{cellContent:a,renderingColumn:p});A=typeof a=="object"&&!x,i=x?"":a===!1?r.innerHTML:a,e.rendererHtml=a}if(A||(i=String(i!=null?i:"")),s)return i;if(n.isLeaf)r.classList.add("b-tree-leaf-cell"),w=e.iconCls||n.iconCls||l.leafIconCls;else{var L;const a=!n.isExpanded(t.store),x=a?l.expandIconCls:l.collapseIconCls,F=a?l.collapsedFolderIconCls:l.expandedFolderIconCls;v["b-tree-parent-row"]=1,v["b-tree-collapsed"]=a,v["b-tree-expanded"]=!a,v["b-loading-children"]=d.isLoadingChildren,r.classList.add("b-tree-parent-cell"),u.unshift({tag:"i",className:{"b-tree-expander":1,[x]:1,"b-empty-parent":!d.isLoadingChildren&&n.children!==!0&&!((L=n.children)!==null&&L!==void 0&&L.length)}}),G=w=e.iconCls||n.iconCls||F}if(w&&u.splice(u.length-1,0,{tag:"i",className:{"b-tree-icon":1,[w]:1}}),o.isRow&&(o.assignCls(v),!n.isLeaf))if(o.setAttribute("aria-expanded",!f),f)o.removeAttribute("aria-owns");else for(const a in t.subGrids){var T,B;const x=o.elements[a];O.setAttributes(x,{"aria-owns":(T=n.children)!==null&&T!==void 0&&T.length?(B=n.children)===null||B===void 0?void 0:B.map(F=>`${t.id}-${a}-${F.id}`).join(" "):null})}Array.isArray(i)?g.children=i:A?Object.assign(g,i):p.shouldHtmlEncode||!i.includes("<")?(c.className["b-text-value"]=1,g.text=i):g.html=i;const H=n.childLevel*l.indentSize+(n.isLeaf?G?2:w?.5:.4:0);return c.style=`padding-inline-start:${H}em`,c}getCurrentConfig(e){const l=super.getCurrentConfig(e);return l.renderer=this.originalRenderer,l}}C(y,"$name","TreeColumn"),C(y,"type","tree"),M.registerColumnType(y,!0),y.exposeProperties(),y._$name="TreeColumn";const U=Promise.resolve();class b extends D.mixin(z){static get pluginConfig(){return{assign:["collapseAll","expandAll","collapse","expand","expandTo","toggleCollapse"],chain:["onElementPointerUp","onElementClick","bindStore"]}}construct(e,l){super.construct(e,l),this.treeColumn||console.info("To use the tree feature, one column should be configured with `type: 'tree'`"),e.store&&this.bindStore(e.store)}doDisable(e){if(e)throw new Error("Tree feature cannot be disabled")}get store(){return this.client.store}get treeColumn(){const e=this,{columns:l}=e.client;return(!e._treeColumn||!l.includes(e._treeColumn))&&(e._treeColumn=l.find(t=>t.isTreeColumn)),e._treeColumn}bindStore(e){this.detachListeners("store"),e.ion({name:"store",beforeLoadChildren:"onBeforeLoadChildren",loadChildren:"onLoadChildren",loadChildrenException:"onLoadChildrenException",beforeToggleNode:"onBeforeToggleNode",thisObj:this})}async toggleCollapse(e,l){if(e==null)throw new Error("Tree#toggleCollapse must be passed a record");const t=this,{store:r,client:o}=t,{rowManager:n}=o,s=r.getById(e),d=s.instanceMeta(r);if(s.generation++,await r.toggleCollapse(s,l)){const f=n.getRowFor(s);if(f&&s.ancestorsExpanded()){const g=t.treeColumn&&!t.treeColumn.subGrid.collapsed&&f.getCell(t.treeColumn.id);g&&f.renderCell(g)}t.isTogglingNode||(o.element.classList.add("b-toggling-node"),t.isTogglingNode=!0,t.requestAnimationFrame(()=>{o.element.classList.remove("b-toggling-node"),t.isTogglingNode=!1})),o.trigger(d.collapsed?"collapseNode":"expandNode",{record:s}),o.trigger("toggleNode",{record:s,collapse:d.collapsed})}}async collapse(e){return this.toggleCollapse(e,!0)}async expand(e){return this.toggleCollapse(e,!1)}onBeforeToggleNode({record:e,collapse:l}){this.client.trigger("beforeToggleNode",{record:e,collapse:l})}onBeforeLoadChildren({source:e,params:l}){const t=e.getById(l[e.modelClass.idField]),r=this.client.rowManager.getRowFor(t);r==null||r.addCls("b-loading-children")}onLoadChildren({source:e,params:l}){const t=e.getById(l[e.modelClass.idField]),r=this.client.rowManager.getRowFor(t);r==null||r.removeCls("b-loading-children")}onLoadChildrenException({record:e}){const l=this.client.rowManager.getRowFor(e);l==null||l.removeCls("b-loading-children")}async expandOrCollapseAll(e=!0,l=this.store.rootNode){const{client:t,store:r}=this,o=[],n=[];return t.trigger("beforeToggleAllNodes",{collapse:e}),r.suspendEvents(),r.traverse(s=>{const d=s.instanceMeta(r);s.isLeaf||(e&&!d.collapsed?(this.toggleCollapse(s,!0),n.push(...s.children)):!e&&d.collapsed&&(Array.isArray(s.children)&&n.push(...s.children),o.push(this.toggleCollapse(s,!1))))},l,l===r.rootNode),r.resumeEvents(),(e?U:Promise.all(o)).then(()=>{t.refreshRows(e),n.length&&(e?r.trigger("remove",{records:n,isCollapse:!0,isCollapseAll:!0}):r.trigger("add",{records:n,isExpand:!0,isExpandAll:!0})),t.trigger("toggleAllNodes",{collapse:e})})}async collapseAll(){return this.expandOrCollapseAll(!0)}async expandAll(){return this.expandOrCollapseAll(!1)}async expandTo(e,l=!0){const t=this,{store:r,client:o}=t;if(Array.isArray(e)){if(e.length>0){o.suspendRefresh();for(let u=e.length-1;u>=0;u--){var n;const c=r.getById(e[u]);if(u===0){var s;(s=o.resumeRefresh)===null||s===void 0||s.call(o),o.rowManager.refresh()}await((n=t.expandTo)===null||n===void 0?void 0:n.call(t,c,u===0))}}return}const d=r.getById(e);if(d.instanceMeta(t.store).hiddenByCollapse!==!1){if(!d.ancestorsExpanded()){var f,g;const u=[];for(let c=d.parent;c&&!c.isRoot;c=c.parent)c.isExpanded(r)||u.unshift(c);o.suspendRefresh();for(const c of u)t.isDestroyed||await t.toggleCollapse(c,!1);(f=o.resumeRefresh)===null||f===void 0||f.call(o),(g=o.refreshRows)===null||g===void 0||g.call(o)}!t.isDestroyed&&l&&await o.scrollRowIntoView(d)}}onElementPointerUp(e){const l=this,t=e.target,r=l.client.getCellDataFromEvent(e);(t.closest(".b-tree-expander")||l.expandOnCellClick&&r!==null&&r!==void 0&&r.record.isParent)&&l.toggleCollapse(r.record)}onElementClick(e){e.target.closest(".b-tree-expander")&&e.preventDefault()}toggleCollapseByKey(){const{focusedCell:e}=this.client;return(e==null?void 0:e.rowIndex)>-1&&!e.isActionable?(this.toggleCollapse(e.id),!0):!1}expandIfSingleColumn(){return this.client.columns.count===1?this.expandByKey():!1}expandByKey(){const e=this,{client:l}=e,{focusedCell:t}=l,r=t==null?void 0:t.record;return r&&t!==null&&t!==void 0&&t.column.tree&&r.isParent&&r.instanceMeta(l.store).collapsed?(e.expand(r),!0):!1}collapseIfSingleColumn(){return this.client.columns.count===1?this.collapseByKey():!1}collapseByKey(){const e=this,{client:l}=e,{focusedCell:t}=l,r=t==null?void 0:t.record;if(t!=null&&t.column.tree&&r){if(r.isParent&&!r.instanceMeta(l.store).collapsed)return e.collapse(r),!0;if(r.parent&&!r.parent.isRoot)return l.deselectAll(),l.focusCell({record:r.parent,column:t.column}),!0}return!1}}C(b,"$name","Tree"),C(b,"configurable",{expandOnCellClick:!1,keyMap:{" ":"toggleCollapseByKey",ArrowRight:"expandIfSingleColumn","Shift+ArrowRight":"expandByKey",ArrowLeft:"collapseIfSingleColumn","Shift+ArrowLeft":"collapseByKey"}}),b.featureClass="b-tree",b._$name="Tree",P.registerFeature(b,!1,"Grid"),P.registerFeature(b,!0,"TreeGrid");export{h as NumberColumn,b as Tree,y as TreeColumn};
//# sourceMappingURL=Tree.js.map
