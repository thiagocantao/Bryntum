/*!
 *
 * Bryntum Gantt 5.5.0
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var g=Object.defineProperty;var c=(n,e,r)=>e in n?g(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var u=(n,e,r)=>(c(n,typeof e!="symbol"?e+"":e,r),r);import{InstancePlugin as m,FunctionHelper as C,ObjectHelper as h}from"./Editor.js";import{GridFeatureManager as G}from"./GridBase.js";class o extends m{construct(e,r){if(this.treeColumn=e.columns.find(s=>s.isTreeColumn),super.construct(e,r),this._levels=this._levels||[],!e.hasFeature("tree"))throw new Error("The TreeGroup feature requires the Tree feature to be enabled")}applyPluginConfig(){return this.scheduleRefreshGroups=C.createBuffered(this.refreshGroups,this.refreshGroupsTimeout,this),super.applyPluginConfig(...arguments)}processParentData(e){const r=this;r.parentCls&&(e.cls=r.parentCls)}processTransformedData(e){}async waitForReadiness(){const e=this;if(e.originalStore.isLoading&&(await e.originalStore.await("load",!1),e.isDestroyed))return;const{crudManager:r}=this.client;if(r){var s;if((r.isLoadingOrSyncing||r._autoLoadPromise)&&await r.await("requestDone"),e.isDestroyed)return;await((s=e.client.project)===null||s===void 0?void 0:s.commitAsync())}}async applyLevels(e){const r=this,{client:s,treeColumn:t}=r;let{store:i}=s,a=null,d;const{modelClass:f}=i;if(t!=null&&t.field&&f.getFieldDefinition(t.field)&&(d=f.getFieldDataSource(t.field)),e=e||[],!(e.length===0&&this.isConfiguring)){if(r._levels=e,r.isApplying++,s.suspendRefresh(),!r.originalStore){var p;r.originalStore=i,i=new i.constructor({reapplyFilterOnAdd:!0,reapplyFilterOnUpdate:!0,tree:!0,modelClass:i.modelClass,load:(p=i.load)===null||p===void 0?void 0:p.bind(i),commit:i.commit.bind(i),filter:i.filter.bind(i),clearFilters:i.clearFilters.bind(i)}),s.store=i,r.originalStore.ion({name:"originalStore",refresh:r.onOriginalStoreRefresh,add:r.onOriginalStoreChanged,remove:r.onOriginalStoreChanged,removeAll:r.onOriginalStoreChanged,thisObj:r})}await r.waitForReadiness(),!r.isDestroyed&&(e.length>0?(i.data=r.originalStore.getAllDataRecords(!1).flatMap(l=>l.isLeaf?l.link():[]),a=i.treeify(e,l=>{d&&h.setPath(l,d,l.key),r.processParentData(l)}),r.processTransformedData(a),await r.trigger("beforeDataLoad",{store:i,data:a.children}),i.data=a.children):(s.store=r.originalStore,r.detachListeners("originalStore"),r.originalStore=null),r.isApplying--,s.resumeRefresh(),s.isPainted&&s.renderRows(!1),s.trigger("treeGroupChange",{levels:e}))}}doDisable(e){e&&this.clearGroups(),super.doDisable(e)}onOriginalStoreChanged(){this.scheduleRefreshGroups()}onOriginalStoreRefresh({action:e}){(e==="dataset"||e==="filter")&&this.scheduleRefreshGroups()}updateLevels(e,r){const s=this,{client:t}=s;s.hideGroupedColumns&&(r==null||r.forEach(i=>{i=i.fieldName||i,e.some(a=>(a.fieldName||a)===i)||t.columns.get(i).show()}),e==null||e.forEach(i=>{i=i.fieldName||i,(!r||!r.some(a=>a.fieldName===i))&&(t._suspendRenderContentsOnColumnsChanged=!0,t.columns.get(i).hide(),t._suspendRenderContentsOnColumnsChanged=!1)})),(e||!s.isConfiguring)&&(s.updatePromise=s.applyLevels(e),t.renderContents())}async group(e){h.assertArray(e,"group()"),await this.applyLevels(e)}async clearGroups(){this.isGrouped&&(this.levels=[],await this.updatePromise)}refreshGroups(){var e;return(e=this.applyLevels)===null||e===void 0?void 0:e.call(this,this._levels)}get isGrouped(){return this._levels.length>0}populateHeaderMenu({column:e,items:r}){const s=this,t=e.groupable!==!1&&!e.isTreeColumn;let i=!1;t&&!s.isGroupedByField(e.field)&&(r.groupAsc={text:"L{group}",localeClass:s,icon:"b-fw-icon b-icon-group-asc",separator:!0,weight:400,disabled:s.disabled,onItem:()=>s.addGrouper(e)},i=!0),s.isGrouped&&(s.isGroupedByField(e.field)&&(r.groupRemove={text:"L{stopGroupingThisColumn}",localeClass:s,icon:"b-fw-icon b-icon-clear",separator:!i,weight:420,disabled:s.disabled,onItem:()=>s.removeGrouper(e)},i=!0),r.groupRemoveAll={text:"L{stopGrouping}",localeClass:s,icon:"b-fw-icon b-icon-clear",separator:!i,weight:420,disabled:s.disabled,onItem:()=>s.clearGroups()})}addGrouper(e){this.levels=this.levels.concat(e.field)}isGroupedByField(e){return this.levels.find(r=>r.fieldName===e)}removeGrouper(e){this.levels.splice(this.levels.findIndex(r=>r.fieldName===e.field),1),this.levels=this.levels.slice()}}u(o,"$name","TreeGroup"),u(o,"configurable",{levels:[],parentCls:"b-generated-parent",parentRenderer:null,hideGroupedColumns:null,refreshGroupsTimeout:100}),u(o,"pluginConfig",{chain:["populateHeaderMenu"],assign:["group","clearGroups","refreshGroups"]}),u(o,"properties",{isApplying:0,originalStore:null}),o._$name="TreeGroup",G.registerFeature(o);export{o as TreeGroup};
//# sourceMappingURL=TreeGroup.js.map
